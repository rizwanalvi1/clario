"use strict";(self.webpackChunkclario_frontend=self.webpackChunkclario_frontend||[]).push([[9791],{96932:(O,R,i)=>{i.d(R,{b:()=>j});var S=i(57964),f=i(14007),w=i(4703),u=i(99657),y=i(35935),A=i(32196),B=i(39237),x=i(83018),o=i(17091),T=i(22784);class V{constructor(t,e,s){this._texture=null,this._lastTexture=null,this._fbos={},this.texelSize=4;const{buffer:a,pixelType:l,textureOnly:c}=t,g=(0,A.UK)(l);this.blockIndex=s,this.pixelType=l,this.size=e,this.textureOnly=c,c||(this.data=new g(a)),this._resetRange()}destroy(){this._texture?.dispose();for(const t in this._fbos){const e=this._fbos[t];e&&("0"===t&&e.detachColorTexture(),e.dispose()),this._fbos[t]=null}this._texture=null}get _textureDesc(){const t=new T.X;return t.wrapMode=B.e8.CLAMP_TO_EDGE,t.samplingMode=B.cw.NEAREST,t.dataType=this.pixelType,t.width=this.size,t.height=this.size,t}setData(t,e,s){const a=(0,y.jL)(t),l=this.data,c=a*this.texelSize+e;!l||c>=l.length||(l[c]=s,this.dirtyStart=Math.min(this.dirtyStart,a),this.dirtyEnd=Math.max(this.dirtyEnd,a))}getData(t,e){if(null==this.data)return null;const s=(0,y.jL)(t)*this.texelSize+e;return!this.data||s>=this.data.length?null:this.data[s]}getTexture(t){return this._texture??this._initTexture(t)}getFBO(t,e=0){if(!this._fbos[e]){const s=0===e?this.getTexture(t):this._textureDesc;this._fbos[e]=new x.X(t,s)}return this._fbos[e]}get hasDirty(){return this.dirtyEnd>=this.dirtyStart}updateTexture(t,e){try{const s=this.dirtyStart,a=this.dirtyEnd;if(!this.hasDirty)return;(0,f.Z)("esri-2d-update-debug")&&console.debug(`Version[${e}] AttributeStoreView.updateTexture`,{start:s,end:a,firstBytes:new Uint8Array(this.data.buffer.slice(0,16)),block:this}),this._resetRange();const l=this.data.buffer,c=this.getTexture(t),g=4,_=(s-s%this.size)/this.size,E=_,n=(a-a%this.size)/this.size,d=_*this.size*g,p=(this.size+n*this.size)*g-d,U=(0,A.UK)(this.pixelType),v=new U(l,d*U.BYTES_PER_ELEMENT,p),b=this.size,h=n-E+1;if(h>this.size)return void w.Z.getLogger("esri.views.2d.engine.webgl.AttributeStoreView").error(new S.Z("mapview-webgl","Out-of-bounds index when updating AttributeData"));c.updateData(0,0,E,b,h,v)}catch{}}update(t){const{data:e,start:s,end:a}=t;if(null!=e&&null!=this.data){const l=this.data,c=s*this.texelSize;for(let g=0;g<e.length;g++)t.layout&1<<g%this.texelSize&&(l[c+g]=e[g])}this.dirtyStart=Math.min(this.dirtyStart,s),this.dirtyEnd=Math.max(this.dirtyEnd,a)}resize(t,e){const s=this.size;if(this.size=e,this.textureOnly)return void(s!==this.size&&(this._lastTexture=this._texture,this._texture=null));const a=(0,A.UK)(this.pixelType);this.destroy(),this.data=new a(t.buffer)}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}_initTexture(t){const e=new o.x(t,this._textureDesc,this.data??void 0);if(null!=this._lastTexture&&this._fbos[0]){const s=this._lastTexture.descriptor.width,a=this._lastTexture.descriptor.height,l=this._lastTexture.descriptor.dataType,c=this._lastTexture.descriptor.pixelFormat,g=this.getFBO(t),_=(0,A.Yw)(l),z=new((0,A.UK)(l))(new ArrayBuffer(s*a*_*this.texelSize)),E=t.getBoundFramebufferObject(),{x:r,y:n,width:d,height:p}=t.getViewport();t.bindFramebuffer(g),g.readPixels(0,0,s,a,c,l,z),e.updateData(0,0,0,2*s,a/2,z),t.setViewport(r,n,d,p),t.bindFramebuffer(E)}return this.destroy(),this._texture=e,this._texture}}class P{constructor(){this.size=0,this._pendingAttributeUpdates=[],this._version=0,this._epoch=0,this._locked=!1}_initialize(t){if(!t)throw new Error("InternalError: initArgs must be defined");const e=t.blockDescriptors;if(this.size=t.blockSize,(0,f.Z)("esri-2d-update-debug")&&console.debug("AttributeStoreView.initialize",{message:t}),null==this._data)this._data=e.map((s,a)=>null!=s?new V(s,this.size,a):null);else for(let s=0;s<this._data.length;s++){const a=this._data[s],l=e[s];null!=l&&(null==a?this._data[s]=new V(l,this.size,s):a.resize(l,this.size))}}destroy(){for(const t of this._data??[])t?.destroy();this._defaultTexture?.dispose(),this._defaultTexture=null,this._pendingAttributeUpdates=[]}isEmpty(){return null==this._data}getBlock(t){return null==this._data?null:this._data[t]}setLabelMinZoom(t,e){this.setData(t,0,1,e)}getLabelMinZoom(t){return this.getData(t,0,1,255)}getFilterFlags(t){return this.getData(t,0,0,0)}getVVSize(t){return this.getData(t,u.wi.VV,0,0)}getData(t,e,s,a){if(!this._data)return 0;const l=this._data[e];return null==l?0:l.getData(t,s)??a}setData(t,e,s,a){this._data[e].setData(t,s,a)}lockTextureUploads(){this._locked=!0}unlockTextureUploads(){this._locked=!1,this.update()}requestUpdate(t){this._version=t.version,this._pendingAttributeUpdates.push(t),(0,f.Z)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] AttributeStoreView.requestUpdate`,{message:t})}get currentEpoch(){return this._epoch}update(){if(this._locked)return;const t=this._pendingAttributeUpdates;this._pendingAttributeUpdates=[];for(const e of t){const{blockData:s,initArgs:a,sendUpdateEpoch:l,version:c}=e;(0,f.Z)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] Epoch[${l}] AttributeStoreView.applyUpdate`),this._version=c,this._epoch=l,null!=a&&this._initialize(a);const g=this._data;for(let _=0;_<s.length;_++){const z=s[_],E=g[_];null!=E&&null!=z&&((0,f.Z)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] CpuBlock[${_}] AttributeStoreView.update`,{block:z}),E.update(z))}}}getUniforms(t){return{filterFlags:{texture:this._getTexture(t,u.wi.FilterFlags),unit:u.NY},animation:{texture:this._getTexture(t,u.wi.Animation),unit:u.zZ},gpgpu:{texture:this._getTexture(t,u.wi.GPGPU),unit:u.cz},visualVariableData:{texture:this._getTexture(t,u.wi.VV),unit:u.bm},dataDriven0:{texture:this._getTexture(t,u.wi.DD0),unit:u.j1},dataDriven1:{texture:this._getTexture(t,u.wi.DD1),unit:u.Ly},dataDriven2:{texture:this._getTexture(t,u.wi.DD2),unit:u.ce},size:this.size}}_getTexture(t,e){const s=this._data?.[e];return s?(s.updateTexture(t,this._version),s.getTexture(t)):this._getDefaultTexture(t)}_getDefaultTexture(t){if(null==this._defaultTexture){const e=new T.X;e.wrapMode=B.e8.CLAMP_TO_EDGE,e.samplingMode=B.cw.NEAREST,e.width=1,e.height=1,this._defaultTexture=new o.x(t,e,new Uint8Array(4))}return this._defaultTexture}}var C=i(75747);class j extends C.Z{constructor(t){super(t),this._statisticsByLevel=new Map,this.attributeView=new P}destroy(){this.children.forEach(t=>t.destroy()),this.removeAllChildren(),this.attributeView.destroy()}doRender(t){t.context.capabilities.enable("textureFloatLinear"),super.doRender(t)}createRenderParams(t){const e=super.createRenderParams(t);return e.attributeView=this.attributeView,e.instanceStore=this._instanceStore,e.statisticsByLevel=this._statisticsByLevel,e}}},75747:(O,R,i)=>{i.d(R,{Z:()=>B});var S=i(14007),f=i(43101),w=i(92311),u=i(46356),y=i(87546);const A=(x,o)=>x.key.level-o.key.level!=0?x.key.level-o.key.level:x.key.row-o.key.row!=0?x.key.row-o.key.row:x.key.col-o.key.col;class B extends w.Z{constructor(o){super(),this._tileInfoView=o}renderChildren(o){this.sortChildren(A),this.setStencilReference(o),super.renderChildren(o)}createRenderParams(o){const{state:T}=o,D=super.createRenderParams(o);return D.requiredLevel=this._tileInfoView.getClosestInfoForScale(T.scale).level,D.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(T.scale),D}prepareRenderPasses(o){const T=super.prepareRenderPasses(o);return T.push(o.registerRenderPass({name:"stencil",brushes:[u.Z],drawPhase:f.jx.DEBUG|f.jx.MAP|f.jx.HIGHLIGHT|f.jx.LABEL,target:()=>this.getStencilTarget()})),(0,S.Z)("esri-tiles-debug")&&T.push(o.registerRenderPass({name:"tileInfo",brushes:[y.Z],drawPhase:f.jx.DEBUG,target:()=>this.children})),T}getStencilTarget(){return this.children}setStencilReference(o){let T=1;for(const D of this.children)D.stencilRef=T++}}},3803:(O,R,i)=>{i.d(R,{G:()=>f});var S=i(95163);class f{constructor(u,y,A){this._instanceId=u,this.techniqueRef=y,this._input=A}get instanceId(){return(0,S.G)(this._instanceId)}createMeshInfo(u){return{id:(0,S.G)(this._instanceId),techniqueType:this.techniqueRef.type,inputParams:u,optionalAttributes:this._input.optionalAttributes}}getInput(){return this._input}setInput(u){this._input=u}}},95163:(O,R,i)=>{function S(w){return w}function f(w){return w}i.d(R,{G:()=>S,W:()=>f})},89791:(O,R,i)=>{i.d(R,{K:()=>z});var S=i(51172),f=i(96932),w=i(43101),u=i(3803),y=i(34317),A=i(95163);let B=0;function x(E,r){return new u.G((0,A.W)(B++),E,r)}const o={visualVariableColor:null,visualVariableOpacity:null,visualVariableSizeMinMaxValue:null,visualVariableSizeScaleStops:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableRotation:null,visualVariableSizeOutlineScaleStops:null};class T{constructor(){this.instances={fill:x(y.k2.fill,{uniforms:o,optionalAttributes:{zoomRange:!0}}),marker:x(y.k2.marker,{uniforms:o,optionalAttributes:{zoomRange:!0}}),line:x(y.k2.line,{uniforms:o,optionalAttributes:{zoomRange:!0}}),text:x(y.k2.text,{uniforms:o,optionalAttributes:{zoomRange:!0,referenceSymbol:!1,clipAngle:!1}}),complexFill:x(y.k2.complexFill,{uniforms:o,optionalAttributes:{zoomRange:!0}}),texturedLine:x(y.k2.texturedLine,{uniforms:o,optionalAttributes:{zoomRange:!0}})},this._instancesById=Object.values(this.instances).reduce((r,n)=>(r.set(n.instanceId,n),r),new Map)}getInstance(r){return this._instancesById.get(r)}}var D=i(92899),V=i(44406),P=i(93266),C=i(79144),j=i(93566),L=i(64456),t=i(32196),e=i(39853),s=i(39237),a=i(46682);const l=Math.PI/180;class g extends L.s{constructor(r){super(),this._program=null,this._vao=null,this._vertexBuffer=null,this._indexBuffer=null,this._dvsMat3=(0,V.Ue)(),this._localOrigin={x:0,y:0},this._getBounds=r}destroy(){this._vao&&(this._vao.dispose(),this._vao=null,this._vertexBuffer=null,this._indexBuffer=null),this._program=(0,S.M2)(this._program)}doRender(r){const{context:n}=r,d=this._getBounds();if(d.length<1)return;this._createShaderProgram(n),this._updateMatricesAndLocalOrigin(r),this._updateBufferData(n,d),n.setBlendingEnabled(!0),n.setDepthTestEnabled(!1),n.setStencilWriteMask(0),n.setStencilTestEnabled(!1),n.setBlendFunction(s.zi.ONE,s.zi.ONE_MINUS_SRC_ALPHA),n.setColorMask(!0,!0,!0,!0);const p=this._program;n.bindVAO(this._vao),n.useProgram(p),p.setUniformMatrix3fv("u_dvsMat3",this._dvsMat3),n.gl.lineWidth(1),n.drawElements(s.MX.LINES,8*d.length,s.g.UNSIGNED_INT,0),n.bindVAO()}_createTransforms(){return{displayViewScreenMat3:(0,V.Ue)()}}_createShaderProgram(r){this._program||(this._program=r.programCache.acquire("precision highp float;\n        uniform mat3 u_dvsMat3;\n\n        attribute vec2 a_position;\n\n        void main() {\n          mediump vec3 pos = u_dvsMat3 * vec3(a_position, 1.0);\n          gl_Position = vec4(pos.xy, 0.0, 1.0);\n        }","precision mediump float;\n      void main() {\n        gl_FragColor = vec4(0.75, 0.0, 0.0, 0.75);\n      }",_().attributes))}_updateMatricesAndLocalOrigin(r){const{state:n}=r,{displayMat3:d,size:p,resolution:U,pixelRatio:v,rotation:b,viewpoint:h}=n,M=l*b,{x:m,y:k}=h.targetGeometry,Z=(0,j.or)(m,n.spatialReference);this._localOrigin.x=Z,this._localOrigin.y=k;const G=v*p[0],F=v*p[1],W=U*G,N=U*F,I=(0,D.yR)(this._dvsMat3);(0,D.Jp)(I,I,d),(0,D.Iu)(I,I,(0,P.al)(G/2,F/2)),(0,D.bA)(I,I,(0,C.al)(p[0]/W,-F/N,1)),(0,D.U1)(I,I,-M)}_updateBufferData(r,n){const{x:d,y:p}=this._localOrigin,v=new Float32Array(8*n.length),b=new Uint32Array(8*n.length);let h=0,M=0;for(const m of n)m&&(v[2*h]=m[0]-d,v[2*h+1]=m[1]-p,v[2*h+2]=m[0]-d,v[2*h+3]=m[3]-p,v[2*h+4]=m[2]-d,v[2*h+5]=m[3]-p,v[2*h+6]=m[2]-d,v[2*h+7]=m[1]-p,b[M]=h+0,b[M+1]=h+3,b[M+2]=h+3,b[M+3]=h+2,b[M+4]=h+2,b[M+5]=h+1,b[M+6]=h+1,b[M+7]=h+0,h+=4,M+=8);if(this._vertexBuffer?this._vertexBuffer.setData(v.buffer):this._vertexBuffer=e.f.createVertex(r,s.l1.DYNAMIC_DRAW,v.buffer),this._indexBuffer?this._indexBuffer.setData(b):this._indexBuffer=e.f.createIndex(r,s.l1.DYNAMIC_DRAW,b),!this._vao){const m=_();this._vao=new a.U(r,m.attributes,m.bufferLayouts,{geometry:this._vertexBuffer},this._indexBuffer)}}}const _=()=>(0,t.cM)("bounds",{geometry:[{location:0,name:"a_position",count:2,type:s.g.FLOAT}]});class z extends f.b{constructor(r){super(r),this._instanceStore=new T,this.checkHighlight=()=>!0}destroy(){super.destroy(),this._boundsRenderer=(0,S.SC)(this._boundsRenderer)}get instanceStore(){return this._instanceStore}enableRenderingBounds(r){this._boundsRenderer=new g(r),this.requestRender()}get hasHighlight(){return this.checkHighlight()}onTileData(r,n){r.onMessage(n),this.contains(r)||this.addChild(r),this.requestRender()}_renderChildren(r,n){r.selection=n;for(const d of this.children)d.visible&&d.getDisplayList(this._instanceStore,w.gl.STRICT_ORDER)?.render(r)}}}}]);