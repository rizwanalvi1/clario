"use strict";(self.webpackChunkclario_frontend=self.webpackChunkclario_frontend||[]).push([[2527],{54786:(De,ae,g)=>{g.d(ae,{AM:()=>Y});var b=g(50484),E=g(73514),C=g(14007),k=g(34222),ie=g(4703),W=g(80543),J=g(10141),T=g(8818),B=g(99072);let Y=class extends E.Z{constructor(x){super(x),this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this.duration=(0,C.Z)("mapview-transitions-duration"),this.effects=[]}set effect(x){if(this._get("effect")!==(x=x||"")){this._set("effect",x);try{this._transitionTo(se(x))}catch(M){this._transitionTo([]),ie.Z.getLogger(this).warn("Invalid Effect",{effect:x,error:M})}}}get hasEffects(){return this.transitioning||!!this.effects.length}set scale(x){this._updateForScale(x)}get transitioning(){return null!==this._to}canTransitionTo(x){try{return this.scale>0&&pe(this._current,se(x),this.scale)}catch{return!1}}transitionStep(x,M){this._applyTimeTransition(x),this._updateForScale(M)}endTransitions(){this._applyTimeTransition(this.duration)}_transitionTo(x){this.scale>0&&pe(this._current,x,this.scale)?(this._final=x,this._to=(0,k.d9)(x),function we(x,M,Q){const U=x.length>M.length?x:M,G=x.length>M.length?M:x,oe=G[G.length-1],Z=oe?.scale??Q,re=oe?.effects??[];for(let j=G.length;j<U.length;j++)G.push({scale:Z,effects:[...re]});for(let j=0;j<U.length;j++)G[j].scale=-1===G[j].scale?Q:G[j].scale,U[j].scale=-1===U[j].scale?Q:U[j].scale,(0,B.uF)(G[j].effects,U[j].effects)}(this._current,this._to,this.scale),this._from=(0,k.d9)(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=x),this._set("effects",this._current[0]?(0,k.d9)(this._current[0].effects):[])}_applyTimeTransition(x){if(!(this._to&&this._from&&this._current&&this._final))return;this._time+=x;const M=Math.min(1,this._time/this.duration);for(let Q=0;Q<this._current.length;Q++){const U=this._current[Q],G=this._from[Q],oe=this._to[Q];U.scale=D(G.scale,oe.scale,M);for(let Z=0;Z<U.effects.length;Z++)U.effects[Z].interpolate(G.effects[Z],oe.effects[Z],M)}1===M&&(this._current=this._final,this._set("effects",this._current[0]?(0,k.d9)(this._current[0].effects):[]),this._from=this._to=this._final=null)}_updateForScale(x){if(this._set("scale",x),0===this._current.length)return;const M=this._current,Q=this._current.length-1;let U,G,oe=1;if(1===M.length||x>=M[0].scale)G=U=M[0].effects;else if(x<=M[Q].scale)G=U=M[Q].effects;else for(let Z=0;Z<Q;Z++){const re=M[Z],j=M[Z+1];if(re.scale>=x&&j.scale<=x){oe=(x-re.scale)/(j.scale-re.scale),U=re.effects,G=j.effects;break}}for(let Z=0;Z<this.effects.length;Z++)this.effects[Z].interpolate(U[Z],G[Z],oe)}};function se(x){const M=(0,T.Q)(x)||[];return function me(x){const M=x[0];return!!M&&"type"in M}(M)?[{scale:-1,effects:M}]:M}function pe(x,M,Q){return!x[0]?.effects||!M[0]?.effects||!((-1===x[0]?.scale||-1===M[0]?.scale)&&(x.length>1||M.length>1)&&Q<=0)&&(0,B.AS)(x[0].effects,M[0].effects)}function D(x,M,Q){return x+(M-x)*Q}(0,b._)([(0,W.Cb)()],Y.prototype,"_to",void 0),(0,b._)([(0,W.Cb)()],Y.prototype,"duration",void 0),(0,b._)([(0,W.Cb)({value:""})],Y.prototype,"effect",null),(0,b._)([(0,W.Cb)({readOnly:!0})],Y.prototype,"effects",void 0),(0,b._)([(0,W.Cb)({readOnly:!0})],Y.prototype,"hasEffects",null),(0,b._)([(0,W.Cb)({value:0})],Y.prototype,"scale",null),(0,b._)([(0,W.Cb)({readOnly:!0})],Y.prototype,"transitioning",null),Y=(0,b._)([(0,J.j)("esri.layers.effects.EffectView")],Y)},1865:(De,ae,g)=>{function b(k){const ie=k.layer;return"floorInfo"in ie&&ie.floorInfo?.floorField&&"floors"in k.view?C(k.view.floors,ie.floorInfo.floorField):null}function E(k,ie){return"floorInfo"in ie&&ie.floorInfo?.floorField?C(k,ie.floorInfo.floorField):null}function C(k,ie){if(!k?.length)return null;const W=k.filter(J=>""!==J).map(J=>`'${J}'`);return W.push("''"),`${ie} IN (${W.join(",")}) OR ${ie} IS NULL`}g.d(ae,{c:()=>b,f:()=>E})},86741:(De,ae,g)=>{g.d(ae,{Ao:()=>J,DV:()=>W,JQ:()=>ie,rL:()=>k});const b=9999999e31,E=2e-7,C={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34028234663852886e22,34028234663852886e22],f64:[-Number.MAX_VALUE,Number.MAX_VALUE],unknown:void 0,c64:void 0,c128:void 0};function k(T){return C[T]??[-34028234663852886e22,34028234663852886e22]}function ie(T,B){return null==T||null==B?"s32":T<0?T>=-128&&B<128?"s8":T>=-32768&&B<32768?"s16":"s32":B<256?"u8":B<65536?"u16":"u32"}function W(T){return(T?.startsWith("s")||T?.startsWith("u"))??!1}function J(T,B,H){if(T.depthCount&&T.depthCount>1)return;const{pixels:Y,statistics:se,pixelType:pe}=T,D=T.bandMasks??[],me=T.mask??new Uint8Array(Y[0].length).fill(255),x="f32"===pe||"f64"===pe,M=k(pe);let Q=!1;for(let U=0;U<Y.length;U++){const G="number"==typeof B?B:B[U];if(null==G)continue;if((se?.[U]?.minValue??M[0])>G+Number.EPSILON||(se?.[U]?.maxValue??M[1])<G-Number.EPSILON)continue;const re=D[U]||me.slice(),j=Y[U],ye=H?.customFloatTolerance;if(x&&0!==ye){let le=ye;le||(le=Math.abs(G)>=b?E*Math.abs(G):"f32"===pe?2**-23:Number.EPSILON);for(let ge=0;ge<j.length;ge++)re[ge]&&Math.abs(j[ge]-G)<le&&(j[ge]=0,re[ge]=0,me[ge]=0,Q=!0)}else for(let le=0;le<j.length;le++)re[le]&&j[le]===G&&(j[le]=0,re[le]=0,me[le]=0,Q=!0);D[U]=re}Q&&(T.bandMasks=T.bandMasks||T.pixels.length>1?D:null,T.mask=me),Q&&"updateStatistics"in T&&T.updateStatistics()}},45859:(De,ae,g)=>{g.d(ae,{FN:()=>C,QV:()=>E,ac:()=>ie});var b=g(60301);function E(W,J,T){return J.flatten(({sublayers:H})=>H).length!==W.length||!!W.some(H=>H.originIdOf("minScale")>T||H.originIdOf("maxScale")>T||H.originIdOf("renderer")>T||H.originIdOf("labelingInfo")>T||H.originIdOf("opacity")>T||H.originIdOf("labelsVisible")>T||H.originIdOf("source")>T)||!k(W,J)}function C(W,J,T){return!!W.some(B=>{const H=B.source,Y=!H||"map-layer"===H.type&&H.mapLayerId===B.id&&(null==H.gdbVersion||H.gdbVersion===T);return B.commitProperty("renderer"),B.commitProperty("labelingInfo"),B.commitProperty("opacity"),B.commitProperty("labelsVisible"),!Y||B.originIdOf("renderer")>b.s3.SERVICE||B.originIdOf("labelingInfo")>b.s3.SERVICE||B.originIdOf("opacity")>b.s3.SERVICE||B.originIdOf("labelsVisible")>b.s3.SERVICE})||!k(W,J)}function k(W,J){if(!W?.length||null==J)return!0;const T=J.slice().reverse().flatten(({sublayers:Y})=>Y&&Y.toArray().reverse()).map(Y=>Y.id).toArray();if(W.length>T.length)return!1;let B=0;const H=T.length;for(const{id:Y}of W){for(;B<H&&T[B]!==Y;)B++;if(B>=H)return!1}return!0}function ie(W){return!!W&&W.some(J=>null!=J.minScale||null!=J.layerDefinition?.minScale)}},50088:(De,ae,g)=>{function b(E,C){const k=E.featureReduction;return k&&"selection"!==k.type&&(!("maxScale"in k)||!k.maxScale||k.maxScale<C.scale)?k:null}g.d(ae,{g:()=>b})},83811:(De,ae,g)=>{g.r(ae),g.d(ae,{default:()=>ir});var b=g(50484),E=g(77675),C=g(80543),k=g(73018),J=(g(65311),g(14007),g(10141)),T=g(53021),H=(g(91531),g(73514)),Y=g(83944),se=g(4703),pe=g(37718),we=g(50088),D=g(15861),me=g(66599),x=g(26152),M=g(66476),U=(g(71950),g(57678)),G=g(84303),oe=g(79412),Z=g(55768),re=g(38955),j=g(6785),ye=g(60301),le=g(54786),ge=g(53984),ti=g(61793),ii=g(85971),vt=g(86741),ri=g(91963);g(57964),g(7610);var _t=g(58232),ai=g(5942),oi=g(65475),ci=g(52830),di=g(86336),ui=g(36232),he=g(38826),et=g(62616),Me=g(87463),hi=g(10750),St=g(82339),tt=g(48219),de=g(36999),Ct=(g(94678),g(37689));g(64023);var Pe=g(35451),wt=g(89481),pi=g(33653),Ze=g(36766);const He=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Li=new G.X({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),ke=new Pe.Z({size:6,outline:{color:[128,128,128,.5],width:.5}}),_i=new wt.Z({style:"solid"});function it(i){return"flow"===i.type}function Et(i){return"vector-field"===i.type}function Rt(i){return"raster-colormap"===i.type}function Vt(i){return"raster-stretch"===i.type}function xt(i){return"raster-shaded-relief"===i.type}function Ie(i){return"esri.renderers.SimpleRenderer"===i.declaredClass}function _e(i){return"esri.renderers.ClassBreaksRenderer"===i.declaredClass}function Oe(i){return"esri.renderers.UniqueValueRenderer"===i.declaredClass}function zt(i){return"esri.renderers.HeatmapRenderer"===i.declaredClass}function rt(i){return"esri.renderers.PointCloudClassBreaksRenderer"===i.declaredClass}function st(i){return"esri.renderers.PointCloudStretchRenderer"===i.declaredClass}function lt(i){return"esri.renderers.PointCloudUniqueValueRenderer"===i.declaredClass}function Ft(i){return"esri.renderers.DotDensityRenderer"===i.declaredClass}function $t(i){return"esri.renderers.PieChartRenderer"===i.declaredClass}function nt(i){return"esri.layers.SubtypeGroupLayer"===i.declaredClass}function at(i){return"esri.layers.MapImageLayer"===i.declaredClass}function At(i){return"esri.layers.TileLayer"===i.declaredClass}function Ee(i){return"esri.layers.ImageryLayer"===i.declaredClass}function je(i){return"esri.layers.ImageryTileLayer"===i.declaredClass}function Tt(i){return"sublayers"in i}function be(i,s){return ot.apply(this,arguments)}function ot(){return(ot=(0,D.Z)(function*(i,s){const l=yield(0,pi.ME)("esri/widgets/Legend/t9n/Legend");return"previewTemplateAriaLabel"!==i||s||(i="previewAriaLabel"),(0,Ze.n)(l[i],{label:s})})).apply(this,arguments)}const Ai=new Pe.Z({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let Re={},q=class extends H.Z{constructor(i){super(i),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this._layerDefinitionExpressionClause=null,this.children=new Y.Z,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const i=()=>this.notifyChange("ready");this.addHandles([(0,E.on)(()=>this.children,"change",s=>{const{added:l,removed:a}=s;l.forEach(c=>{const d=`activeLayerInfo-ready-watcher-${c.layer.uid}`;this.addHandles((0,E.YP)(()=>c.ready,i,E.nn),d)}),a.forEach(c=>this.removeHandles(c.layer.uid)),i()})]),this.keepCacheOnDestroy||(Re={})}destroy(){this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(Re=null),this._layerDefinitionExpressionClause=null}get effectList(){const i=this.layer;let s=null;return"effect"in i&&i.effect&&(s=new le.AM,s.effect=i.effect,s.endTransitions(),s.scale=this.scale),s}get opacity(){const i=this.layer.opacity,s=this.parent?.opacity,l=this.layer.parent,a=l&&"uid"in l?this._getParentLayerOpacity(l):null;return null!=s?s*i:null!=a?a*i:i}get ready(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view?.scale??0}get isScaleDriven(){const i=this.layer;if(null===i)return!1;if("effect"in i&&i.effect&&Array.isArray(i.effect))return!0;if("featureReduction"in i&&i.featureReduction){if("cluster"===i.featureReduction.type)return!0;if("binning"===i.featureReduction.type&&"renderer"in i.featureReduction&&i.featureReduction.renderer)return this._isRendererScaleDriven(i.featureReduction.renderer)}return"renderer"in i&&i.renderer?this._isRendererScaleDriven(i.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}buildLegendElementsForFeatureCollections(i){var s=this;return(0,D.Z)(function*(){if(s.hideLayersNotInCurrentView&&!(yield s._isLayerInCurrentView()))return s.legendElements=[],void s.notifyChange("ready");const l=Array.from(i,a=>{if((0,ii.Te)(a))return s._getRendererLegendElements(a.renderer,{title:a.title});if(a.featureSet?.features.length){const c=a.layerDefinition,d=c?.drawingInfo,y=d&&(0,ri.i)(d.renderer),u=Li.read(c.geometryType);return y?s._getRendererLegendElements(y,{title:a.name,geometryType:u}):(se.Z.getLogger(s).warn("drawingInfo not available!"),null)}return null});try{const a=[],c=yield Promise.allSettled(l);for(const d of c)if("fulfilled"===d.status)for(const y of d.value??[])a.push(y);s.legendElements=a,s.notifyChange("ready")}catch(a){se.Z.getLogger(s).warn("error while building legend for layer!",a)}})()}buildLegendElementsForRenderer(i){var s=this;return(0,D.Z)(function*(){try{const l=!s.hideLayersNotInCurrentView||(yield s._isLayerInCurrentView());s.legendElements=l?yield s._getRendererLegendElements(i):[],s.notifyChange("ready")}catch(l){se.Z.getLogger(s).warn("error while building legend for layer!",l)}})()}buildLegendElementsForFeatureReduction(i){var s=this;return(0,D.Z)(function*(){try{const l=!s.hideLayersNotInCurrentView||(yield s._isLayerInCurrentView());s.legendElements=l?yield s._getLegendElementsForFeatureReduction(i):[],s.notifyChange("ready")}catch(l){se.Z.getLogger(s).warn("error while building legend for layer!",l)}})()}buildLegendElementsForTools(){var i=this;return(0,D.Z)(function*(){const s=i.layer;if(function Ei(i){return"esri.layers.VoxelLayer"===i.declaredClass}(s))i._constructLegendElementsForVoxelLayer();else if(function Vi(i){return"esri.layers.WMTSLayer"===i.declaredClass}(s))i._constructLegendElementsForWMTSlayer();else if(function Ri(i){return"esri.layers.WMSLayer"===i.declaredClass}(s))yield i._constructLegendElementsForWMSSublayers();else if(function Ii(i){return"esri.layers.BuildingSceneLayer"===i.declaredClass}(s))yield i._constructLegendElementsForBuildingSceneLayer();else if(at(s)||At(s)||nt(s))yield i._constructLegendElementsForSublayers();else{i.removeHandles("imageryLayers-watcher");let l="default";if(Ee(s)&&(l=(s?.rasterFunction?.functionName||"default")+"_"+(s.bandIds?.length?s.bandIds.join(""):"###")),je(s))return;yield i._getLegendLayers(`${s.uid}-${l}`).then(function(){var a=(0,D.Z)(function*(c){i.legendElements=[],i.notifyChange("ready");const d=c.map(function(){var y=(0,D.Z)(function*(u){if(Ee(s)){const f=(0,E.YP)(()=>["renderingRule"in s&&s.rasterFunction,s.bandIds],()=>(0,oe.Ds)((0,D.Z)(function*(){Re.default=null,s.renderer?yield i.buildLegendElementsForRenderer(s.renderer):yield i.buildLegendElementsForTools()}))());i.addHandles(f,"imageryLayers-watcher")}const h=i._generateSymbolTableElementForLegendLayer(u);h?.infos.length&&(Ee(s)&&(h.title=s.title),i.legendElements.push(h)),i.notifyChange("ready")});return function(u){return y.apply(this,arguments)}}());yield Promise.allSettled(d)});return function(c){return a.apply(this,arguments)}}()).catch(a=>{se.Z.getLogger(i).warn("Request to server for legend has failed!",a)})}})()}_isLayerInCurrentView(){var i=this;return(0,D.Z)(function*(){const s=i.layer,l=i.layerView,a=l&&"createQuery"in l&&"queryFeatureCount"in l;if(!(a||l&&"createQuery"in s&&"queryFeatureCount"in s))return!0;yield(0,E.N1)(()=>!l.updating);const c=a?"createQuery"in l&&l.createQuery():"createQuery"in s&&s.createQuery();return!c||(c.geometry=i.view.extent,0!==(a?"queryFeatureCount"in l&&(yield l.queryFeatureCount(c)):"queryFeatureCount"in s&&(yield s.queryFeatureCount(c))))})()}_getParentLayerOpacity(i){let s=1;const l=i.parent;return l&&"uid"in l&&(s=this._getParentLayerOpacity(l)),i.opacity*s}_isGroupActive(){return this.children.some(i=>i.ready)}_isRendererScaleDriven(i){return"dot-density"===i.type||(!!He.test("valueExpression"in i?i.valueExpression:null)||!!("visualVariables"in i?i.visualVariables:null)?.some(a=>this._isScaleDrivenSizeVariable(a))||this._hasScaleDrivenSymbols(i))}_hasScaleDrivenSymbols(i){switch(i.type){case"simple":return this._isScaleDrivenSymbol(i.symbol);case"class-breaks":return this._isScaleDrivenSymbol(i.defaultSymbol)||i.classBreakInfos.some(s=>this._isScaleDrivenSymbol(s.symbol));case"unique-value":return this._isScaleDrivenSymbol(i.defaultSymbol)||!!i.uniqueValueInfos?.some(s=>this._isScaleDrivenSymbol(s.symbol))}return!1}_isScaleDrivenSymbol(i){if("cim"===i?.type){const{primitiveOverrides:s,minScale:l,maxScale:a}=i.data,c=s?.some(d=>/\$view\.scale/.test(d.valueExpressionInfo?.expression||""))??!1;return null!=l||null!=a||c}return!1}_isScaleDrivenSizeVariable(i){if(i&&"size"!==i.type)return!1;const s=i,l=s.minSize,a=s.maxSize;return!("object"!=typeof l||!l||!this._isScaleDrivenSizeVariable(l))||!("object"!=typeof a||!a||!this._isScaleDrivenSizeVariable(a))||He.test(s.valueExpression)}_isLayerScaleDriven(i){if("minScale"in i&&i.minScale>0||"maxScale"in i&&i.maxScale>0)return!0;if("sublayers"in i&&i.sublayers)return i.sublayers.some(l=>this._isLayerScaleDriven(l));const s=i.parent;if(!1===i.loaded&&s&&at(s)&&"source"in i&&i.source&&"map-layer"===i.source.type)for(const l of s.sourceJSON.layers??[])if(l.id===i.source.mapLayerId&&(l.minScale>0||l.maxScale>0))return!0;return!1}_constructLegendElementsForVoxelLayer(){var i=this;return(0,D.Z)(function*(){i.legendElements=[],i.removeHandles("voxel-style-watcher"),i.removeHandles("voxel-current-variable");const s=i.layer;i.addHandles((0,E.YP)(()=>s.currentVariableId,()=>i._constructLegendElementsForVoxelLayer()),"voxel-current-variable"),i.addHandles((0,E.YP)(()=>s.getVariableStyles(),()=>i._constructLegendElementsForVoxelLayer()),"voxel-style-watcher");const l=s.getVariableStyle(null),a=[];if(l)if(l.uniqueValues?.length){const y=[];l.uniqueValues.forEach(u=>{u.enabled&&y.push({label:u.label||`${u.value}`,value:u.value,symbol:new wt.Z({color:u.color,outline:null})})}),y.length&&a.push({type:"symbol-table",title:l.label,infos:y})}else if(l.transferFunction){const{colorStops:y,stretchRange:u}=l.transferFunction,h=y.toArray().reverse(),f=u.map((L,_)=>`${0===_?de.specialCharsLessThan:de.specialCharsGreaterThan} ${function fi(i){const l=Math.floor(Math.log10(Math.abs(i)))+1,a=l<4||l>6?4:l,d=Math.abs(i)>=1e6?"compact":"standard";return(0,Ct.uf)(i,{notation:d,minimumSignificantDigits:2,maximumSignificantDigits:a})}(L)}`).reverse(),m=h.map(L=>({color:L.color,value:null,label:null}));m[0].label=f[0],m[m.length-1].label=f[1],a.push({type:"color-ramp",title:l.label,infos:m,preview:(0,he.jT)(h.map(L=>L.color),{ariaLabel:yield be("previewColorRampAriaLabel")})})}const c=s.opacity,d=a.reduce((y,u)=>[...y,...i._getAllInfos(u)],[]).filter(y=>!!y?.symbol).map(y=>i._getSymbolPreview(y,c));yield Promise.allSettled(d),i.legendElements=a,i.notifyChange("ready")})()}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this.removeHandles("wmts-activeLayer-watcher");const i=this.layer.activeLayer;this.addHandles((0,E.YP)(()=>{const{layer:l}=this;return l&&"activeLayer"in l&&l.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");const s=i.styleId?i.styles?.find(({id:l})=>l===i.styleId)?.legendUrl:void 0;s&&(this.legendElements=[{type:"symbol-table",title:i.title,infos:[{src:s,opacity:this.opacity}]}]),this.notifyChange("ready")}_constructLegendElementsForWMSSublayers(){var i=this;return(0,D.Z)(function*(){i.legendElements=[],i.removeHandles("wms-sublayers-watcher");const s=i.layer;let l=null;(s.customParameters||s.customLayerParameters)&&(l={...s.customParameters,...s.customLayerParameters}),i.addHandles((0,E.YP)(()=>{const{layer:a}=i;return a&&"sublayers"in a&&a.sublayers},()=>i._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),i.legendElements=yield i._generateLegendElementsForWMSSublayers(s.sublayers,l),i.notifyChange("ready")})()}_generateLegendElementsForWMSSublayers(i,s){var l=this;return(0,D.Z)(function*(){const a=l.layer,c=[];l.addHandles(i.on("change",()=>l._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");const d=l.sublayerIds?.map(u=>a.findSublayerById(u))?.filter(U.pC)??[],y=d.length?d:i.toArray();for(const u of y){const h=(0,E.YP)(()=>[u.title,u.visible,u.legendEnabled],()=>l._constructLegendElementsForWMSSublayers());if(l.addHandles(h,"wms-sublayers-watcher"),!l.respectLayerVisibility||u.visible&&u.legendEnabled){const f=yield l._generateSymbolTableElementForWMSSublayer(u,s);f?.infos.length&&c.unshift(f)}}return c})()}_generateSymbolTableElementForWMSSublayer(i,s){var l=this;return(0,D.Z)(function*(){if(!i.legendUrl&&i.sublayers){const a=(yield l._generateLegendElementsForWMSSublayers(i.sublayers,s)).filter(c=>c);return{type:"symbol-table",title:i.title,infos:a}}return l._generateSymbolTableElementForLegendUrl(i,s)})()}_generateSymbolTableElementForLegendUrl(i,s){return(0,D.Z)(function*(){let l=i.legendUrl;if(!l)return;const a={type:"symbol-table",title:i.title||i.name||String(i.id??""),infos:[]};s&&(l=(0,j.fl)(l,s));let c=null;const d=i.layer?.opacity;try{c=(yield(0,M.Z)(l,{responseType:"image"})).data,c&&(c.style.opacity=d)}catch{}return a.infos.push({src:l,preview:c,opacity:d}),a})()}_getLegendLayers(i,s){const l=Re&&Re[i];return l?Promise.resolve(l):this._legendRequest(s).then(a=>{const c=a.layers;return Re[i]=c,c})}_legendRequest(i){const s=this.layer;let l={f:"json",dynamicLayers:i};if(Ee(s)){const c=s.exportImageServiceParameters.rasterFunction;if(c&&(l.renderingRule=JSON.stringify(c.functionDefinition?.toJSON()||c.toJSON())),s.bandIds&&(l.bandIds=s.bandIds.join()),s.raster||s.viewId||s.customParameters){const{raster:d,viewId:y,customParameters:u}=s;l={raster:d,viewId:y,...l,...u}}}let a=s.url.replace(/(\/)+$/,"");if("version"in s&&+s.version>=10.01){const c=a.indexOf("?");c>-1?a=a.substring(0,c)+"/legend"+a.substring(c):a+="/legend"}else{const c=a.toLowerCase().indexOf("/rest/"),d=a.substring(0,c)+a.substring(c+5,a.length);a="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+encodeURI(d)+"&returnbytes=true"}return(0,M.Z)(a,{query:l}).then(c=>c.data)}_constructLegendElementsForBuildingSceneLayer(){var i=this;return(0,D.Z)(function*(){i.legendElements=[],i.removeHandles("sublayers-watcher");const s=i.layer;i.addHandles((0,E.YP)(()=>s.sublayers,()=>i._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{i.legendElements=yield i._generateLegendElementsForBuildingSublayers(s.sublayers,i.opacity),i.notifyChange("ready")}catch(l){se.Z.getLogger(i).warn("Request to server for legend has failed!",l)}})()}_generateLegendElementsForBuildingSublayers(i,s){var l=this;return(0,D.Z)(function*(){let a=[];l.addHandles(i.on("change",()=>l._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");const c=i.toArray();for(const d of c){const y=(0,E.YP)(()=>["renderer"in d&&d.renderer,d.opacity,d.title,d.visible],()=>l._constructLegendElementsForBuildingSceneLayer());if(l.addHandles(y,"sublayers-watcher"),!l.respectLayerVisibility||d.visible){const u=null!=d?.opacity?d.opacity:null,h=null!=u?u*s:s;if("building-group"===d.type){const f={type:"symbol-table",title:d.title,infos:[]},m=yield l._generateLegendElementsForBuildingSublayers(d.sublayers,h);f.infos.push(...m),a=[f,...a]}else d.renderer&&(a=[...yield l._getRendererLegendElements(d.renderer,{title:d.title,opacity:h,sublayer:d}),...a])}}return a.filter(d=>!!d&&(!("infos"in d)||!d.infos||d.infos.length>0))})()}_constructLegendElementsForSublayers(){var i=this;return(0,D.Z)(function*(){i.legendElements=[],i.removeHandles("sublayers-watcher");const s=i.layer;if(at(s)||At(s)||nt(s)){i.addHandles((0,E.YP)(()=>s.sublayers,()=>i._constructLegendElementsForSublayers),"sublayers-watcher");try{i.legendElements=yield i._generateLegendElementsForSublayers(s.sublayers,i.opacity),i.notifyChange("ready")}catch(l){se.Z.getLogger(i).warn("Request to server for legend has failed!",l)}}})()}_generateLegendElementsForSublayers(i,s,l){var a=this;return(0,D.Z)(function*(){const c=a.layer;let d=[];a.addHandles(i.on("change",()=>a._constructLegendElementsForSublayers()),"sublayers-watcher");let y=i.toArray();!l&&a.sublayerIds&&a.sublayerIds.length&&(y=nt(c)?a.sublayerIds.map(u=>c.findSublayerForSubtypeCode(u)).filter(U.pC):a.sublayerIds.map(u=>c.findSublayerById(u)).filter(U.pC));for(const u of y){const h=(0,E.YP)(()=>[u.renderer,u.opacity,u.title,u.visible,u.legendEnabled],()=>a._constructLegendElementsForSublayers());if(a.addHandles(h,"sublayers-watcher"),!a.respectLayerVisibility||u.visible&&u.legendEnabled&&a._isSublayerInScale(u)){const f=null!=u?.opacity?u.opacity:null,m=null!=f?f*s:s,L=!Tt(u)||u.originIdOf("renderer")>ye.s3.SERVICE&&!u.sublayers;if(u.renderer&&L)yield u.load(),d=[...yield a._getRendererLegendElements(u.renderer,{title:u.title,opacity:m,sublayer:u}),...d];else if(Tt(u)){const _=yield a._generateSymbolTableElementForSublayer(u,m,l);_&&d.unshift(_)}}}return d.filter(u=>!!u&&(!("infos"in u)||!u.infos||u.infos.length>0))})()}_generateSymbolTableElementForSublayer(i,s,l){var a=this;return(0,D.Z)(function*(){if(!l){l=new Map;const d=a.layer,y=i.source;let u=null;if(y&&("map-layer"!==y.type||y.mapLayerId!==i.id||y.gdbVersion&&y.gdbVersion!==("gdbVersion"in d&&d.gdbVersion))||i.originIdOf("renderer")>ye.s3.SERVICE||i.originIdOf("labelingInfo")>ye.s3.SERVICE||i.originIdOf("labelsVisible")>ye.s3.SERVICE){const f=new ti.R({layer:a.layer});u=f.hasDynamicLayers?f.dynamicLayers:null,f.destroy()}const h=u||`${d.uid}-default`;(yield a._getLegendLayers(h,u)).forEach(f=>l.set(f.layerId,f))}const c=l.get(i.id);if((!c||c?.subLayerIds&&c.defaultVisibility)&&i.sublayers){const d=yield a._generateLegendElementsForSublayers(i.sublayers,s,l);return{type:"symbol-table",title:i.title,infos:d}}return a._generateSymbolTableElementForLegendLayer(c,i,s)})()}_generateSymbolTableElementForLegendLayer(i,s,l){if(!i?.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(i,s))return null;const a=s?.renderer;let c=s?.title||i.layerName;if(a&&(!s||s?.originIdOf("renderer")>ye.s3.SERVICE)){const u=s?.title||this._getRendererTitle(a,s);u&&(c&&"string"!=typeof u&&"title"in u&&(u.title=c),c=u)}const d={type:"symbol-table",title:c,legendType:i.legendType||null,infos:[]},y=s?this._sanitizeLegendForSublayer(i.legend.slice(),s):i.legend;return i.legendGroups&&i.legendGroups.length>0?i.legendGroups.forEach(u=>{const h={type:"symbol-table",title:u.heading,legendType:i.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(y.filter(f=>f.groupId===u.id),i.layerId,l)};h.infos?.length>0&&d.infos.push(h)}):d.infos=this._generateSymbolTableElementInfosForLegendLayer(y,i.layerId,l),d.infos.length>0?d:null}_generateSymbolTableElementInfosForLegendLayer(i,s,l){return i.map(a=>{let c=a.url;if(a.imageData&&a.imageData.length>0)c=`data:image/png;base64,${a.imageData}`;else{if(0===c.indexOf("http"))return null;c=(0,x.Dp)(`${this.layer.url}/${s}/images/${c}`)}return{label:a.label,src:c,opacity:l??this.opacity,width:a.width,height:a.height}}).filter(U.pC)}_isSublayerInScale(i){const s=i.minScale||0;return!(s>0&&s<this.scale||(i.maxScale||0)>this.scale)}_isLegendLayerInScale(i,s){const l=s||this.layer;let a=null,c=null,d=!0;return!l.minScale&&0!==l.minScale||!l.maxScale&&0!==l.maxScale?(0===i.minScale&&l.tileInfo&&(a=l.tileInfo.lods[0].scale),0===i.maxScale&&l.tileInfo&&(c=l.tileInfo.lods[l.tileInfo.lods.length-1].scale)):(a=Math.min(l.minScale,i.minScale)||l.minScale||i.minScale,c=Math.max(l.maxScale,i.maxScale)),(a>0&&a<this.scale||c>this.scale)&&(d=!1),d}_sanitizeLegendForSublayer(i,s){if("version"in this.layer&&+this.layer.version<10.1||0===i.length)return i;const l=s.renderer,a=i.some(y=>y.values);let c=0,d=null;return a&&i.some((y,u)=>(y.values||(c=u,d=y,d.label||(d.label="others")),null!=d)),l?"unique-value"===l.type?d&&(i.splice(c,1),i.push(d)):"class-breaks"===l.type&&(d&&i.splice(c,1),i.reverse(),d&&i.push(d)):d&&(i.splice(c,1),i.push(d)),i}_getRendererLegendElements(i,s={}){var l=this;return(0,D.Z)(function*(){if(!function wi(i,s){return Ie(i)||_e(i)||Oe(i)||zt(i)||Ft(i)||$t(i)?"2d"===s.type||function Lt(i){return null==i||"simple"===i.type||"unique-value"===i.type||"class-breaks"===i.type||"dictionary"===i.type||"heatmap"===i.type}(i):Vt(i)||Rt(i)||xt(i)||rt(i)||st(i)||lt(i)||Et(i)||it(i)}(i,l.view))return se.Z.getLogger(l).warn(`Renderer of type '${i.type}' not supported!`),[];if(function Si(i){return rt(i)||st(i)||lt(i)||function Ci(i){return"esri.renderers.PointCloudRGBRenderer"===i.declaredClass}(i)}(i))return l._constructPointCloudRendererLegendElements(i,s);if(Ft(i))return l._constructDotDensityRendererLegendElements(i);const a=yield l._loadRenderer(i);return $t(a)?l._constructPieChartRendererLegendElements(a):l._constructRendererLegendElements(a,s)})()}_getLegendElementsForFeatureReduction(i){var s=this;return(0,D.Z)(function*(){let l=null;return"binning"===i.type?l=i.renderer:"cluster"===i.type&&(l=s._getClusterRenderer(i)),l?s._getRendererLegendElements(l):[]})()}_getPointCloudRendererTitle(i){return(i.legendOptions?.title||i.field)??""}_constructPointCloudRendererLegendElements(i,s={}){var l=this;return(0,D.Z)(function*(){const a=s.title,c=[];let d=null,y=null;if(rt(i))d={type:"symbol-table",title:a||l._getPointCloudRendererTitle(i),infos:[]},i.colorClassBreakInfos.forEach(h=>{d.infos.unshift({label:h.label||h.minValue+" - "+h.maxValue,value:[h.minValue,h.maxValue],symbol:l._getAppliedCloneSymbol(ke,h.color)})});else if(st(i)){const h=i.stops;let f=null;if(h?.length&&(1===h.length&&(f=h[0].color),!f)){const L=h[0].value,_=h[h.length-1].value;null!=L&&null!=_&&(f=(0,Me.getColorFromPointCloudStops)(L+(_-L)/2,h))}d={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:l._getAppliedCloneSymbol(ke,f||ke.color)}]};const m=(0,Me.getRampStopsForPointCloud)(i.stops??[])??[];y={type:"color-ramp",title:a||l._getPointCloudRendererTitle(i),infos:m,preview:(0,he.jT)(m.map(L=>L.color),{ariaLabel:yield be("previewColorRampAriaLabel")})}}else lt(i)&&(d={type:"symbol-table",title:a||l._getPointCloudRendererTitle(i),infos:[]},i.colorUniqueValueInfos?.forEach(h=>{d.infos.push({label:h.label||h.values.join(", "),value:h.values.join(", "),symbol:l._getAppliedCloneSymbol(ke,h.color)})}));d?.infos.length&&c.push(d),y?.infos.length&&c.push(y);const u=c.reduce((h,f)=>[...h,...f.infos??[]],[]).filter(h=>!!h.symbol).map(h=>l._getSymbolPreview(h,l.opacity,{symbolConfig:{applyColorModulation:!!i.colorModulation}}));return yield Promise.allSettled(u),c})()}_getElementInfoForDotDensity(i,s){var l=this;return(0,D.Z)(function*(){const{color:a,label:c,valueExpressionTitle:d}=s,{backgroundColor:y,outline:u,dotSize:h}=i,f=l.effectList,m=f?.effects.map(w=>w.toJSON()),L=(0,ge.rM)(m),_=yield be("previewTemplateAriaLabel",c||d),S=h+"-"+a+"-"+y+"-"+(u&&JSON.stringify(u.toJSON()))+"-"+L,$=l._dotDensityUrlCache,R=$.has(S)?$.get(S):(0,he.k)(i,a,{ariaLabel:_});$.set(S,R);const v=(0,ui.wh)([[{shape:{type:"image",x:0,y:0,width:R.width,height:R.height,src:R.src},fill:null,stroke:null,offset:[0,0]}]],[R.width,R.height],{effectView:l.effectList,ariaLabel:_});return{opacity:1,src:R.src,preview:v,width:R.width,height:R.height}})()}_constructDotDensityRendererLegendElements(i){var s=this;return(0,D.Z)(function*(){const l=i.calculateDotValue(s.view.scale),a=i.legendOptions?.unit,c={type:"symbol-table",title:{value:l&&Math.round(l),unit:a||""},infos:[]};for(const d of i.attributes){const y=yield s._getElementInfoForDotDensity(i,d);y.label=d.label||d.valueExpressionTitle||d.field,c.infos.push(y)}return[c]})()}_constructPieChartRendererLegendElements(i){var s=this;return(0,D.Z)(function*(){const l=s.layer.opacity,a=[];let c=null;const d=i.outline;i.attributes.forEach(f=>{const m=new Pe.Z({color:f.color,outline:d});a.push({label:f.label||f.valueExpressionTitle||f.field,symbol:m})});const y=a.length?[...a]:[];if(i.othersCategory?.color&&0!==i.othersCategory?.threshold){const f=new Pe.Z({color:i.othersCategory.color,outline:d});c=i.othersCategory.label||"Other",a.push({label:c,symbol:f})}if(i.defaultColor?.a){const f=new Pe.Z({color:i.defaultColor,outline:d});a.push({label:i.defaultLabel,symbol:f})}const u=(yield s._getVisualVariableLegendElements(i,s.layer))||[];if(a.length){u.unshift({type:"symbol-table",title:null,infos:a});const f=y.filter(L=>L.label!==c).map(L=>L.symbol.color).filter(Boolean),m=(0,he.LC)(f,{holePercentage:i.holePercentage,backgroundColor:i.backgroundFillSymbol?.color,effectList:s.effectList,outline:d,ariaLabel:yield be("previewPieChartAriaLabel")});u.unshift({type:"pie-chart-ramp",title:s._getRendererTitle(i,s.layer),infos:a,preview:m})}const h=u.reduce((f,m)=>[...f,...s._getAllInfos(m)],[]).filter(f=>!!f?.symbol&&!f?.preview).map(f=>s._getSymbolPreview(f,l,{effectList:s.effectList}));return yield Promise.allSettled(h),u})()}_constructRendererLegendElements(i,s={}){var l=this;return(0,D.Z)(function*(){const{title:a,sublayer:c}=s,d=c||l.layer,y=(0,de.getReferenceSizeAuthoringInfoVisualVariable)(i);"definitionExpression"in d&&d.definitionExpression&&!l._layerDefinitionExpressionClause&&l.respectLayerDefinitionExpression&&(l._layerDefinitionExpressionClause=yield(0,re.E)(d.definitionExpression,d.fieldsIndex)),l._hasColorRamp=!1,l._hasOpacityRamp=!1,l._hasSizeRamp=!1,l._scaleDrivenSizeVariable=null;const u=(yield l._getVisualVariableLegendElements(i,d))||[],h={type:"symbol-table",title:a||l._getRendererTitle(i,d),infos:[]};let f=null,m=!1;const L=new Set;if(it(i)&&!l._hasSizeRamp){const v=yield(0,de.getSymbolForFlowRenderer)(i);h.infos.push({label:null,symbol:v})}else if(function Fi(i){return"univariate-color-size"===("authoringInfo"in i?i?.authoringInfo:null)?.type}(i)){let v=a;const w=function $i(i){const s="authoringInfo"in i?i?.authoringInfo:null;return"univariate-color-size"===s?.type&&"above-and-below"===s?.univariateTheme}(i)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",z=u.findIndex(fe=>"color-ramp"===fe.type),A=-1!==z?u.splice(z,1)[0]:null,F=u.findIndex(fe=>"size-ramp"===fe.type),K=-1!==F?u.splice(F,1)[0]:null,X=[];A&&(v=A.title,X.push(A)),K&&(v=K.title,X.push(K)),X.length>0&&u.push({type:w,title:v,infos:X})}else if(zt(i)){const v=(0,hi.h)(i);u.push({type:"heatmap-ramp",title:a||l._getRendererTitle(i,d),infos:v,preview:(0,he.jT)(v.map(w=>w.color),{effectList:l.effectList,ariaLabel:yield be("previewColorRampAriaLabel")})})}else if(Oe(i)){const v=i&&i.authoringInfo;if(v&&"relationship"===v.type){const{numClasses:w,field1:z,field2:A}=v,F=v.focus;if(w&&z&&A){const K=[z,A];let X=(0,St.N_)(F)||0;for(const ce of K){const{field:Le,normalizationField:Te,label:Je}=ce,Ke=Je||{field:l._getFieldAlias(Le,d),normField:Te&&l._getFieldAlias(Te,d)},Be=Ai.clone();Be.angle=X,h.infos.push({label:Ke,symbol:Be}),L.add(Be),X+=90}const fe=(0,St.mg)({focus:F,numClasses:w,infos:i.uniqueValueInfos??[]});u.unshift(fe)}}else if(Ee(l.layer)||je(l.layer)){const{field:w,field2:z}=i;i.uniqueValueInfos?.forEach(A=>{A.symbol&&(w&&l._checkDefinitionExpression(w,A.value)||z)&&h.infos.push({label:A.label||A.value,value:A.value,symbol:A.symbol})})}else{const{field:w,field2:z,field3:A,fieldDelimiter:F,valueExpression:K,defaultSymbol:X}=i,fe=!(!w&&!K||!z&&!A),ce=[];if(i.uniqueValueGroups?.forEach(Le=>{const Te={type:"symbol-table",title:Le.heading,infos:[]};Le.classes?.forEach(Je=>{const{symbol:Ke,values:Be}=Je;if(Ke){const Kt=[],Qt=[];for(const Qe of Be??[]){const{value:Xt,value2:qt,value3:ei}=Qe,Ue=[],Xe=[];(w||K)&&(Ue.push(Xt),Xe.push(l._getDomainName(w,Xt,d))),z&&(Ue.push(qt),Xe.push(l._getDomainName(z,qt,d))),A&&(Ue.push(ei),Xe.push(l._getDomainName(A,ei,d))),Kt.push(fe?Ue.join(F||""):Ue[0]),Qt.push(Xe.join(" - "))}const mt=Kt.join(", ");let gt=Je.label;if(!gt){const Qe=Qt.filter(Boolean);gt=Qe.length?Qe.join(", "):mt}const bt=Ke.clone();"cim"===bt.type&&y&&(0,oi.r6)(bt,{innerDotSize:8,outerRingSize:16}),(l._checkDefinitionExpression(w,mt)||z)&&Te.infos.push({label:gt,value:mt,symbol:bt})}}),Te.infos.length&&ce.push(Te)}),ce.length){const Le=ce[0];1===ce.length&&"title"in Le&&!Le.title?h.infos.push(...Le.infos??[]):(X&&(ce.push({type:"symbol-table",infos:[{label:i.defaultLabel||"others",symbol:X}]}),m=!0),h.infos.push(...ce)),a||i.legendOptions?.title||i.valueExpressionTitle||(h.title=null)}}i.defaultSymbol&&!m&&(h.infos.push({label:i.defaultLabel||"others",symbol:i.defaultSymbol}),m=!0)}else if(_e(i)){if(!y){if(f=l._isUnclassedRenderer(i),!f||!l._hasSizeRamp){const v=i.classBreakInfos.filter(({symbol:w})=>w);for(const{label:w,minValue:z,maxValue:A,symbol:F}of v)h.infos.unshift({label:w||(f?null:`${z} - ${A}`),value:[z,A],symbol:F});f&&(h.title=null),l._updateInfosForClassedSizeRenderer(i,h.infos)}i.defaultSymbol&&!f&&(h.infos.push({label:i.defaultLabel||"others",symbol:i.defaultSymbol}),m=!0)}}else if(Vt(i))if(je(l.layer)||function xi(i){return"esri.layers.WCSLayer"===i.declaredClass}(l.layer)){const v=yield l._constructTileImageryStretchRendererElements(i);!function zi(i){return"stretch-ramp"===i.type}(v)?h.infos=v:u.push(v)}else{const v=l.layer;let w,z;if(i.statistics?.length){const X=i.statistics[0];(0,de.isRasterBandStatistics)(X)?(w=X.min,z=X.max):[w,z]=X}let A=[],F=v.serviceRasterInfo;if(v.rasterFunction)try{F=yield v.generateRasterInfo(v.rasterFunction)}catch{}const K=(0,vt.rL)(F.pixelType);if(1===F.bandCount){const X=v.bandIds?.[0]||0;w=w??(F.statistics?F.statistics[X].min:K[0]),z=z??(F.statistics?F.statistics[X].max:K[1]),w||z?u.push(yield l._getStretchLegendElements(i,{min:w,max:z})):l._getServerSideLegend()}else if(v.bandIds&&1===v.bandIds.length)w=w??(F.statistics?F.statistics[v.bandIds[0]].min:K[0]),z=z??(F.statistics?F.statistics[v.bandIds[0]].max:K[1]),w||z?u.push(yield l._getStretchLegendElements(i,{min:w,max:z})):l._getServerSideLegend();else if(F.bandCount>=3){const{bandInfos:X}=F,{bandIds:fe}=v;X.length>=F.bandCount?3===fe?.length?(A=fe.map(ce=>X[ce].name),h.infos=l._createSymbolTableElementMultiBand(A)):"lerc"===v.format?(A=[0,1,2].map(ce=>X[ce].name),h.infos=l._createSymbolTableElementMultiBand(A)):l._getServerSideLegend():"lerc"===v.format?(A=["band1","band2","band3"],h.infos=l._createSymbolTableElementMultiBand(A)):l._getServerSideLegend()}else l._getServerSideLegend()}else if(Rt(i))i.colormapInfos.forEach(v=>{h.infos.push({label:v.label,value:v.value,symbol:l._getAppliedCloneSymbol(_i,v.color)})});else if(Ie(i)){let v=i.symbol;switch(s.geometryType){case"point":v="pointSymbol"in d?d.pointSymbol:null;break;case"polyline":v="lineSymbol"in d?d.lineSymbol:null;break;case"polygon":v="polygonSymbol"in d?d.polygonSymbol:null}const w=l._hasClusterSizeVariable&&l._getClusterSymbol()||!l._hasSizeRamp;i.symbol&&w&&h.infos.push({label:i.label,symbol:v})}else if(Et(i)){i.outputUnit&&(l.title="("+i.toJSON().outputUnit+")"),h.title=i.attributeField;const v=i.getClassBreakInfos();v?.length?v.forEach(w=>{h.infos.push({label:w.minValue+" - "+w.maxValue,symbol:w.symbol})}):h.infos.push({label:i.attributeField,symbol:i.getDefaultSymbol()})}else xt(i)&&u.push(yield l._getStretchLegendElements(i,{min:0,max:255}));const _=i.defaultSymbol;!_||m||Ie(i)||f&&!l._hasColorRamp&&!l._hasSizeRamp&&!l._hasOpacityRamp||u.push({type:"symbol-table",infos:[{label:i.defaultLabel||"others",symbol:_}]}),h.infos.length&&u.unshift(h);const S=null==s.opacity?l.opacity:s.opacity,$=l._isTallSymbol("visualVariables"in i?i.visualVariables:null),R=Ee(l.layer)||je(l.layer),N=u.reduce((v,w)=>[...v,...l._getAllInfos(w)],[]).filter(v=>!!v?.symbol).filter(v=>{if("cim"===v.symbol.type){const{minScale:w,maxScale:z}=v.symbol.data;if(w&&w<l.scale||z&&z>l.scale)return!1}return!0}).map(v=>l._getSymbolPreview(v,S,{isDefault:v.symbol===_,applyScaleDrivenSize:!L.has(v.symbol),symbolConfig:{isTall:$,isSquareFill:R},effectList:L.has(v.symbol)?null:l.effectList}));return i=null,yield Promise.allSettled(N),u})()}_checkDefinitionExpression(i,s){return!i||"string"!=typeof i||!this._layerDefinitionExpressionClause||this._layerDefinitionExpressionClause.testFeature({[i]:s})}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(i){const s=i?.infos;return s?s.reduce((l,a)=>l.concat(this._getAllInfos(a)),[]):[i]}_constructTileImageryStretchRendererElements(i){var s=this;return(0,D.Z)(function*(){const l=s.layer,a=l.symbolizer.rasterInfo??l.raster.rasterInfo;let c,d;const y=i?.statistics?.length?i.statistics:a?.statistics;if(y){const h=y[0];(0,de.isRasterBandStatistics)(h)?(c=h.min,d=h.max):[c,d]=h}else{const h=(0,vt.rL)(a.pixelType);c=h[0],d=h[1]}if(l.hasStandardTime()&&(c=l.getStandardTimeValue(c),d=l.getStandardTimeValue(d)),1===a.bandCount||1===l.bandIds?.length)return s._getStretchLegendElements(i,{min:c,max:d});const u=(l?.bandIds?.length?l.bandIds:Array.from(Array(Math.min(a.bandCount,3)).keys())).map(h=>a.bandInfos[h].name);return u.length<3?u.push(u[1]):u.length>3&&u.splice(3),s._createSymbolTableElementMultiBand(u)})()}_getStretchLegendElements(i,s){return(0,D.Z)(function*(){const a=(0,Me.getStretchRampStops)(i.colorRamp,s);return{type:"stretch-ramp",title:"",infos:a,preview:(0,he.jT)(a.map(c=>c.color),{ariaLabel:yield be("previewColorRampAriaLabel")})}})()}_getClusterSymbol(){const i=this.layer,s="featureReduction"in i&&i.featureReduction,l=s&&"symbol"in s&&s.renderer;return l&&!0!==l?.authoringInfo?.isAutoGenerated?null:s&&"symbol"in s?s.symbol:null}_getSizeLegendElement(i,s,l,a){var c=this;return(0,D.Z)(function*(){return{type:"size-ramp",title:c._hasClusterSizeVariable?c._getClusterTitle(s):i,infos:yield(0,tt.getRampStops)(l,s,yield(0,de.getMedianColor)(l),c.scale,c.view,a,c._hasClusterSizeVariable?c._getClusterSymbol():null)}})()}_createSymbolTableElementMultiBand(i){const s=[],l=["red","green","blue"];return i.forEach((a,c)=>{s.push({label:{colorName:l[c],bandName:a},src:de.rgbImgSource[c],opacity:this.opacity??1})}),s}_updateInfosForClassedSizeRenderer(i,s){const l=i.authoringInfo&&"class-breaks-size"===i.authoringInfo.type,a=i.classBreakInfos.some(c=>(0,et.YW)(c.symbol));if(l&&a){const c=tt.realWorldMaxSize,y=i.classBreakInfos.length,u=(c-tt.realWorldMinSize)/(y>1?y-1:y);s.forEach((h,f)=>{h.size=c-u*f})}}_isTallSymbol(i){let s=!1,l=!1;if(i)for(let a=0;a<i.length&&(!s||!l);a++){const c=i[a];"size"===c.type&&("height"===c.axis&&(s=!0),"width-and-depth"===c.axis&&(l=!0))}return s&&l}_getSymbolPreview(i,s,l){var a=this;return(0,D.Z)(function*(){let c=!l?.isDefault&&null==i.size&&a._hasSizeRamp?(0,Z.Wz)(di.b_.size):i.size;if(a._scaleDrivenSizeVariable&&l?.applyScaleDrivenSize){const{getSize:y}=yield Promise.resolve().then(g.bind(g,37157));c=y(a._scaleDrivenSizeVariable,null,{view:a.view.type,scale:a.scale,shape:"simple-marker"===i.symbol.type?i.symbol.style:null})}const d=!l?.isDefault&&a._hasSizeRamp||!(!a._scaleDrivenSizeVariable||!l?.applyScaleDrivenSize);return(0,he.l3)(i.symbol,{size:c,opacity:s,scale:!1,symbolConfig:l?.symbolConfig,effectView:l?.effectList,style:"legend",cimOptions:{allowScalingUp:d,viewParams:a.isScaleDriven?{viewingMode:"2d"===a.view?.type?"map":a.view?.viewingMode,scale:a.view?.scale}:null},ariaLabel:i.label&&"string"!=typeof i.label?null:yield be("previewTemplateAriaLabel",i.label)}).then(y=>(i.preview=y,i)).catch(()=>(i.preview=null,i))})()}_getClusterRenderer(i){this._hasClusterSizeVariable=!1;const s="renderer"in this.layer?this.layer.renderer:null,l=i.renderer?.clone()||s?.clone(),a=function yi(i,s,l){const a=i.effectiveClusterRenderer;if(!a||!("visualVariables"in a)||!a.visualVariables)return null;const c=a.visualVariables.find(m=>"size"===m.type);if(!("stops"in c)||!c.stops)return null;const d=c.stops.find(m=>m.useMinValue),y=c.stops.find(m=>m.useMaxValue);if(null==d||null==y)return null;const u=l.featuresTilingScheme.getClosestInfoForScale(l.scale).level,f=s.getDisplayStatistics(u,c.field);return f?new _t.Z({field:c.field,minSize:i.clusterMinSize,minDataValue:f.minValue,maxSize:i.clusterMaxSize,maxDataValue:f.maxValue}):null}(i,this.layerView,this.view);if(a&&null!=l&&"visualVariables"in l&&!l.visualVariables?.some(d=>"size"===d.type&&"outline"!==d.target&&!He.test(d.valueExpression))){if("clusterMinSize"in i&&"clusterMaxSize"in i){const{clusterMinSize:y,clusterMaxSize:u}=i;a.legendOptions=new ai.Z({showLegend:y!==u})}l.visualVariables=(l.visualVariables||[]).concat([a]),this._hasClusterSizeVariable=!0}return l}_loadRenderer(i){var s=this;return(0,D.Z)(function*(){const l=[],a=i.clone(),c=yield(0,de.getMedianColor)(a);if(_e(a)||Oe(a)){const d=(a.classBreakInfos||a.uniqueValueInfos).map(y=>s._fetchSymbol(y.symbol,c).then(u=>{y.symbol=u}).catch(()=>{y.symbol=null}));Array.prototype.push.apply(l,d)}return l.push(s._fetchSymbol(a.symbol||a.defaultSymbol,a.defaultSymbol?null:c).then(d=>{s._applySymbolToRenderer(a,d,Ie(a))}).catch(()=>{s._applySymbolToRenderer(a,null,Ie(a))})),yield Promise.allSettled(l),a})()}_applySymbolToRenderer(i,s,l){l?i.symbol=s:i.defaultSymbol=s}_fetchSymbol(i,s){var l=this;return(0,D.Z)(function*(){if(!i)throw new Error;if("web-style"===i.type){const a=l._webStyleSymbolCache;try{const c=yield"2d"===l.view.type?i.fetchCIMSymbol({cache:a}):i.fetchSymbol({cache:a});return l._getAppliedCloneSymbol(c,s)}catch{throw se.Z.getLogger(l).warn("Fetching web-style failed!"),new Error}}return l._getAppliedCloneSymbol(i,s)})()}_getAppliedCloneSymbol(i,s){if(!i||!s)return i;const l=i.clone(),a=s&&s.toRgba();return l.type.includes("3d")?this._applyColorTo3dSymbol(l,a):"cim"===l.type?(0,ci.ZB)(l,s):l.color&&(l.color=new me.Z(a||l.color)),l}_applyColorTo3dSymbol(i,s){s&&i.symbolLayers.forEach(l=>{l&&(l.material||(l.material={}),l.material.color=new me.Z(s))})}_getVisualVariableLegendElements(i,s){var l=this;return(0,D.Z)(function*(){if(!("visualVariables"in i)||"vector-field"===i.type)return null;const a=i.visualVariables??[],c=[],d=[],y=[],u=(0,de.getReferenceSizeAuthoringInfoVisualVariable)(i);if(2===u?.sizeStops?.length&&(_e(i)||Oe(i))){const[_,S]=u.sizeStops;d.push(new _t.Z({field:u.field??void 0,normalizationField:u.normalizationField,minSize:_.size,maxSize:S.size,minDataValue:_.value,maxDataValue:S.value}))}for(const _ of a)"color"===_.type?c.push(_):"size"===_.type?d.push(_):"opacity"===_.type&&y.push(_);const h=[...c,...d,...y];let f,m;if(0===c.length&&_e(i)&&i.classBreakInfos&&1===i.classBreakInfos.length){const _=i.classBreakInfos[0];f=_&&_.symbol}if(0===c.length&&Ie(i)&&(f=i.symbol),f)if(f.type.includes("3d")){const _=f.symbolLayers.at(0);"water"===_.type?null!=_.color&&(m=_.color):null!=_.material?.color&&(m=_.material.color)}else f.url||(m=f.color);const L=l.effectList;return(yield Promise.all(h.map(function(){var _=(0,D.Z)(function*(S){if(!S.legendOptions||!1!==S.legendOptions.showLegend){const $=it(i)?S.field:l._getRampTitle(S,s);let R=null;const N=(0,de.getDateFormatOptions)(s,S,l.view.timeZone);if("color"===S.type){const v=(yield(0,Me.getRampStops)(S,null,N))??[];R={type:"color-ramp",title:$,infos:v,preview:(0,he.jT)(v.map(w=>w.color),{effectList:L,ariaLabel:yield be("previewColorRampAriaLabel")})},l._hasColorRamp||(l._hasColorRamp=v.length>0)}else if("size"===S.type&&"outline"!==S.target)He.test(S.valueExpression)?l._hasClusterSizeVariable||(l._scaleDrivenSizeVariable=S):(R=yield l._getSizeLegendElement($,S,i,N),l._hasSizeRamp||(l._hasSizeRamp=!(null==R.infos||!R.infos.length)));else if("opacity"===S.type){const v=(yield(0,Me.getRampStops)(S,m,N))??[];R={type:"opacity-ramp",title:$,infos:v,preview:(0,he.jT)(v.map(w=>w.color),{effectList:L,ariaLabel:yield be("previewColorRampAriaLabel")})},l._hasOpacityRamp||(l._hasOpacityRamp=v.length>0)}return R?.infos?R:null}});return function(S){return _.apply(this,arguments)}}()))).filter(U.pC)})()}_getDomainName(i,s,l){if(i&&"function"!=typeof i){const a="getField"in l&&l.getField?.(i),c=a&&"getFieldDomain"in l&&l.getFieldDomain?l.getFieldDomain(a.name):null;return"coded-value"===c?.type?c.getName(s):null}return null}_getClusterTitle(i){const s=this.layer,l=i.field;if("featureReduction"in s&&s.featureReduction&&"cluster"===s.featureReduction.type){const a=s.featureReduction,c="popupTemplate"in a&&a.popupTemplate,d=c&&c.fieldInfos;if(d)for(const y of d)if(y.fieldName===l)return"cluster_count"===l?y.label||{showCount:!0}:y.label}return{showCount:!0}}_getRampTitle(i,s){let l=i.field,a=i.normalizationField,c=!1,d=!1,y=!1,u=null;l="function"==typeof l?null:l,a="function"==typeof a?null:a;const h=i.legendOptions?.title;if(null!=h)u=h;else if(i.valueExpressionTitle)u=i.valueExpressionTitle;else{if("renderer"in s&&s.renderer&&"authoringInfo"in s.renderer&&s.renderer.authoringInfo?.visualVariables){const f=s.renderer.authoringInfo.visualVariables;for(let m=0;m<f.length;m++){const L=f[m];if("color"===L.type){if("ratio"===L.style){c=!0;break}if("percent"===L.style){d=!0;break}if("percent-of-total"===L.style){y=!0;break}}}}u={field:l&&this._getFieldAlias(l,s),normField:a&&this._getFieldAlias(a,s),ratio:c,ratioPercent:d,ratioPercentTotal:y}}return u}_getRendererTitle(i,s){const l=i;if(l.legendOptions?.title)return l.legendOptions.title;if(l.valueExpressionTitle)return l.valueExpressionTitle;let a=l.field,c=null,d=null;if(_e(l)&&(c=l.normalizationField,d="percent-of-total"===l.normalizationType),a="function"==typeof a?null:a,c="function"==typeof c?null:c,Oe(l)){const{field2:u,field3:h,fieldDelimiter:f}=l;let m=a&&this._getFieldAlias(a,s);return u&&(m=`<${m}>${f}<${this._getFieldAlias(u,s)}>`,h&&(m=`${m}${f}<${this._getFieldAlias(h,s)}>`)),m}let y=null;return(a||c)&&(y={field:a&&this._getFieldAlias(a,s),normField:c&&this._getFieldAlias(c,s),normByPct:d}),y}_getFieldAlias(i,s){let c=("popupTemplate"in s?s.popupTemplate:null)?.fieldInfos?.find(m=>i===m.fieldName),d=null;"getField"in s&&s.getField?d=s.getField(i):"fieldsIndex"in s&&s.fieldsIndex&&(d=s.fieldsIndex.get(i));let y=null;const u="featureReduction"in s&&s.featureReduction;u&&(c??="popupTemplate"in u?u.popupTemplate?.fieldInfos?.find(m=>i?.toLowerCase()===m.fieldName?.toLowerCase()):void 0,"fields"in u&&u.fields&&(y=u.fields.find(m=>m.name?.toLowerCase()===i?.toLowerCase())));const h=c||d||y;let f=null;return h&&(f=c?.label||d?.alias||y?.alias||"name"in h&&h.name||"fieldName"in h&&h.fieldName||null),f}_isUnclassedRenderer(i){const s=i.visualVariables;let l=!1;return _e(i)&&i.classBreakInfos&&1===i.classBreakInfos.length&&s&&(l=i.field?s.some(a=>!(!a||i.field!==a.field||(i.normalizationField||a.normalizationField)&&i.normalizationField!==a.normalizationField)):!!s.length),l}};(0,b._)([(0,C.Cb)()],q.prototype,"children",void 0),(0,b._)([(0,C.Cb)({readOnly:!0})],q.prototype,"effectList",null),(0,b._)([(0,C.Cb)()],q.prototype,"layerView",void 0),(0,b._)([(0,C.Cb)()],q.prototype,"layer",void 0),(0,b._)([(0,C.Cb)()],q.prototype,"legendElements",void 0),(0,b._)([(0,C.Cb)({readOnly:!0})],q.prototype,"opacity",null),(0,b._)([(0,C.Cb)()],q.prototype,"parent",void 0),(0,b._)([(0,C.Cb)({readOnly:!0,dependsOn:[]})],q.prototype,"ready",null),(0,b._)([(0,C.Cb)()],q.prototype,"hideLayersNotInCurrentView",void 0),(0,b._)([(0,C.Cb)()],q.prototype,"keepCacheOnDestroy",void 0),(0,b._)([(0,C.Cb)()],q.prototype,"respectLayerDefinitionExpression",void 0),(0,b._)([(0,C.Cb)()],q.prototype,"respectLayerVisibility",void 0),(0,b._)([(0,C.Cb)({readOnly:!0})],q.prototype,"scale",null),(0,b._)([(0,C.Cb)()],q.prototype,"sublayerIds",void 0),(0,b._)([(0,C.Cb)({readOnly:!0})],q.prototype,"isScaleDriven",null),(0,b._)([(0,C.Cb)()],q.prototype,"title",void 0),(0,b._)([(0,C.Cb)({readOnly:!0,dependsOn:["ready"],value:0})],q.prototype,"version",null),(0,b._)([(0,C.Cb)()],q.prototype,"view",void 0),q=(0,b._)([(0,J.j)("esri.widgets.Legend.support.ActiveLayerInfo")],q);const Dt=q;var Ti=g(55829);const Mt=Y.Z.ofType(Dt),Di=new Set(["esri.layers.BuildingSceneLayer","esri.layers.CatalogLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.OrientedImageryLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.SubtypeGroupLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer","esri.layers.LinkChartLayer","esri.layers.catalog.CatalogFootprintLayer","esri.layers.catalog.CatalogDynamicGroupLayer","esri.layers.knowledgeGraph.KnowledgeGraphSublayer"]),Pt="view.basemapView.baseLayerViews",Ot="view.groundView.layerViews",Nt="view.basemapView.referenceLayerViews",Mi=[Pt,Ot,"view.layerViews",Nt];let ne=class extends H.Z{constructor(i){super(i),this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new Y.Z,this.activeLayerInfos=new Mt,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this.addHandles((0,E.YP)(()=>this.view,()=>this._viewHandles(),E.nn),"view"),this.addHandles((0,Ti.qe)(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this.view=null}get state(){return this.view?.ready?"ready":"disabled"}_viewHandles(){this.removeHandles("state"),this.view&&this.addHandles((0,E.YP)(()=>this.state,()=>this._stateHandles(),E.nn),"state")}_stateHandles(){this._resetAll(),"ready"===this.state&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this.removeHandles(["all-layer-views","legend-properties"]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(i){this.removeHandles(i);const s=this._activeLayerInfosByLayerViewId[i];delete this._activeLayerInfosByLayerViewId[i],s?.parent&&s.parent.children.remove(s)}_watchPropertiesAndAllLayerViews(){const{view:i}=this;if(!i)return;const{allLayerViews:s}=i;s.length&&this._refresh(),this.addHandles(s.on("change",l=>this._propertiesChangeHandle()),"all-layer-views"),this.addHandles((0,E.YP)(()=>[this.layerInfos,this.basemapLegendVisible,this.groundLegendVisible],()=>this._propertiesChangeHandle()),"legend-properties")}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(i){const s=this.view;if(i.length<2||!s)return;const l=[];i.forEach(c=>{if(!c.parent){const d=c.layer.parent,y=d&&"uid"in d&&this._layerViewByLayerId[d.uid],u=y&&this._activeLayerInfosByLayerViewId[y.uid];u&&i.includes(u)&&(l.push(c),c.parent=u,u.children.add(c),this._sortActiveLayerInfos(u.children))}}),i.removeMany(l);const a={};s.allLayerViews.forEach((c,d)=>a[c.layer.uid]=d),i.sort((c,d)=>(a[d.layer.uid]||0)-(a[c.layer.uid]||0))}_generateLayerViews(){const i=[];return Mi.filter(this._filterLayerViews,this).map(s=>(0,pe.U2)(this,s)).filter(s=>null!=s).forEach(this._collectLayerViews("layerViews",i)),i}_filterLayerViews(i){return!(!this.basemapLegendVisible&&(i===Pt||i===Nt)||!this.groundLegendVisible&&i===Ot)}_collectLayerViews(i,s){const l=a=>(a&&a.forEach(c=>{s.push(c),l(c[i])}),s);return l}_filterLayerViewsByLayerInfos(i){const s=this.layerInfos;return!s||!s.length||s.some(l=>this._hasLayerInfo(l,i))}_hasLayerInfo(i,s){const l=this._isLayerUIDMatching(i.layer,s.layer.uid);return l&&(this._layerInfosByLayerViewId[s.uid]=i),l}_isLayerUIDMatching(i,s){return i&&(i.uid===s||this._hasLayerUID(i.layers,s))}_hasLayerUID(i,s){return i&&i.some(l=>this._isLayerUIDMatching(l,s))}_isLayerViewSupported(i){return!!Di.has(i.layer.declaredClass)&&(this._layerViewByLayerId[i.layer.uid]=i,!0)}_generateActiveLayerInfo(i){this._isLayerActive(i)?this._buildActiveLayerInfo(i):(this.removeHandles(i.uid),this.addHandles((0,E.YP)(()=>[i.legendEnabled,i.layer?.legendEnabled],()=>this._layerActiveHandle(i)),i.uid))}_layerActiveHandle(i){this._isLayerActive(i)&&(this.removeHandles(i.uid),this._buildActiveLayerInfo(i))}_isLayerActive(i){return!this.respectLayerVisibility||i.legendEnabled&&i.layer?.legendEnabled}_buildActiveLayerInfo(i){const s=i.layer,l=i.uid,a=this._layerInfosByLayerViewId[l];let c=this._activeLayerInfosByLayerViewId[l];c||(c=new Dt({layer:s,layerView:i,title:void 0!==a?.title&&a.layer.uid===s.uid?a.title:s.title,view:this.view??void 0,respectLayerDefinitionExpression:this.respectLayerDefinitionExpression,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:a?.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[l]=c);const d=s.parent&&"uid"in s.parent?this._layerViewByLayerId[s.parent?.uid]:null;if(c.parent=this._activeLayerInfosByLayerViewId[d?.uid],!this.hasHandles(l)){const y=[(0,E.YP)(()=>s.title,u=>this._titleHandle(u,c)),(0,E.YP)(()=>[s.opacity,"renderer"in s&&s.renderer,"pointSymbol"in s&&s.pointSymbol,"lineSymbol"in s&&s.lineSymbol,"polygonSymbol"in s&&s.polygonSymbol],()=>this._constructLegendElements(c)),(0,E.gx)(()=>!0===this.view?.stationary,()=>this._scaleHandle(c),E.nn),(0,E.YP)(()=>i.layer?(0,we.g)(i.layer,i.view):null,()=>this._constructLegendElements(c)),(0,E.YP)(()=>i.updating,()=>{null!=i.layer&&null!=(0,we.g)(i.layer,i.view)&&this._constructLegendElements(c)}),(0,E.YP)(()=>"effect"in s&&s.effect,()=>this._constructLegendElements(c)),(0,E.gx)(()=>this.view?.timeZone,()=>this._constructLegendElements(c),E.nn)];if(this.respectLayerVisibility){const u=(0,E.YP)(()=>i.legendEnabled,f=>this._legendEnabledHandle(f,c)),h=(0,E.YP)(()=>s.legendEnabled,f=>this._legendEnabledHandle(f,c));y.push(u,h)}this.addHandles(y,l)}c.isScaleDriven||this._constructLegendElements(c),this._addActiveLayerInfo(c)}_titleHandle(i,s){s.title=i,this._constructLegendElements(s)}_legendEnabledHandle(i,s){i?this._addActiveLayerInfo(s):this._removeActiveLayerInfo(s)}_scaleHandle(i){(i.isScaleDriven||i.hideLayersNotInCurrentView)&&this._constructLegendElements(i)}_addActiveLayerInfo(i){const{layerView:s,layer:l}=i;if(this._isLayerActive(s)&&!this.activeLayerInfos.includes(i)){const a=i.parent;if(a)a.children.includes(i)||a.children.push(i),this._sortActiveLayerInfos(a.children);else{const c=this.layerInfos?.some(d=>d.layer.uid===l.uid);l.parent&&"uid"in l.parent&&!c?this._activeLayerInfosWithNoParent.add(i):(this.activeLayerInfos.add(i),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const c=[];this._activeLayerInfosWithNoParent.forEach(d=>{const y=d.layer.parent,u=y&&"uid"in y?this._layerViewByLayerId[y?.uid]:null,h=this._activeLayerInfosByLayerViewId[u?.uid];h&&(c.push(d),d.parent=h)}),c.length&&(this._activeLayerInfosWithNoParent.removeMany(c),c.forEach(d=>this._addActiveLayerInfo(d)))}}}_removeActiveLayerInfo(i){const s=i.parent;s?s.children.remove(i):this.activeLayerInfos.remove(i)}_constructLegendElements(i){const s=i.layer;"featureCollections"in s&&s.featureCollections?i.buildLegendElementsForFeatureCollections(s.featureCollections):"featureReduction"in s&&s.featureReduction&&"renderer"in s.featureReduction&&("binning"===s.featureReduction.type||"cluster"===s.featureReduction.type)&&(!this.view||s.featureReduction.maxScale<=this.view.scale)?i.buildLegendElementsForFeatureReduction(s.featureReduction):"renderer"in s&&s.renderer&&!("sublayers"in s)?i.buildLegendElementsForRenderer(s.renderer):"url"in s&&s.url&&"catalog"!==s.type?i.buildLegendElementsForTools():i.children.forEach(l=>this._constructLegendElements(l))}};(0,b._)([(0,C.Cb)({type:Mt})],ne.prototype,"activeLayerInfos",void 0),(0,b._)([(0,C.Cb)()],ne.prototype,"basemapLegendVisible",void 0),(0,b._)([(0,C.Cb)()],ne.prototype,"groundLegendVisible",void 0),(0,b._)([(0,C.Cb)()],ne.prototype,"hideLayersNotInCurrentView",void 0),(0,b._)([(0,C.Cb)()],ne.prototype,"keepCacheOnDestroy",void 0),(0,b._)([(0,C.Cb)()],ne.prototype,"respectLayerDefinitionExpression",void 0),(0,b._)([(0,C.Cb)()],ne.prototype,"respectLayerVisibility",void 0),(0,b._)([(0,C.Cb)()],ne.prototype,"layerInfos",void 0),(0,b._)([(0,C.Cb)({readOnly:!0})],ne.prototype,"state",null),(0,b._)([(0,C.Cb)()],ne.prototype,"view",void 0),ne=(0,b._)([(0,J.j)("esri.widgets.Legend.LegendViewModel")],ne);const Pi=ne;var Oi=g(96936);const P="esri-legend--card",Ve="esri-legend",I={activated:`${P}__carousel-indicator--activated`,base:P,stacked:`${Ve}--stacked`,carouselTitle:`${P}__carousel-title`,indicator:`${P}__carousel-indicator`,intervalSeparator:`${P}__interval-separator`,imageryLayerStretchedImage:`${P}__imagery-layer-image--stretched`,imageLabel:`${P}__image-label`,layerCaption:`${P}__layer-caption`,labelElement:`${P}__label-element`,layerRow:`${P}__layer-row`,labelCell:`${P}__label-cell`,message:`${P}__message`,rampLabel:`${P}__ramp-label`,section:`${P}__section`,relationshipSection:`${P}__relationship-section`,serviceCaptionText:`${P}__service-caption-text`,serviceContent:`${P}__service-content`,service:`${P}__service`,groupLayer:`${P}__group-layer`,groupLayerChild:`${P}__group-layer-child`,symbol:`${P}__symbol`,sizeRampRow:`${P}__size-ramp-row`,symbolRow:`${P}__symbol-row`,symbolCell:`${P}__symbol-cell`,indicatorContainer:`${P}__carousel-indicator-container`,intervalSeparatorsContainer:`${P}__interval-separators-container`,relationshipLabelContainer:`${P}__relationship-label-container`,labelContainer:`${P}__label-container`,serviceCaptionContainer:`${P}__service-caption-container`,symbolContainer:`${P}__symbol-container`,sizeRampContainer:`${P}__size-ramp-container`,sizeRampPreview:`${P}__size-ramp-preview`,pieChartRampPreview:`${P}__pie-chart-ramp-preview`,rampContainer:`${Ve}__ramps`,sizeRampHorizontal:`${Ve}__size-ramp--horizontal`,rampLabelsContainer:`${Ve}__ramp-labels`,layerInfo:`${Ve}__layer-cell ${Ve}__layer-cell--info`,univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card"};var Bt=g(84399),Ni=(g(33740),g(58242)),Ut=g(40846),p=g(2485);const Bi=(0,Ni.E)(),Zt=10,ct=20,We=10,dt=20,ut={univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",colorRamp:"esri-legend__color-ramp"};function Ui(i="vertical"){const s="stroke:rgb(200, 200, 200);stroke-width:1";return"vertical"===i?(0,p.u)("svg",{height:"4",width:"10"},(0,p.u)("line",{style:s,x1:"0",x2:"10",y1:"2",y2:"2"})):(0,p.u)("svg",{height:"10",width:"10"},(0,p.u)("line",{style:s,x1:"5",x2:"5",y1:"0",y2:"10"}))}function Zi(i,s="vertical"){const l=document.createElement("div");return l.style.height=`${ct}px`,l.className=ut.univariateAboveAndBelowSymbol,null!=i&&(l.style.opacity=i.toString()),Bi.append(l,Ui.bind(null,s)),l}function Ht(i,s,l="vertical",a){i.infos.forEach((c,d)=>{if(a&&2===d)c.preview=Zi(s,l);else{const y=(0,Z.F2)(c.size)+("horizontal"===l?dt:We),u=c.preview,h="div"===u?.tagName.toLowerCase(),f=h?u:document.createElement("div");f.className=ut.univariateAboveAndBelowSymbol,"horizontal"===l?f.style.width=`${y}px`:f.style.height=`${y}px`,!h&&u&&f.appendChild(u),c.preview=f}})}function Ye(i,s="classic"){const l=i.infos;return"classic"===s?((0,Z.F2)(l[0].size)+We)/2:((0,Z.F2)(l[0].size)-(0,Z.F2)(l[l.length-1].size))/2}function xe(i,s){if(!i)return null;const l=i.infos.map(c=>c.color),a=(0,he.jT)("full"===s.type?l:"above"===s.type?l.slice(0,3):l.slice(2,5),{width:s.width,height:s.height,align:s.rampAlignment,effectList:s.effectList,ariaLabel:s.ariaLabel});return a.className=ut.colorRamp,null!=s.opacity&&(a.style.opacity=s.opacity.toString()),a}function yt(i,s,l,a="vertical"){let c=0;const d=i.infos,y=Math.floor(d.length/2),h="full"===s||"below"===s?d.length-1:y;for(let f="full"===s||"above"===s?0:y;f<=h;f++)c+=l&&f===y?"horizontal"===a?Zt:ct:(0,Z.F2)(d[f].size)+("horizontal"===a?dt:We);return Math.round(c)}function ze(i,s,l,a="vertical"){const c=yt(i,s,l,a),d=i.infos,y=Math.floor(d.length/2),u="full"===s||"above"===s?0:y,h="full"===s||"below"===s?d.length-1:y,m=l?"vertical"===a?ct:Zt:0,L="vertical"===a?We*("full"===s?2:1):dt*("full"===s?2:1);return Math.round(c-((0,Z.F2)("full"===s?d[u].size+d[h].size:"above"===s?d[u].size:d[h].size)/2+m/2+L/2))}function kt(i,s,l="vertical"){const a=i.infos;let c=a.find(({type:y})=>"size-ramp"===y),d=a.find(({type:y})=>"color-ramp"===y);return c&&(c={...c},c.infos=[...c.infos],Ht(c,s,l,!0)),d&&(d={...d},d.infos=[...d.infos]),"horizontal"===l&&(c?.infos.reverse(),d?.infos.reverse()),{sizeRampElement:c,colorRampElement:d}}function jt(i,s="vertical"){const l=i.infos;let a=l.find(({type:d})=>"size-ramp"===d),c=l.find(({type:d})=>"color-ramp"===d);return a&&(a={...a},a.infos=[...a.infos],Ht(a,null,s,!1)),c&&(c={...c},c.infos=[...c.infos]),"horizontal"===s&&(a?.infos.reverse(),c?.infos.reverse()),{sizeRampElement:a,colorRampElement:c}}var Hi=g(72578);function ee(i){i.appendChild(this)}function ve(i,s,l){if(!s)return;if("number"==typeof s)return s;if("string"==typeof s)return(0,Hi.Cb)(s);if("value"in s||"unit"in s)return(0,Ze.n)(i.dotValue,s);if("colorName"in s&&"bandName"in s)return i[s.colorName]+": "+(i[s.bandName]||s.bandName);if("showCount"in s)return s.showCount?i.clusterCountTitle:void 0;let a=null;return function ki(i,s){return s}(0,l)?a=s.ratioPercentTotal?"showRatioPercentTotal":s.ratioPercent?"showRatioPercent":s.ratio?"showRatio":s.normField?"showNormField":s.field?"showField":null:Wt(0,l)&&(a=s.normField?"showNormField":s.normByPct?"showNormPct":s.field?"showField":null),a?(0,Ze.n)("showField"===a?"{field}":i[a],{field:s.field,normField:s.normField}):void 0}function Wt(i,s){return!s}function Yt(i,s){return!!(s&&"Stretched"===s&&i.version>=10.3&&"esri.layers.ImageryLayer"===i.declaredClass)}function Gt(i,s){return i.label?s[i.label]+": "+("string"==typeof i.value?i.value:(0,Ct.uf)(i.value??0,{style:"decimal",notation:i.value?.toString().toLowerCase().includes("e")?"scientific":"standard"})):""}var Ne=g(83022),ji=g(86269),Ge=g(26440);const Fe=window.devicePixelRatio;let ue=class extends T.Z{constructor(i,s){super(i,s),this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.headingLevel=3,this.layout="stack",this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.addHandles((0,E.YP)(()=>this.activeLayerInfos,i=>{this.removeAllHandles(),this._watchForSectionChanges(i)}))}render(){const{view:i}=this;this._hasIndicators="auto"===this.layout&&i&&i.container.clientWidth<=768||"stack"===this.layout;const s=this.activeLayerInfos,l=s?.toArray().map(h=>this._renderLegendForLayer(h)).filter(h=>!!h);this._hasIndicators?this._selectedSectionName&&this._sectionNames.includes(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const a=this._sectionNames.length,c=this._sectionNames.map((h,f)=>{const m=(0,Ze.n)(this.messagesCommon.pagination.pageText,{index:f+1,total:a});return(0,p.u)("div",{"aria-controls":`${h}-panel`,"aria-label":m,"aria-selected":(this._selectedSectionName===h).toString(),bind:this,class:this.classes(I.indicator,{[I.activated]:this._selectedSectionName===h}),"data-section-name":h,id:h,key:h,onclick:this._selectSection,onkeydown:this._focusSection,role:"tab",tabIndex:this._selectedSectionName===h?0:-1,title:m})}),d=this._hasIndicators&&a>1?(0,p.u)("div",{class:I.indicatorContainer,key:"carousel-navigation",role:"tablist"},c):null,y=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):l?.length?l:null;return(0,p.u)("div",{class:this.classes(I.base,{[I.stacked]:this._hasIndicators})},y||(0,p.u)("div",{class:I.message},this.messages.noLegend),d)}_selectSection(i){const s=i.target.getAttribute("data-section-name");s&&(this._selectedSectionName=s)}_focusSection(i){switch(i.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(i);break;case"Enter":case" ":this._selectSection(i)}}_switchSectionOnArrowPress(i){const s=i.key,l="ArrowLeft"===s?-1:1,a=i.target.getAttribute("data-section-name"),c=this._sectionNames.indexOf(a),d=this._sectionNames;let y=null;-1!==c&&(d[c+l]?y=document.getElementById(d[c+l]):"ArrowLeft"===s?y=document.getElementById(d[d.length-1]):"ArrowRight"===s&&(y=document.getElementById(d[0])),y?.focus())}_watchForSectionChanges(i){if(this._generateSectionNames(),i){i.forEach(l=>{const a=`activeLayerInfo-${l.layer.uid}-version-change`;this.removeHandles(a),this._watchForSectionChanges(l.children),this.addHandles((0,E.YP)(()=>l.version,()=>this._generateSectionNames()),a)});const s="activeLayerInfos-collection-change";this.removeHandles(s),this.addHandles(i.on("change",()=>this._watchForSectionChanges(i)),s)}}_generateSectionNames(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_getSectionName(i,s,l){return`${this.id}${i.uid}-type-${s.type}-${l}`}_generateSectionNamesForActiveLayerInfo(i){i.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),i.legendElements&&i.legendElements.forEach((s,l)=>{this._sectionNames.push(this._getSectionName(i.layer,s,l))})}_renderLegendForLayer(i){if(!i.ready)return null;if(i.children.length){const s=i.children.map(l=>this._renderLegendForLayer(l)).toArray();return(0,p.u)("div",{class:this.classes(I.service,I.groupLayer),key:i.layer.uid},(0,p.u)("div",{class:I.serviceCaptionContainer},i.title),s)}{const s=i.legendElements;if(s&&!s.length)return null;const l=s.some(d=>"relationship-ramp"===d.type),a=s.map((d,y)=>this._renderLegendForElement(d,i,y,l)).filter(d=>!!d);return a.length?(0,p.u)("div",{class:this.classes(I.service,{[I.groupLayerChild]:!!i.parent}),key:i.layer.uid},(0,p.u)("div",{class:I.serviceCaptionContainer},(0,p.u)("div",{class:I.serviceCaptionText},i.title)),(0,p.u)("div",{class:I.serviceContent},a)):null}}_renderLegendForElement(i,s,l,a=!1,c=!1){const u=s.layer;let h=null;if("string"==typeof i.title)h=i.title;else if(i.title){const $=i.title,R=ve(this.messages,$,"color-ramp"===i.type||"opacity-ramp"===i.type);h=$.title?`${$.title} (${R})`:R}const f=this._getSectionName(u,i,l),m=this._hasIndicators&&!c?(0,p.u)("div",null,(0,p.u)(Ne.X,{class:I.carouselTitle,level:this.headingLevel},s.title),(0,p.u)(Ne.X,{class:I.layerCaption,level:(0,Ne.M)(this.headingLevel)},h)):h?(0,p.u)(Ne.X,{class:I.layerCaption,level:this.headingLevel},h):null,L=s.effectList;let _=null;switch(i.type){case"symbol-table":{const $=i.infos.map((R,N)=>this._renderLegendForElementInfo(R,s,i.legendType,N)).filter(R=>!!R);if($.length){const R=$[0].properties.classes?.[I.symbolRow];_=(0,p.u)("div",{class:this.classes({[I.labelContainer]:!R&&!a,[I.relationshipLabelContainer]:a})},$)}break}case"color-ramp":case"opacity-ramp":case"heatmap-ramp":case"stretch-ramp":_=this._renderLegendForRamp(i,u.opacity,L);break;case"size-ramp":_=this._renderSizeRamp(i,u.opacity);break;case"pie-chart-ramp":_=this._renderPieChartRamp(i);break;case"relationship-ramp":_=(0,Bt.g)(i,this.id,{opacity:u.opacity,effectList:L,ariaLabel:this.messages.previewRelationshipRampAriaLabel});break;case"univariate-above-and-below-ramp":_=this._renderUnivariateAboveAndBelowRamp(i,u.opacity,L);break;case"univariate-color-size-ramp":_=this._renderUnivariateColorSizeRamp(i,u.opacity,L)}if(!_)return null;const S=(0,p.u)("div",{"aria-labelledby":f,class:I.section,id:`${f}-panel`,key:f,role:"tabpanel",tabIndex:0},[m,_]);return c||this._sectionMap.set(f,S),S}_renderPieChartRamp(i){return(0,p.u)("div",{afterCreate:ee,bind:i.preview,class:I.pieChartRampPreview})}_renderUnivariateAboveAndBelowRamp(i,s,l){const{sizeRampElement:a,colorRampElement:c}=kt(i,s,"horizontal");if(!a)return null;const d=yt(a,"full",!0,"horizontal"),y=ze(a,"above",!0,"horizontal"),u=ze(a,"below",!0,"horizontal"),f=this.messages?.previewColorRampAriaLabel,m=xe(c,{width:y,height:12,rampAlignment:"horizontal",opacity:s,type:"above",effectList:l,ariaLabel:f}),L=xe(c,{width:u,height:12,rampAlignment:"horizontal",opacity:s,type:"below",effectList:l,ariaLabel:f}),_=Ye(a,"card"),S=a.infos.map(A=>A.label),$=S.length-1,R=S.map((A,F)=>0===F||F===$?(0,p.u)("div",{key:F},A):null),w={marginTop:"3px",display:"flex"};(0,Ut.dZ)(this.container)?w.marginRight=`${_}px`:w.marginLeft=`${_}px`;const z={width:`${d}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return(0,p.u)("div",{class:I.layerRow,key:"size-ramp-preview",styles:{display:"flex",flexDirection:"column"}},(0,p.u)("div",{class:this.classes(I.symbolContainer,I.sizeRampHorizontal),styles:{display:"flex",flexDirection:"row"}},a.infos.map((A,F)=>(0,p.u)("div",{afterCreate:ee,bind:A.preview,class:I.symbol,key:F}))),m?(0,p.u)("div",{class:I.univariateAboveAndBelowColorRamp,key:"color-ramp-preview",styles:w},(0,p.u)("div",{afterCreate:ee,bind:m}),(0,p.u)("div",{afterCreate:ee,bind:L})):null,(0,p.u)("div",{class:I.layerInfo},(0,p.u)("div",{class:I.rampLabelsContainer,styles:z},R)))}_renderUnivariateColorSizeRamp(i,s,l){const{sizeRampElement:a,colorRampElement:c}=jt(i,"horizontal");if(!a)return null;const d=yt(a,"full",!1,"horizontal"),u=xe(c,{width:ze(a,"full",!1,"horizontal"),height:12,rampAlignment:"horizontal",opacity:s,type:"full",effectList:l,ariaLabel:this.messages?.previewColorRampAriaLabel}),h=Ye(a,"card"),f=a.infos.length-1,m=a.infos.map((R,N)=>0===N||N===f?(0,p.u)("div",{key:N},R.label):null),S={marginTop:"3px",display:"flex"};(0,Ut.dZ)(this.container)?S.marginRight=`${h}px`:S.marginLeft=`${h}px`;const $={width:`${d}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return(0,p.u)("div",{class:I.layerRow,key:"size-ramp-preview",styles:{display:"flex",flexDirection:"column"}},(0,p.u)("div",{class:this.classes(I.symbolContainer,I.sizeRampHorizontal),styles:{display:"flex",flexDirection:"row"}},a.infos.map((R,N)=>(0,p.u)("div",{afterCreate:ee,bind:R.preview,class:I.symbol,key:N}))),(0,p.u)("div",{class:I.univariateAboveAndBelowColorRamp,key:"color-ramp-preview",styles:S},(0,p.u)("div",{afterCreate:ee,bind:u})),(0,p.u)("div",{class:I.layerInfo},(0,p.u)("div",{class:I.rampLabelsContainer,styles:$},m)))}_renderLegendForElementInfo(i,s,l,a){const c=s.layer;if(i.type)return this._renderLegendForElement(i,s,a,!1,!0);const d=Yt(c,l),y=ve(this.messages,i.label,!1)??"";if(i.preview){if(!i.symbol?.type.includes("simple-fill")){if(!i.label)return(0,p.u)("div",{afterCreate:ee,bind:i.preview,key:a});const A={[I.symbolCell]:this._hasIndicators};return(0,p.u)("div",{class:this.classes(I.layerRow,{[I.symbolRow]:this._hasIndicators}),key:a},(0,p.u)("div",{afterCreate:ee,bind:i.preview,class:this.classes(A)}),(0,p.u)("div",{class:this.classes(I.imageLabel,{[I.labelCell]:this._hasIndicators})},y))}let u=255,h=255,f=255,m=0,L=255,_=255,S=255,$=0;const R=i.symbol.color?.a,N=i.symbol.outline?.color?.a;R&&(u=i.symbol.color.r,h=i.symbol.color.g,f=i.symbol.color.b,m=i.symbol.color.a*c.opacity),N&&(L=i.symbol.outline.color.r,_=i.symbol.outline.color.g,S=i.symbol.outline.color.b,$=i.symbol.outline.color.a*c.opacity);const v=i.symbol.color?.isBright??!0,w=v?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",z={background:R?`rgba(${u}, ${h}, ${f}, ${m})`:"none",color:v?"black":"white",textShadow:`-1px -1px 0 ${w},\n                                              1px -1px 0 ${w},\n                                              -1px 1px 0 ${w},\n                                              1px 1px 0 ${w}`,border:N?`1px solid rgba(${L}, ${_}, ${S}, ${$})`:"none",filter:(0,et.wJ)(s.effectList)??void 0};return(0,p.u)("div",{class:I.layerRow,key:a},(0,p.u)("div",{class:I.labelElement,styles:z},y))}if(i.src){const u=this._renderImage(i,c,d);return(0,p.u)("div",{class:I.layerRow,key:a},u,(0,p.u)("div",{class:I.imageLabel},y))}}_renderImage(i,s,l){const{label:a,src:c,opacity:d}=i,y={[I.imageryLayerStretchedImage]:l,[I.symbol]:!l},u={opacity:`${d??s.opacity}`};return(0,p.u)("img",{alt:ve(this.messages,a,!1),"aria-label":ve(this.messages,a,!1),border:0,class:this.classes(y),height:i.height,src:c,styles:u,width:i.width})}_renderSizeRampLines(i){const s=i.infos,l=s[0],a=s[s.length-1],c=l.symbol,d=this._hasIndicators,y=(0,Z.F2)(l.size+l.outlineSize)*Fe,u=(0,Z.F2)(a.size+a.outlineSize)*Fe,h=d?y:y+50*Fe,f=d?y/2+50*Fe:y,m=function Xi(i){if(i){if(i.type.includes("3d")){const s=i.symbolLayers?.length;if(!s)return;const l=i.symbolLayers.at(s-1).get("resource.primitive");return"triangle"===l||"cone"===l||"tetrahedron"===l}return"triangle"===i.style}}(c),L=function Qi(i){if(i){if(i.type.includes("3d")){const s=i.symbolLayers?.length;if(!s)return;const l=i.symbolLayers.at(s-1),a=l.resource?.primitive;return"circle"===a||"cross"===a||"kite"===a||"sphere"===a||"cube"===a||"diamond"===a}{const s=i.style;return"circle"===s||"diamond"===s||"cross"===s}}}(c),_=document.createElement("canvas");_.width=h,_.height=f,_.style.width=_.width/Fe+"px",_.style.height=_.height/Fe+"px";const S=_.getContext("2d");if(d){S.beginPath();const N=h/2-u/2,v=f;S.moveTo(0,0),S.lineTo(N,v);const A=h/2+u/2,F=f;S.moveTo(h,0),S.lineTo(A,F)}else{S.beginPath();const N=h,v=0;S.moveTo(0,f/2-u/2),S.lineTo(N,v);const A=h,F=f;S.moveTo(0,f/2+u/2),S.lineTo(A,F)}return S.strokeStyle="#ddd",S.stroke(),(0,p.u)("div",{afterCreate:ee,bind:_,styles:d?{display:"flex",marginTop:`-${m?0:L?y/2:0}px`,marginBottom:`-${m?u:L?u/2:0}px`}:{display:"flex",marginRight:`-${m?0:L?y/2:0}px`,marginLeft:`-${m?0:L?u/2:0}px`}})}_renderSizeRamp(i,s){const l=i.infos,a=l[0].label,c=l[l.length-1].label;let d=l[0].preview,y=l[l.length-1].preview;const u=this._hasIndicators,h={"flex-direction":u?"column":"row-reverse"};d&&(d=d.cloneNode(!0),d.style.display="flex"),y&&(y=y.cloneNode(!0),y.style.display="flex");const f={opacity:null!=s?`${s}`:""};return(0,p.u)("div",{class:this.classes(I.layerRow,{[I.sizeRampRow]:u})},(0,p.u)("div",{class:I.rampLabel},u?a:c),(0,p.u)("div",{class:I.sizeRampContainer,styles:h},(0,p.u)("div",{afterCreate:ee,bind:d,class:I.sizeRampPreview,styles:f}),this._renderSizeRampLines(i),(0,p.u)("div",{afterCreate:ee,bind:y,class:I.sizeRampContainer,styles:f})),(0,p.u)("div",{class:I.rampLabel},u?c:a))}_getRampStopLabel(i,s){switch(s){case"heatmap-ramp":return this.messages[i.label];case"stretch-ramp":return Gt(i,this.messages);default:return i.label}}_renderLegendForRamp(i,s,l){const a=i.infos,c=i.type,d="heatmap-ramp"===c,y=a.length-1,h=y>2&&!d?25*y:100,f=h+20,L=a.slice(0).reverse(),_=L.length-1,S=L.length%2!=0?L[L.length/2|0]:null,$=S&&(0,p.u)("div",{class:I.intervalSeparatorsContainer},(0,p.u)("div",{class:I.intervalSeparator},"|"),(0,p.u)("div",{class:I.rampLabel},this._getRampStopLabel(S,c))),R=[[{shape:{type:"path",path:"M0 12.5 L10 0 L10 25 Z"},fill:L[0].color,stroke:{width:0}},{shape:{type:"rect",x:10,y:0,width:h,height:25},fill:{type:"linear",x1:10,y1:0,x2:h+10,y2:0,colors:L.map((z,A)=>({color:z.color,offset:d&&"ratio"in z?z.ratio:A/y}))},stroke:{width:0}},{shape:{type:"path",path:`M${h+10} 0 L${f} 12.5 L${h+10} 25 Z`},fill:L[_].color,stroke:{width:0}}]],N=(0,Oi.KB)(R,f,25),v={filter:(0,et.wJ)(l)??void 0,opacity:null==s?void 0:`${s}`};return(0,p.u)("div",{class:I.layerRow,styles:{justifyContent:"center"}},(0,p.u)("div",{class:I.rampLabel},this._getRampStopLabel(L[0],c)),(0,p.u)("div",{class:I.symbolContainer},(0,p.u)("div",{styles:v},N),$),(0,p.u)("div",{class:I.rampLabel},this._getRampStopLabel(L[_],c)))}};(0,b._)([(0,C.Cb)()],ue.prototype,"activeLayerInfos",void 0),(0,b._)([(0,C.Cb)()],ue.prototype,"headingLevel",void 0),(0,b._)([(0,C.Cb)()],ue.prototype,"layout",void 0),(0,b._)([(0,C.Cb)(),(0,Ge.H)("esri/widgets/Legend/t9n/Legend")],ue.prototype,"messages",void 0),(0,b._)([(0,C.Cb)(),(0,Ge.H)("esri/t9n/common")],ue.prototype,"messagesCommon",void 0),(0,b._)([(0,C.Cb)({readOnly:!0})],ue.prototype,"type",void 0),(0,b._)([(0,C.Cb)()],ue.prototype,"view",void 0),(0,b._)([(0,ji.h)()],ue.prototype,"_selectSection",null),ue=(0,b._)([(0,J.j)("esri.widgets.Legend.styles.Card")],ue);const ht=ue,O="esri-legend",V={service:`${O}__service`,label:`${O}__service-label`,layer:`${O}__layer`,groupLayer:`${O}__group-layer`,groupLayerChild:`${O}__group-layer-child`,layerTable:`${O}__layer-table`,layerTableSizeRamp:`${O}__layer-table--size-ramp`,layerChildTable:`${O}__layer-child-table`,layerCaption:`${O}__layer-caption`,layerBody:`${O}__layer-body`,layerRow:`${O}__layer-row`,layerCell:`${O}__layer-cell`,layerInfo:`${O}__layer-cell ${O}__layer-cell--info`,imageryLayerStretchedImage:`${O}__imagery-layer-image--stretched`,imageryLayerCellStretched:`${O}__imagery-layer-cell--stretched`,imageryLayerInfoStretched:`${O}__imagery-layer-info--stretched`,symbolContainer:`${O}__layer-cell ${O}__layer-cell--symbols`,symbol:`${O}__symbol`,rampContainer:`${O}__ramps`,sizeRamp:`${O}__size-ramp`,colorRamp:`${O}__color-ramp`,opacityRamp:`${O}__opacity-ramp`,borderlessRamp:`${O}__borderless-ramp`,rampTick:`${O}__ramp-tick`,rampFirstTick:`${O}__ramp-tick-first`,rampLastTick:`${O}__ramp-tick-last`,rampLabelsContainer:`${O}__ramp-labels`,rampLabel:`${O}__ramp-label`,message:`${O}__message`,univariateAboveAndBelowLabel:"esri-univariate-above-and-below-ramp__label"};var ft=g(89219);const qi=`${O}__`,Jt={display:"flex",alignItems:"flex-start"},pt={marginLeft:"3px"},$e={display:"table-cell",verticalAlign:"middle"};let Ce=class extends T.Z{constructor(i,s){super(i,s),this.activeLayerInfos=null,this.headingLevel=3,this.messages=null,this.type="classic"}render(){const i=this.activeLayerInfos,s=i?.toArray().map(l=>this._renderLegendForLayer(l)).filter(l=>!!l);return(0,p.u)("div",null,s?.length?s:(0,p.u)("div",{class:V.message},this.messages.noLegend))}_renderLegendForLayer(i){if(!i.ready)return null;const s=!!i.children.length,l=`${qi}${i.layer.uid}-version-${i.version}`,a=i.title?(0,Ne.X)({level:this.headingLevel,class:this.classes(ft.z.heading,V.label)},i.title):null;if(s){const c=i.children.map(d=>this._renderLegendForLayer(d)).toArray();return(0,p.u)("div",{class:this.classes(V.service,V.groupLayer),key:l},a,c)}{const c=i.legendElements;if(c&&!c.length)return null;const d=c.map(u=>this._renderLegendForElement(u,i.layer,i.effectList)).filter(u=>!!u);return d.length?(0,p.u)("div",{class:this.classes(V.service,{[V.groupLayerChild]:!!i.parent}),key:l},a,(0,p.u)("div",{class:V.layer},d)):null}}_renderLegendForElement(i,s,l,a){const c="color-ramp"===i.type,d="opacity-ramp"===i.type,y="size-ramp"===i.type;let u=null;if("symbol-table"===i.type||y){const S=i.infos.map($=>this._renderLegendForElementInfo($,s,l,y,i.legendType)).filter($=>!!$);S.length&&(u=(0,p.u)("div",{class:V.layerBody},S))}else"color-ramp"===i.type||"opacity-ramp"===i.type||"heatmap-ramp"===i.type||"stretch-ramp"===i.type?u=this._renderLegendForRamp(i,s.opacity):"relationship-ramp"===i.type?u=(0,Bt.g)(i,this.id,{opacity:s.opacity,effectList:l,ariaLabel:this.messages.previewRelationshipRampAriaLabel}):"pie-chart-ramp"===i.type?u=this._renderPieChartRamp(i):"univariate-above-and-below-ramp"===i.type?u=this._renderUnivariateAboveAndBelowRamp(i,s.opacity,l):"univariate-color-size-ramp"===i.type&&(u=this._renderUnivariateColorSizeRamp(i,s.opacity,l));if(!u)return null;const h=i.title;let f=null;if("string"==typeof h)f=h;else if(h){const S=ve(this.messages,h,c||d);f=Wt(0,c||d)&&h.title?`${h.title} (${S})`:S}const m=a?V.layerChildTable:V.layerTable,L=f?(0,p.u)("div",{class:V.layerCaption},f):null;return(0,p.u)("div",{class:this.classes(m,{[V.layerTableSizeRamp]:y||!a})},L,u)}_renderPieChartRamp(i){return(0,p.u)("div",{afterCreate:ee,bind:i.preview})}_renderUnivariateAboveAndBelowRamp(i,s,l){const{sizeRampElement:a,colorRampElement:c}=kt(i,s);if(!a)return null;const d=this.messages?.previewColorRampAriaLabel,y=ze(a,"above",!0),u=ze(a,"below",!0),f=xe(c,{width:12,height:y,rampAlignment:"vertical",opacity:s,type:"above",effectList:l,ariaLabel:d}),m=xe(c,{width:12,height:u,rampAlignment:"vertical",opacity:s,type:"below",effectList:l,ariaLabel:d}),L=Ye(a),_=a.infos.map(F=>F.label),S=_.map((F,K)=>0===K?(0,p.u)("div",{class:F?f?V.univariateAboveAndBelowLabel:V.rampLabel:void 0,key:K},F):2===K?(0,p.u)("div",null):null),$=_.length-1,R=Math.floor(_.length/2),N=_.map((F,K)=>K===R||K===$?(0,p.u)("div",{class:F?f?V.univariateAboveAndBelowLabel:V.rampLabel:void 0,key:K},F):null),v={display:"table-cell",verticalAlign:"middle"},w={marginTop:`${L}px`},z={height:`${y}px`},A={height:`${u}px`};return(0,p.u)("div",{key:"univariate-above-and-below-ramp-preview",styles:Jt},(0,p.u)("div",{class:V.layerBody},a.infos.map((F,K)=>(0,p.u)("div",{class:this.classes(V.layerRow,V.sizeRamp)},(0,p.u)("div",{afterCreate:ee,bind:F.preview,class:V.symbol,styles:v}),f||K%2!=0?null:(0,p.u)("div",{class:V.layerInfo},_[K])))),f?(0,p.u)("div",{key:"color-ramp-preview",styles:w},(0,p.u)("div",{styles:pt},(0,p.u)("div",{styles:$e},(0,p.u)("div",{afterCreate:ee,bind:f,class:V.rampContainer})),(0,p.u)("div",{styles:$e},(0,p.u)("div",{class:V.rampLabelsContainer,styles:z},S))),(0,p.u)("div",{styles:pt},(0,p.u)("div",{styles:$e},(0,p.u)("div",{afterCreate:ee,bind:m,class:V.rampContainer})),(0,p.u)("div",{styles:$e},(0,p.u)("div",{class:V.rampLabelsContainer,styles:A},N)))):null)}_renderUnivariateColorSizeRamp(i,s,l){const{sizeRampElement:a,colorRampElement:c}=jt(i);if(!a)return null;const d=Ye(a),u=ze(a,"full",!1),h=xe(c,{width:12,height:u,rampAlignment:"vertical",opacity:s,type:"full",effectList:l,ariaLabel:this.messages?.previewColorRampAriaLabel}),f=a.infos.length-1,m=a.infos.map(($,R)=>0===R||R===f?(0,p.u)("div",{class:$.label?c?V.univariateAboveAndBelowLabel:V.rampLabel:void 0,key:R},$.label):null),L={display:"table-cell",verticalAlign:"middle"},_={marginTop:`${d}px`},S={height:`${u}px`};return(0,p.u)("div",{key:"univariate-above-and-below-ramp-preview",styles:Jt},(0,p.u)("div",{class:V.layerBody},a.infos.map($=>(0,p.u)("div",{class:this.classes(V.layerRow,V.sizeRamp)},(0,p.u)("div",{afterCreate:ee,bind:$.preview,class:V.symbol,styles:L})))),(0,p.u)("div",{key:"color-ramp-preview",styles:_},(0,p.u)("div",{styles:pt},(0,p.u)("div",{styles:$e},(0,p.u)("div",{afterCreate:ee,bind:h,class:V.rampContainer})),(0,p.u)("div",{styles:$e},(0,p.u)("div",{class:V.rampLabelsContainer,styles:S},m)))))}_renderLegendForRamp(i,s){const l=i.infos,c="heatmap-ramp"===i.type,d="stretch-ramp"===i.type,y=i.preview;y.className=`${V.colorRamp} ${"opacity-ramp"===i.type?V.opacityRamp:""}`,null!=s&&(y.style.opacity=s.toString());const h=l.map(L=>(0,p.u)("div",{class:L.label?V.rampLabel:void 0},c?this.messages[L.label]||L.label:d?Gt(L,this.messages):L.label)),m={height:y.style.height};return(0,p.u)("div",{class:V.layerRow},(0,p.u)("div",{class:V.symbolContainer,styles:{width:"24px"}},(0,p.u)("div",{afterCreate:ee,bind:y,class:V.rampContainer})),(0,p.u)("div",{class:V.layerInfo},(0,p.u)("div",{class:V.rampLabelsContainer,styles:m},h)))}_renderLegendForElementInfo(i,s,l,a,c){if(i.type)return this._renderLegendForElement(i,s,l,!0);let d=null;const y=Yt(s,c);if(i.preview?d=(0,p.u)("div",{afterCreate:ee,bind:i.preview,class:V.symbol}):i.src&&(d=this._renderImage(i,s,y)),!d)return null;const u={[V.imageryLayerInfoStretched]:y};return(0,p.u)("div",{class:V.layerRow},(0,p.u)("div",{class:this.classes(V.symbolContainer,{[V.imageryLayerInfoStretched]:y,[V.sizeRamp]:!y&&a})},d),(0,p.u)("div",{class:this.classes(V.layerInfo,u)},ve(this.messages,i.label,!1)||""))}_renderImage(i,s,l){const{label:a,src:c,opacity:d}=i,y={[V.imageryLayerStretchedImage]:l,[V.symbol]:!l},u={opacity:`${d??s.opacity}`};return(0,p.u)("img",{alt:ve(this.messages,a,!1),"aria-label":ve(this.messages,a,!1),border:0,class:this.classes(y),height:i.height,src:c,styles:u,width:i.width})}};(0,b._)([(0,C.Cb)()],Ce.prototype,"activeLayerInfos",void 0),(0,b._)([(0,C.Cb)()],Ce.prototype,"headingLevel",void 0),(0,b._)([(0,C.Cb)(),(0,Ge.H)("esri/widgets/Legend/t9n/Legend")],Ce.prototype,"messages",void 0),(0,b._)([(0,C.Cb)({readOnly:!0})],Ce.prototype,"type",void 0),Ce=(0,b._)([(0,J.j)("esri.widgets.Legend.styles.Classic")],Ce);const Ae=Ce;let te=class extends T.Z{constructor(i,s){super(i,s),this.headingLevel=3,this.messages=null,this.style=new Ae,this.viewModel=new Pi}initialize(){this.addHandles([(0,E.on)(()=>this.view,"resize",()=>this.scheduleRender()),(0,E.on)(()=>this.activeLayerInfos,"change",()=>this._refreshActiveLayerInfos(this.activeLayerInfos)),(0,E.YP)(()=>this.headingLevel,i=>{const{style:s}=this;s&&(s.headingLevel=i)}),(0,E.YP)(()=>this.style,(i,s)=>{s&&i!==s&&s.destroy(),i&&(i.activeLayerInfos=this.activeLayerInfos,"card"===i.type&&(i.view=this.view),i.headingLevel=this.headingLevel)},E.nn)])}get activeLayerInfos(){return this.viewModel.activeLayerInfos}set activeLayerInfos(i){this.viewModel.activeLayerInfos=i}get basemapLegendVisible(){return this.viewModel.basemapLegendVisible}set basemapLegendVisible(i){this.viewModel.basemapLegendVisible=i}get groundLegendVisible(){return this.viewModel.groundLegendVisible}set groundLegendVisible(i){this.viewModel.groundLegendVisible=i}get hideLayersNotInCurrentView(){return this.viewModel.hideLayersNotInCurrentView}set hideLayersNotInCurrentView(i){this.viewModel.hideLayersNotInCurrentView=i}get keepCacheOnDestroy(){return this.viewModel.keepCacheOnDestroy}set keepCacheOnDestroy(i){this.viewModel.keepCacheOnDestroy=i}get respectLayerDefinitionExpression(){return this.viewModel.respectLayerDefinitionExpression}set respectLayerDefinitionExpression(i){this.viewModel.respectLayerDefinitionExpression=i}get respectLayerVisibility(){return this.viewModel.respectLayerVisibility}set respectLayerVisibility(i){this.viewModel.respectLayerVisibility=i}get icon(){return"legend"}set icon(i){this._overrideIfSome("icon",i)}get label(){return this.messages?.widgetLabel??""}set label(i){this._overrideIfSome("label",i)}get layerInfos(){return this.viewModel.layerInfos}set layerInfos(i){this.viewModel.layerInfos=i}castStyle(i){if(i instanceof ht||i instanceof Ae)return i;if("string"==typeof i)return"card"===i?new ht:new Ae;if(i&&"string"==typeof i.type){const s={...i};return delete s.type,new("card"===i.type?ht:Ae)(s)}return new Ae}get view(){return this.viewModel.view}set view(i){this.viewModel.view=i}render(){return(0,p.u)("div",{class:this.classes("esri-legend",ft.z.widget,this.style instanceof Ae?ft.z.panel:null)},this.style.render())}_refreshActiveLayerInfos(i){i.forEach(s=>{this.removeHandles(`version_${s.layer.uid}`),this._renderOnActiveLayerInfoChange(s)}),this.scheduleRender()}_renderOnActiveLayerInfoChange(i){const s=(0,E.YP)(()=>i.version,()=>this.scheduleRender());this.addHandles(s,`version_${i.layer.uid}`);const l=(0,E.on)(()=>i.children,"change",()=>i.children.forEach(a=>this._renderOnActiveLayerInfoChange(a)),E.nn);this.addHandles(l,`version_${i.layer.uid}`),i.children.forEach(a=>this._renderOnActiveLayerInfoChange(a))}};(0,b._)([(0,C.Cb)()],te.prototype,"activeLayerInfos",null),(0,b._)([(0,C.Cb)()],te.prototype,"basemapLegendVisible",null),(0,b._)([(0,C.Cb)()],te.prototype,"groundLegendVisible",null),(0,b._)([(0,C.Cb)()],te.prototype,"headingLevel",void 0),(0,b._)([(0,C.Cb)()],te.prototype,"hideLayersNotInCurrentView",null),(0,b._)([(0,C.Cb)()],te.prototype,"keepCacheOnDestroy",null),(0,b._)([(0,C.Cb)()],te.prototype,"respectLayerDefinitionExpression",null),(0,b._)([(0,C.Cb)()],te.prototype,"respectLayerVisibility",null),(0,b._)([(0,C.Cb)()],te.prototype,"icon",null),(0,b._)([(0,C.Cb)()],te.prototype,"label",null),(0,b._)([(0,C.Cb)()],te.prototype,"layerInfos",null),(0,b._)([(0,C.Cb)(),(0,Ge.H)("esri/widgets/Legend/t9n/Legend")],te.prototype,"messages",void 0),(0,b._)([(0,C.Cb)()],te.prototype,"style",void 0),(0,b._)([(0,k.p)("style")],te.prototype,"castStyle",null),(0,b._)([(0,C.Cb)()],te.prototype,"view",null),(0,b._)([(0,C.Cb)()],te.prototype,"viewModel",void 0),te=(0,b._)([(0,J.j)("esri.widgets.Legend")],te);const ir=te}}]);