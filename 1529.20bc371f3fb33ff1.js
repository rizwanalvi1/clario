"use strict";(self.webpackChunkclario_frontend=self.webpackChunkclario_frontend||[]).push([[1529],{70794:(nt,Te,y)=>{y.d(Te,{EX:()=>re,Y3:()=>j,_Y:()=>L,jQ:()=>W,sJ:()=>Y,xr:()=>N});var Q=y(66599);function W(_){return"r"in _&&"g"in _&&"b"in _}function Oe(_){return"h"in _&&"s"in _&&"v"in _}function ue(_){return"l"in _&&"a"in _&&"b"in _}function Me(_){return"l"in _&&"c"in _&&"h"in _}y(5710),y(23515);const xe=[[.4124,.3576,.1805],[.2126,.7152,.0722],[.0193,.1192,.9505]],Ee=[[3.2406,-1.5372,-.4986],[-.9689,1.8758,.0415],[.0557,-.204,1.057]];function ve(_,z){const B=[];let D,U;if(_[0].length!==z.length)throw new Error("dimensions do not match");const J=_.length,Z=_[0].length;let ge=0;for(D=0;D<J;D++){for(ge=0,U=0;U<Z;U++)ge+=_[D][U]*z[U];B.push(ge)}return B}function de(_){const z=[_.r/255,_.g/255,_.b/255].map(D=>D<=.04045?D/12.92:((D+.055)/1.055)**2.4),B=ve(xe,z);return{x:100*B[0],y:100*B[1],z:100*B[2]}}function we(_){const z=ve(Ee,[_.x/100,_.y/100,_.z/100]).map(B=>Math.min(1,Math.max(B<=.0031308?12.92*B:1.055*B**.4166666666666667-.055,0)));return{r:Math.round(255*z[0]),g:Math.round(255*z[1]),b:Math.round(255*z[2])}}function pe(_){const z=[_.x/95.047,_.y/100,_.z/108.883].map(B=>B>.008856451679035631?B**.3333333333333333:7.787037037037035*B+.13793103448275862);return{l:116*z[1]-16,a:500*(z[0]-z[1]),b:200*(z[1]-z[2])}}function P(_){const z=_.l,B=[(z+16)/116+_.a/500,(z+16)/116,(z+16)/116-_.b/200].map(D=>D>6/29?D**3:3*(6/29)**2*(D-4/29));return{x:95.047*B[0],y:100*B[1],z:108.883*B[2]}}function N(_){return W(_)?_:Me(_)?function b(_){return we(P(function v(_){const B=_.c,D=_.h;return{l:_.l,a:B*Math.cos(D),b:B*Math.sin(D)}}(_)))}(_):ue(_)?function d(_){return we(P(_))}(_):function Pe(_){return"x"in _&&"y"in _&&"z"in _}(_)?we(_):Oe(_)?function k(_){const z=(_.h+360)%360/60,D=_.v/100*255,U=D*(_.s/100),J=U*(1-Math.abs(z%2-1));let Z;switch(Math.floor(z)){case 0:Z={r:U,g:J,b:0};break;case 1:Z={r:J,g:U,b:0};break;case 2:Z={r:0,g:U,b:J};break;case 3:Z={r:0,g:J,b:U};break;case 4:Z={r:J,g:0,b:U};break;case 5:case 6:Z={r:U,g:0,b:J};break;default:Z={r:0,g:0,b:0}}return Z.r=Math.round(Z.r+D-U),Z.g=Math.round(Z.g+D-U),Z.b=Math.round(Z.b+D-U),Z}(_):_}function L(_){return Oe(_)?_:function A(_){const z=_.r,B=_.g,D=_.b,U=Math.max(z,B,D),J=U-Math.min(z,B,D);let Z=U,ge=0===J?0:U===z?(B-D)/J%6:U===B?(D-z)/J+2:(z-B)/J+4,He=0===J?0:J/Z;return ge<0&&(ge+=6),ge*=60,He*=100,Z*=100/255,{h:ge,s:He,v:Z}}(N(_))}function j(_){return ue(_)?_:function M(_){return pe(de(_))}(N(_))}function Y(_){return Me(_)?_:function E(_){return function F(_){const z=_.l,B=_.a,D=_.b,U=Math.sqrt(B*B+D*D);let J=Math.atan2(D,B);return J=J>0?J:J+2*Math.PI,{l:z,c:U,h:J}}(pe(de(_)))}(N(_))}function re(_,z){const{r:B,g:D,b:U}=z?.ignoreAlpha?_:function K(_){let{r:z,g:B,b:D,a:U}=_;return U<1&&(z=Math.round(U*z+255*(1-U)),B=Math.round(U*B+255*(1-U)),D=Math.round(U*D+255*(1-U))),new Q.Z({r:z,g:B,b:D})}(_);return.2126*B+.7152*D+.0722*U}var he,_;(_=he||(he={}))[_.Low=160]="Low",_[_.High=225]="High"},69411:(nt,Te,y)=>{y.d(Te,{E:()=>P});var Q=y(15861),_e=y(66599),ce=y(70794),W=y(34222),Oe=y(4978),ue=y(25896),Me=y(57964),Pe=y(4703),xe=y(66398);function Ee(F,v,M,d,E){if(null==F)return null;const b=F.referencesGeometry()&&E?function de(F,v,M){const{transform:d,hasZ:E,hasM:b}=M;ve.has(v)||ve.set(v,function we(F){const v={};switch(F){case"esriGeometryPoint":return(M,d,E,b)=>(0,xe.U1)(d,v,M,E,b);case"esriGeometryPolygon":return(M,d,E,b)=>(0,xe.Ie)(d,v,M,E,b);case"esriGeometryPolyline":return(M,d,E,b)=>(0,xe.G6)(d,v,M,E,b);case"esriGeometryMultipoint":return(M,d,E,b)=>(0,xe.J9)(d,v,M,E,b);default:return Pe.Z.getLogger("esri.views.2d.support.arcadeOnDemand").error(new Me.Z("mapview-arcade",`Unable to handle geometryType: ${F}`)),M=>M}}(v));const A=ve.get(v)(F.geometry,d,E,b);return{...F,geometry:A}}(v,d,E):v,A=F.repurposeFeature(b);try{return F.evaluate({...M,$feature:A},F.services)}catch(k){return Pe.Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",k),null}}const ve=new Map,pe=F=>{if(!F)return[0,0,0,0];const{r:v,g:M,b:d,a:E}=F;return[v,M,d,255*E]};class P{static findApplicableOverrides(v,M,d){if(v&&M){if(v.primitiveName){let E=!1;for(const b of d)if(b.primitiveName===v.primitiveName){E=!0;break}if(!E)for(const b of M)b.primitiveName===v.primitiveName&&d.push(b)}switch(v.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(v.effects)for(const E of v.effects)P.findApplicableOverrides(E,M,d);if(v.symbolLayers)for(const E of v.symbolLayers)P.findApplicableOverrides(E,M,d);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(v.effects)for(const E of v.effects)P.findApplicableOverrides(E,M,d);if(v.markerPlacement&&P.findApplicableOverrides(v.markerPlacement,M,d),"CIMVectorMarker"===v.type){if(v.markerGraphics)for(const E of v.markerGraphics)P.findApplicableOverrides(E,M,d),P.findApplicableOverrides(E.symbol,M,d)}else"CIMCharacterMarker"===v.type?P.findApplicableOverrides(v.symbol,M,d):"CIMHatchFill"===v.type?P.findApplicableOverrides(v.lineSymbol,M,d):"CIMPictureMarker"===v.type&&P.findApplicableOverrides(v.animatedSymbolProperties,M,d)}}}static findEffectOverrides(v,M){if(!v)return null;if("CIMGeometricEffectDashes"===v.type&&(0,ue.T2)(v),!M||!v.primitiveName)return{type:"cim-effect-param",effect:v,overrides:[]};const d=(0,ue.Ml)(v),E=v.primitiveName,b=[];for(const A of M)A.primitiveName===E&&b.push((0,ue.Ml)(A));return{type:"cim-effect-param",effect:d,overrides:(0,ue.Ul)(b)}}static resolveSymbolOverrides(v,M,d,E,b,A,k){return(0,Q.Z)(function*(){if(!v?.symbol)return null;let{symbol:N,primitiveOverrides:L}=v;const j=!!L;if(!j&&!E)return N;N=(0,W.d9)(N),L=(0,W.d9)(L);let Y=!0;if(M||(M={attributes:{}},Y=!1),j){if(Y||(L=L.filter($=>!$.valueExpressionInfo?.expression.includes("$feature"))),k||(L=L.filter($=>!$.valueExpressionInfo?.expression.includes("$view"))),L.length>0){const $={spatialReference:d,fields:(0,ue.Qf)(M.attributes),geometryType:b};yield P.createRenderExpressions(L,$),P.evaluateOverrides(L,M,b??"esriGeometryPoint",A,k)}P.applyOverrides(N,L)}return E&&P.applyDictionaryTextOverrides(N,M,E,null),N})()}static createRenderExpressions(v,M){return(0,Q.Z)(function*(){const d=[];for(const E of v){const b=E.valueExpressionInfo;if(!b||P._expressionToRenderExpression.has(b.expression))continue;const A=(0,Oe.Yi)(b.expression,M.spatialReference,M.fields);d.push(A),A.then(k=>P._expressionToRenderExpression.set(b.expression,k))}d.length>0&&(yield Promise.all(d))})()}static evaluateOverrides(v,M,d,E,b){const A={$view:{scale:b?.scale}};for(const k of v){k.value&&"object"==typeof k.value&&(0,ce.jQ)(k.value)&&("Color"===k.propertyName||"StrokeColor"===k.propertyName)&&(k.value=pe(k.value));const N=k.valueExpressionInfo;if(!N)continue;const L=P._expressionToRenderExpression.get(N.expression);L&&(k.value=Ee(L,M,A,d,E))}}static applyDictionaryTextOverrides(v,M,d,E,b="Normal"){if(v?.type)switch(v.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":case"CIMTextSymbol":{const A=v.symbolLayers;if(!A)return;for(const k of A)k&&"CIMVectorMarker"===k.type&&P.applyDictionaryTextOverrides(k,M,d,E,"CIMTextSymbol"===v.type?v.textCase:b)}break;case"CIMVectorMarker":{const A=v.markerGraphics;if(!A)return;for(const k of A)k&&P.applyDictionaryTextOverrides(k,M,d,E)}break;case"CIMMarkerGraphic":{const A=v.textString;if(A&&A.includes("[")){const k=(0,ue.H1)(A,d);v.textString=(0,ue.E_)(M,k,E,b)}}}}static applyOverrides(v,M,d,E){if(v.primitiveName)for(const b of M)if(b.primitiveName===v.primitiveName){const A=(0,ue.Le)(b.propertyName);if(E&&E.push({cim:v,nocapPropertyName:A,value:v[A]}),d){let k=!1;for(const N of d)N.primitiveName===v.primitiveName&&(k=!0);k||d.push(b)}null!=b.value&&(v[A]=b.value)}switch(v.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(v.effects)for(const b of v.effects)P.applyOverrides(b,M,d,E);if(v.symbolLayers)for(const b of v.symbolLayers)P.applyOverrides(b,M,d,E);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(v.effects)for(const b of v.effects)P.applyOverrides(b,M,d,E);if("CIMVectorMarker"===v.type&&v.markerGraphics)for(const b of v.markerGraphics)P.applyOverrides(b,M,d,E),P.applyOverrides(b.symbol,M,d,E)}}static restoreOverrides(v){for(const M of v)M.cim[M.nocapPropertyName]=M.value}static buildOverrideKey(v){let M="";for(const d of v)void 0!==d.value&&(M+=`${d.primitiveName}${d.propertyName}${JSON.stringify(d.value)}`);return M}static toValue(v,M){if("DashTemplate"===v)return M.split(" ").map(d=>Number(d));if("Color"===v){const d=new _e.Z(M).toRgba();return d[3]*=255,d}return M}}P._expressionToRenderExpression=new Map},43248:(nt,Te,y)=>{y.d(Te,{Fp:()=>Oe,RL:()=>ve,UV:()=>Ee,bk:()=>xe});var Q=y(11462),_e=y(40637),ce=y(43818),W=y(99657);function Oe(P){switch(P.type){case"CIMPointSymbol":{const F=P.symbolLayers;if(!F||1!==F.length)return null;const v=F[0];return"CIMVectorMarker"!==v.type?null:Oe(v)}case"CIMVectorMarker":{const F=P.markerGraphics;if(!F||1!==F.length)return null;const v=F[0];if(!v)return null;const M=v.geometry;if(!M)return null;const d=v.symbol;return!d||"CIMPolygonSymbol"!==d.type&&"CIMLineSymbol"!==d.type||d.symbolLayers?.some(E=>!!E.effects)?null:{type:"sdf",geom:M,asFill:"CIMPolygonSymbol"===d.type}}}}function Pe(P){let F=1/0,v=-1/0,M=1/0,d=-1/0;for(const E of P)for(const b of E)b[0]<F&&(F=b[0]),b[0]>v&&(v=b[0]),b[1]<M&&(M=b[1]),b[1]>d&&(d=b[1]);return[F,M,v,d]}function xe(P){return P?P.rings?Pe(P.rings):P.paths?Pe(P.paths):(0,_e.YX)(P)?[P.xmin,P.ymin,P.xmax,P.ymax]:null:null}function Ee(P,F,v,M,d){const[E,b,A,k]=P;if(A<E||k<b)return[0,0,0,1];const N=A-E,L=k-b,j=W.iA,Y=W.s4,$=Math.floor(.5*(.5*j-Y)),K=(j-2*($+Y))/Math.max(N,L),re=Math.round(N*K)+2*$,he=Math.round(L*K)+2*$;let me=1;F&&(me=he/K/(F.ymax-F.ymin));let te=0,ne=0,ae=1;M&&(d?F&&v&&F.ymax-F.ymin>0&&(ae=(F.xmax-F.xmin)/(F.ymax-F.ymin),te=M.x/(v*ae),ne=M.y/v):(te=M.x,ne=M.y)),F&&(te=.5*(F.xmax+F.xmin)+te*(F.xmax-F.xmin),ne=.5*(F.ymax+F.ymin)+ne*(F.ymax-F.ymin)),te-=E,ne-=b,te*=K,ne*=K,te+=$,ne+=$;let q=te/re-.5,Re=ne/he-.5;return d&&v&&(q*=v*ae,Re*=v),[me,q,Re,ae]}function ve(P){const F=function ue(P){return P?P.rings?P.rings:P.paths?P.paths:void 0!==P.xmin&&void 0!==P.ymin&&void 0!==P.xmax&&void 0!==P.ymax?[[[P.xmin,P.ymin],[P.xmin,P.ymax],[P.xmax,P.ymax],[P.xmax,P.ymin],[P.xmin,P.ymin]]]:null:null}(P.geom),v=function Me(P){let F=1/0,v=-1/0,M=1/0,d=-1/0;for(const E of P)for(const b of E)b[0]<F&&(F=b[0]),b[0]>v&&(v=b[0]),b[1]<M&&(M=b[1]),b[1]>d&&(d=b[1]);return new ce.Z(F,M,v-F,d-M)}(F),M=W.iA,d=W.s4,E=Math.floor(.5*(.5*M-d)),b=(M-2*(E+d))/Math.max(v.width,v.height),A=Math.round(v.width*b)+2*E,k=Math.round(v.height*b)+2*E,N=[];for(const j of F)if(j&&j.length>1){const Y=[];for(const $ of j){let[K,re]=$;K-=v.x,re-=v.y,K*=b,re*=b,K+=E-.5,re+=E-.5,Y.push(P.asFill?[K,re]:[Math.round(K),Math.round(re)])}if(P.asFill){const $=Y.length-1;Y[0][0]===Y[$][0]&&Y[0][1]===Y[$][1]||Y.push(Y[0])}N.push(Y)}const L=function de(P,F,v,M){const d=F*v,E=new Array(d),b=M*M+1;for(let A=0;A<d;++A)E[A]=b;for(const A of P){const k=A.length;for(let N=1;N<k;++N){const L=A[N-1],j=A[N];let Y,$,K,re;L[0]<j[0]?(Y=L[0],$=j[0]):(Y=j[0],$=L[0]),L[1]<j[1]?(K=L[1],re=j[1]):(K=j[1],re=L[1]);let he=Math.floor(Y)-M,me=Math.floor($)+M,te=Math.floor(K)-M,ne=Math.floor(re)+M;he<0&&(he=0),me>F&&(me=F),te<0&&(te=0),ne>v&&(ne=v);const ae=j[0]-L[0],q=j[1]-L[1],Re=ae*ae+q*q;for(let ze=he;ze<me;ze++)for(let Be=te;Be<ne;Be++){const ie=ze+.5,_=Be+.5;let z,B,D=(ie-L[0])*ae+(_-L[1])*q;D<0?(z=L[0],B=L[1]):D>Re?(z=j[0],B=j[1]):(D/=Re,z=L[0]+D*ae,B=L[1]+D*q);const U=(ie-z)*(ie-z)+(_-B)*(_-B),J=(v-Be-1)*F+ze;U<E[J]&&(E[J]=U)}}}for(let A=0;A<d;++A)E[A]=Math.sqrt(E[A]);return E}(N,A,k,E);return P.asFill&&function we(P,F,v,M,d){for(const E of P){const b=E.length;for(let A=1;A<b;++A){const k=E[A-1],N=E[A];let L,j,Y,$;k[0]<N[0]?(L=k[0],j=N[0]):(L=N[0],j=k[0]),k[1]<N[1]?(Y=k[1],$=N[1]):(Y=N[1],$=k[1]);let K=Math.floor(L),re=Math.floor(j)+1,he=Math.floor(Y),me=Math.floor($)+1;K<M&&(K=M),re>F-M&&(re=F-M),he<M&&(he=M),me>v-M&&(me=v-M);for(let te=he;te<me;++te){if(k[1]>te==N[1]>te)continue;const ne=te+.5,ae=(v-te-1)*F;for(let q=K;q<re;++q)q+.5<(N[0]-k[0])*(ne-k[1])/(N[1]-k[1])+k[0]&&(d[ae+q]=-d[ae+q]);for(let q=M;q<K;++q)d[ae+q]=-d[ae+q]}}}}(N,A,k,E,L),[pe(L,E),A,k]}function pe(P,F){const v=2*F,M=P.length,d=new Uint8Array(4*M);for(let E=0;E<M;++E)(0,Q.I)(.5-P[E]/v,d,4*E);return d}},11529:(nt,Te,y)=>{y.r(Te),y.d(Te,{GraphicContainer:()=>vi.Z,GraphicsView2D:()=>_i.Z,LabelManager:()=>gi.Q,MagnifierView2D:()=>Pi,MapViewNavigation:()=>yi.Z,Stage:()=>mi});var Q=y(15861),_e=y(57964),ce=y(14007),W=y(51172),Oe=y(66679),ue=y(45974),Me=y(44406),Pe=y(70794),xe=y(56123),Ee=y(34222),ve=y(4703),de=y(55768),we=y(72578),pe=y(84176),P=y(73896),F=y(11196),v=y(69411),M=y(43248),d=y(25896),E=y(37778),b=y(99657);function k(f){const e=f.markerPlacement;return e&&e.angleToLine?F.v2.MAP:F.v2.SCREEN}class N{constructor(e){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[],e&&(this._resourceManager=e)}analyzeSymbolReference(e,i,s){if(this._cimLayers=s??[],!e)return this._cimLayers;if(this._reset(),e.primitiveOverrides){this._primitiveOverrides=e.primitiveOverrides;for(const a of this._primitiveOverrides){const l=a.valueExpressionInfo;if(l)this._setPoMap(a.primitiveName,a.propertyName,l);else if(null!=a.value){let o=a.value;a.propertyName.includes("Color")&&((0,Pe.jQ)(o)&&(o=(0,d.nn)(o)),o=(0,d.oY)(o)),this._setPoMap(a.primitiveName,a.propertyName,o)}}}return this._analyzeSymbol(e.symbol,i),this._cimLayers}_reset(){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[]}_analyzeSymbol(e,i){switch(e?.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(e,i)}}_analyzeMultiLayerSymbol(e,i){const s=e?.symbolLayers;if(!s)return;const a=e.effects;let l=F.v2.SCREEN;const o=(0,d.ap)(e)??0;"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(l=F.v2.MAP);const c="CIMPolygonSymbol"===e.type;let u=s.length;for(;u--;){const h=s[u];if(!h||!1===h.enable)continue;let m;a?.length&&(m=[...a]);const g=h.effects;g?.length&&(a?m.push(...g):m=[...g]);let w=null;if(m){w=[];for(const C of m){const O=v.E.findEffectOverrides(C,this._primitiveOverrides);O&&w.push(O)}}switch(v.E.findApplicableOverrides(h,this._primitiveOverrides,[]),h.type){case"CIMSolidFill":this._analyzeSolidFill(h,w);break;case"CIMPictureFill":this._analyzePictureFill(h,w);break;case"CIMHatchFill":this._analyzeHatchFill(h,w);break;case"CIMGradientFill":this._analyzeGradientFill(h,w);break;case"CIMSolidStroke":this._analyzeSolidStroke(h,w,c,o);break;case"CIMPictureStroke":this._analyzePictureStroke(h,w,c,o);break;case"CIMGradientStroke":this._analyzeGradientStroke(h,w,c,o);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{"CIMLineSymbol"!==e.type&&"CIMPolygonSymbol"!==e.type||(l=k(h));const C=[],O=h.primitiveName;O&&C.push(O);const T=c&&(0,d.gJ)(h.markerPlacement);this._analyzeMarker(h,w,null,C,l,o,i,[],!1,T);break}default:ve.Z.getLogger("esri.symbols.cim.cimAnalyzer").error("Cannot analyze CIM layer",h.type)}}}_analyzeSolidFill(e,i){const{primitiveName:s,type:a}=e,l=(0,d.oY)(e.color);this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!e.colorLocked,color:this._getValueOrOverrideExpression(a,s,"Color",l),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:i,applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!1})}_analyzePictureFill(e,i){const{primitiveName:s,type:a}=e,l=(0,d.cO)(e),o=(0,d.J0)(e.height,P.E.CIMPictureFill.height);let c=(0,d.J0)(e.scaleX,1);if("width"in e&&"number"==typeof e.width){const h=e.width;let m=1;const g=this._resourceManager.getResource(e.url);null!=g&&(m=g.width/g.height),c/=m*(o/h)}const u={type:"sprite-rasterization-param",resource:e,overrides:this._getPrimitiveMaterialOverrides(s,a)};this._cimLayers.push({type:"fill",spriteRasterizationParam:u,colorLocked:!!e.colorLocked,effects:i,color:this._getValueOrOverrideExpression(a,s,"TintColor",l),height:this._getValueOrOverrideExpression(a,s,"Height",o),scaleX:this._getValueOrOverrideExpression(a,s,"ScaleX",c),angle:this._getValueOrOverrideExpression(a,s,"Rotation",(0,d.J0)(e.rotation)),offsetX:this._getValueOrOverrideExpression(a,s,"OffsetX",(0,d.J0)(e.offsetX)),offsetY:this._getValueOrOverrideExpression(a,s,"OffsetY",(0,d.J0)(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeHatchFill(e,i){const{primitiveName:s,type:a}=e,l=this._analyzeMaterialOverrides(s,["Rotation","OffsetX","OffsetY"]),o=(0,d.Ul)(l);let c=[255,255,255,1],u=!1;if(e.lineSymbol?.symbolLayers)for(const m of e.lineSymbol.symbolLayers){if("CIMSolidStroke"!==m.type)continue;const g=m.primitiveName??s;u||!g||m.colorLocked||null==this._poMap[g]?.Color&&null==this._poMap[g]?.StrokeColor||(c=(0,d.oY)(m.color),c=this._maybeGetValueOrOverrideExpression(g,"StrokeColor")??this._getValueOrOverrideExpression(a,g,"Color",c),u=!0);const w=this._maybeGetValueOrOverrideExpression(g,"StrokeWidth");if(w){let S=null,C=null;"number"==typeof w?S=w:C=w.valueExpressionInfo;let O=o.find(T=>"strokeWidth"===T.propertyName);O?O.propertyName="width":(O={type:"CIMPrimitiveOverride",primitiveName:g,propertyName:"width",valueExpressionInfo:C,value:S,defaultValue:(0,d.dT)(a,"width")},o.push(O))}}this._cimLayers.push({type:"fill",spriteRasterizationParam:{type:"sprite-rasterization-param",resource:e,overrides:o},colorLocked:!!e.colorLocked,effects:i,color:c,height:this._getValueOrOverrideExpression(a,s,"Separation",(0,d.J0)(e.separation,P.E.CIMHatchFill.separation)),scaleX:1,angle:this._getValueOrOverrideExpression(a,s,"Rotation",(0,d.J0)(e.rotation)),offsetX:this._getValueOrOverrideExpression(a,s,"OffsetX",(0,d.J0)(e.offsetX)),offsetY:this._getValueOrOverrideExpression(a,s,"OffsetY",(0,d.J0)(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!u})}_analyzeGradientFill(e,i){this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!e.colorLocked,effects:i,color:[128,128,128,1],height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeSolidStroke(e,i,s,a){const{primitiveName:l,type:o}=e,c=(0,d.oY)(e.color),u=(0,d.J0)(e.width,P.E.CIMSolidStroke.width),h=(0,d.vn)(e.capStyle,P.E.CIMSolidStroke.capstyle),m=(0,d.vn)(e.joinStyle,P.E.CIMSolidStroke.joinstyle),g=e.miterLimit;let w,S,C=[];if(this._analyzePrimitiveOverrides(l,i,null,null)&&(C=this._getPrimitiveMaterialOverrides(l,o)),i&&Array.isArray(i)&&i.length>0){const T=i[i.length-1].effect;T&&"CIMGeometricEffectDashes"===T.type&&"NoConstraint"===T.lineDashEnding&&null===T.offsetAlongLine&&(w=T.dashTemplate,S=T.scaleDash,(i=[...i]).pop())}this._cimLayers.push({type:"line",spriteRasterizationParam:void 0!==w?{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:w,capStyle:h},overrides:C}:null,isOutline:s,colorLocked:!!e.colorLocked,effects:i,color:this._getValueOrOverrideExpression(o,l,"Color",c),width:this._getValueOrOverrideExpression(o,l,"Width",u),cap:this._getValueOrOverrideExpression(o,l,"CapStyle",h),join:this._getValueOrOverrideExpression(o,l,"JoinStyle",m),miterLimit:g&&this._getValueOrOverrideExpression(o,l,"MiterLimit",g),referenceWidth:a,zOrder:j(e.name),dashTemplate:w,scaleDash:S,sampleAlphaOnly:!0})}_analyzePictureStroke(e,i,s,a){const{primitiveName:l,type:o}=e,c=(0,d.cO)(e),u=(0,d.J0)(e.width,P.E.CIMPictureStroke.width),h=(0,d.vn)(e.capStyle,P.E.CIMPictureStroke.capstyle),m=(0,d.vn)(e.joinStyle,P.E.CIMPictureStroke.joinstyle),g=e.miterLimit,w={type:"sprite-rasterization-param",resource:e,overrides:this._getPrimitiveMaterialOverrides(l,o)};this._cimLayers.push({type:"line",spriteRasterizationParam:w,isOutline:s,colorLocked:!!e.colorLocked,effects:i,color:this._getValueOrOverrideExpression(o,l,"TintColor",c),width:this._getValueOrOverrideExpression(o,l,"Width",u),cap:this._getValueOrOverrideExpression(o,l,"CapStyle",h),join:this._getValueOrOverrideExpression(o,l,"JoinStyle",m),miterLimit:g&&this._getValueOrOverrideExpression(o,l,"MiterLimit",g),referenceWidth:a,zOrder:j(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeGradientStroke(e,i,s,a){const{primitiveName:l,type:o}=e,c=(0,d.J0)(e.width,P.E.CIMSolidStroke.width),u=(0,d.vn)(e.capStyle,P.E.CIMGradientStroke.capstyle),h=(0,d.vn)(e.joinStyle,P.E.CIMGradientStroke.joinstyle),m=e.miterLimit;this._cimLayers.push({type:"line",spriteRasterizationParam:null,isOutline:s,colorLocked:!!e.colorLocked,effects:i,color:[128,128,128,1],width:this._getValueOrOverrideExpression(o,l,"Width",c),cap:this._getValueOrOverrideExpression(o,l,"CapStyle",u),join:this._getValueOrOverrideExpression(o,l,"JoinStyle",h),miterLimit:m&&this._getValueOrOverrideExpression(o,l,"MiterLimit",m),referenceWidth:a,zOrder:j(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeMarker(e,i,s,a,l,o,c,u,h=!1,m=!1){if(h||=!!e.colorLocked,this._analyzeMarkerInsidePolygon(e,i,h))return;const g=(0,d.J0)(e.size,P.E.CIMVectorMarker.size),w=(0,d.J0)(e.rotation),S=(0,d.J0)(e.offsetX),C=(0,d.J0)(e.offsetY),{primitiveName:O,type:T}=e,R=this._getValueOrOverrideExpression(T,O,"Size",g),I=this._getValueOrOverrideExpression(T,O,"Rotation",w),H=this._getValueOrOverrideExpression(T,O,"OffsetX",S),G=this._getValueOrOverrideExpression(T,O,"OffsetY",C);switch(e.type){case"CIMPictureMarker":this._analyzePictureMarker(e,i,s,a,l,o,R,I,H,G,u,h,m);break;case"CIMVectorMarker":this._analyzeVectorMarker(e,i,s,a,l,o,R,I,H,G,u,c,h,m)}}_analyzeMarkerInsidePolygon(e,i,s){const{markerPlacement:a,type:l}=e;if(!a||"CIMMarkerPlacementInsidePolygon"!==a.type)return!1;if("CIMVectorMarker"===l||"CIMPictureMarker"===l){const w=e.primitiveName;if(w&&this._analyzePrimitiveOverrides([w],i,null,null))return!1;const S=a.primitiveName;if(S&&this._analyzePrimitiveOverrides([S],i,null,null))return!1;if("CIMVectorMarker"===l){const{markerGraphics:C}=e;if(C)for(const O of C){const{symbol:T}=O;if("CIMPolygonSymbol"===T?.type&&T.symbolLayers){const{symbolLayers:R}=T;for(const I of R)if("CIMSolidStroke"===I.type)return!1}}}else{const{animatedSymbolProperties:C}=e;if(C)return!1}}const o=Math.abs(a.stepX),c=Math.abs(a.stepY);if(0===o||0===c)return!0;let u,h;if("Random"===a.gridType){const w=(0,de.Wz)(b.KA),S=Math.max(Math.floor(w/o),1);u=c*Math.max(Math.floor(w/c),1),h=S*o/u}else a.shiftOddRows?(u=2*c,h=o/c*.5):(u=c,h=o/c);const m=(0,d.cO)(e);return this._cimLayers.push({type:"fill",spriteRasterizationParam:"CIMCharacterMarker"===e.type?null:{type:"sprite-rasterization-param",resource:e,overrides:[]},colorLocked:s,effects:i,color:m,height:u,scaleX:h,angle:a.gridAngle,offsetX:(0,d.J0)(a.offsetX),offsetY:(0,d.J0)(a.offsetY),applyRandomOffset:"Random"===a.gridType,sampleAlphaOnly:"CIMPictureMarker"!==e.type,hasUnresolvedReplacementColor:!0}),!0}_analyzePictureMarker(e,i,s,a,l,o,c,u,h,m,g,w,S){const{animatedSymbolProperties:C,primitiveName:O,type:T}=e;let R=(0,d.J0)(e.scaleX,1);const I=(0,d.cO)(e);s||(s=this._createMarkerPlacementOverrideExpression(e.markerPlacement));const H=this._createGIFAnimatedSymbolPropertiesOverrideExpression(C),G=e.anchorPoint??{x:0,y:0};if("width"in e&&"number"==typeof e.width){const ee=e.width;let fe=1;const le=this._resourceManager.getResource(e.url);null!=le&&(fe=le.width/le.height),R/=fe*((0,d.J0)(e.size)/ee)}const X=[...a];let V;e.primitiveName&&X.push(e.primitiveName),C||H?V={type:"animated",url:e.url,urlHash:"H"+(0,we.hP)(e.url),playAnimation:e.animatedSymbolProperties?.playAnimation,reverseAnimation:e.animatedSymbolProperties?.reverseAnimation,randomizeStartTime:e.animatedSymbolProperties?.randomizeStartTime,randomizeStartSeed:e.animatedSymbolProperties?.randomizeStartSeed,startTimeOffset:e.animatedSymbolProperties?.startTimeOffset,duration:e.animatedSymbolProperties?.duration,repeatType:e.animatedSymbolProperties?.repeatType,repeatDelay:e.animatedSymbolProperties?.repeatDelay}:(V=(0,Ee.d9)(e),V.markerPlacement=null);const se={type:"sprite-rasterization-param",resource:V,overrides:this._getMaterialOverrides(X,T)};H&&se.overrides.push(...H.overrides),this._cimLayers.push({type:"marker",spriteRasterizationParam:se,colorLocked:w,effects:i,scaleSymbolsProportionally:!1,alignment:l,size:c,scaleX:this._getValueOrOverrideExpression(T,O,"ScaleX",R),rotation:u,offsetX:h,offsetY:m,transform:{type:"cim-marker-transform-param",params:g},color:this._getValueOrOverrideExpression(T,O,"TintColor",I),anchorPoint:{x:G.x,y:G.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:[0,0,0,0],outlineWidth:0,frameHeight:0,widthRatio:1,rotateClockwise:!!e.rotateClockwise,referenceSize:o,sizeRatio:1,isOutline:S,markerPlacement:s})}_analyzeVectorMarker(e,i,s,a,l,o,c,u,h,m,g,w,S,C){const O=e.markerGraphics;if(!O)return;const T=e.frame;let R=0;if(R=T?T.ymax-T.ymin:o,R){const I={offsetX:h,offsetY:m,rotation:u,size:c,frameHeight:R,rotateClockWise:!!e.rotateClockwise};g=[...g,I]}s||(s=this._createMarkerPlacementOverrideExpression(e.markerPlacement));for(const I of O)if(I){const H=I.symbol;if(!H)continue;const G=I.primitiveName;let X;if(G&&a.push(G),("CIMPointSymbol"===H.type||"CIMTextSymbol"===H.type)&&T){let V=0,se=0;const ee=I.geometry;"x"in ee&&"y"in ee&&(V+=ee.x-.5*(T.xmin+T.xmax),se+=ee.y-.5*(T.ymin+T.ymax));const fe=e.anchorPoint;fe&&("Absolute"===e.anchorPointUnits?(V-=fe.x,se-=fe.y):T&&(V-=(T.xmax-T.xmin)*fe.x,se-=(T.ymax-T.ymin)*fe.y));const le={offsetX:V,offsetY:se,rotation:0,size:0,frameHeight:0,rotateClockWise:!1};X=[...g,le]}switch(H.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":w||K(H)?this._analyzeMultiLayerGraphicNonSDF(e,i,s,I,a,l,o,X??g,R,S,C):this._analyzeMultiLayerGraphic(e,i,s,I,a,l,o,X??g,R,S,C);break;case"CIMTextSymbol":this._analyzeTextGraphic(i,s,I,a,l,o,X??g,S)}G&&a.pop()}}_analyzeMultiLayerGraphic(e,i,s,a,l,o,c,u,h,m,g){const w=a.symbol,S=w.symbolLayers;if(!S)return;let C=S.length;if($(S))return void this._analyzeCompositeMarkerGraphic(e,i,s,a,S,o,c,u,h,m,g);const O=this._resourceManager.geometryEngine,T=E.j.applyEffects(w.effects,a.geometry,O);if(T)for(;C--;){const R=S[C];if(!R||!1===R.enable)continue;const I=R.primitiveName;switch(I&&l.push(I),R.type){case"CIMSolidFill":case"CIMSolidStroke":{const H=E.j.applyEffects(R.effects,T,O),G=(0,M.bk)(H);if(!G)continue;const X="Relative"!==e.anchorPointUnits,[V,se,ee,fe]=(0,M.UV)(G,e.frame,e.size,e.anchorPoint,X),le="CIMSolidFill"===R.type,Le={type:"sdf",geom:H,asFill:le},{path:De}=R,Ne=le?(0,d.oY)((0,d.W7)(R)):null==De?(0,d.oY)((0,d.$Z)(R)):[0,0,0,0],Ve=le?[0,0,0,0]:(0,d.oY)((0,d.$Z)(R)),je=(0,d.F)(R)??0;if(!le&&!je)break;const Ge=a.primitiveName;let Ye=null;le&&!R.colorLocked&&(Ye=this._maybeGetValueOrOverrideExpression(Ge,"FillColor"));let it=null;le||R.colorLocked||(it=this._maybeGetValueOrOverrideExpression(Ge,"StrokeColor"));const st=Ye??this._getValueOrOverrideExpression(R.type,I,"Color",Ne),_t=it??this._getValueOrOverrideExpression(R.type,I,"Color",Ve),Ue=this._maybeGetValueOrOverrideExpression(Ge,"StrokeWidth")??this._getValueOrOverrideExpression(R.type,I,"Width",je);this._cimLayers.push({type:"marker",spriteRasterizationParam:De?{type:"sprite-rasterization-param",resource:{type:"path",path:De,asFill:le},overrides:[]}:{type:"sprite-rasterization-param",resource:Le,overrides:[]},colorLocked:!!R.colorLocked||!!m,effects:i,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:o,anchorPoint:{x:se,y:ee},isAbsoluteAnchorPoint:X,size:h,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:u},frameHeight:h,widthRatio:fe,rotateClockwise:!1,referenceSize:c,sizeRatio:V,color:st,outlineColor:_t,outlineWidth:Ue,isOutline:g,markerPlacement:s});break}case"CIMPictureMarker":case"CIMVectorMarker":R.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(e,i,s,a,l,o,c,u,h,!!R.colorLocked||!!m,g):this._analyzeMarker(R,i,s,l,o,c,!1,u,m,g);break;default:this._analyzeMultiLayerGraphicNonSDF(e,i,s,a,l,o,c,u,h,!!R.colorLocked||!!m,g)}I&&l.pop()}}_analyzeTextGraphic(e,i,s,a,l,o,c,u){v.E.findApplicableOverrides(s,this._primitiveOverrides,[]);const m=s.geometry;if(!("x"in m)||!("y"in m))return;const g=s.symbol,w=(0,d.BX)(g),S=(0,d.wi)(g.fontStyleName),C=(0,xe.BN)(g.fontFamilyName);g.font={family:C,decoration:w,...S};const O=(0,d.J0)(g.height,P.E.CIMTextSymbol.height),T=(0,d.J0)(g.angle),R=(0,d.J0)(g.offsetX),I=(0,d.J0)(g.offsetY),H=(0,d.oY)((0,d.W7)(g));let G=(0,d.oY)((0,d.$Z)(g)),X=(0,d.F)(g)??0;X||(G=(0,d.oY)((0,d.W7)(g.haloSymbol)),X=(0,d.J0)(g.haloSize));let V=!1;if(g.symbol?.symbolLayers)for(const Ue of g.symbol.symbolLayers)null!=(0,d.oY)((0,d.W7)(Ue))&&(V=!!Ue.colorLocked);const se=s.primitiveName;let ee=null;V||(ee=this._maybeGetValueOrOverrideExpression(se,"FillColor"));const fe=this._maybeGetValueOrOverrideExpression(se,"TextSize"),le=this._maybeGetValueOrOverrideExpression(se,"TextAngle"),Le=this._maybeGetValueOrOverrideExpression(se,"TextOffsetX"),De=this._maybeGetValueOrOverrideExpression(se,"TextOffsetY");let Ne=null,Ve=null,je=0;if(g.callout&&"CIMBackgroundCallout"===g.callout.type){const Ue=g.callout;if(Ue.backgroundSymbol){const at=Ue.backgroundSymbol.symbolLayers;if(at)for(const $e of at)"CIMSolidFill"===$e.type?Ne=(0,d.oY)($e.color):"CIMSolidStroke"===$e.type&&(Ve=(0,d.oY)($e.color),je=(0,d.J0)($e.width,P.E.CIMSolidStroke.width))}}const Ge=this._getValueOrOverrideExpression(g.type,s.primitiveName,"TextString",s.textString??"");if(null==Ge)return;const{fontStyleName:Ye}=g,it=C+(Ye?"-"+Ye.toLowerCase():"-regular"),st=this._getMaterialOverrides(a,g.type);st.push(...this._getPrimitiveMaterialOverrides(s.primitiveName,g.type)),this._cimLayers.push({type:"text",lineWidth:g.lineWidth,textRasterizationParam:{type:"text-rasterization-param",resource:{type:"text",textString:s.textString??"",font:g.font,symbol:g,primitiveName:s.primitiveName},overrides:st},colorLocked:!!u||!!V,effects:e,alignment:l,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:!1,fontName:it,decoration:w,weight:S.weight,style:S.style,size:fe??O,angle:le??T,offsetX:Le??R,offsetY:De??I,transform:{type:"cim-marker-transform-param",params:c},horizontalAlignment:(0,d.X_)(g.horizontalAlignment),verticalAlignment:(0,d.FG)(g.verticalAlignment),text:Ge,color:ee??this._getValueOrOverrideExpression(g.type,s.primitiveName,"Color",H),outlineColor:G,outlineSize:X,backgroundColor:Ne,borderLineColor:Ve,borderLineWidth:je,referenceSize:o,sizeRatio:1,markerPlacement:i})}_analyzeMultiLayerGraphicNonSDF(e,i,s,a,l,o,c,u,h,m,g){const w=function L(f,e){return{type:f.type,enable:!0,name:f.name,colorLocked:f.colorLocked,primitiveName:f.primitiveName,anchorPoint:f.anchorPoint,anchorPointUnits:f.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:f.rotateClockwise,rotation:0,size:f.size,billboardMode3D:f.billboardMode3D,depth3D:f.depth3D,frame:f.frame,markerGraphics:[e],scaleSymbolsProportionally:f.scaleSymbolsProportionally,respectFrame:f.respectFrame,clippingPath:f.clippingPath}}(e,a),C=this._analyzeMaterialOverrides(e.primitiveName,["Rotation","OffsetX","OffsetY"]),O=(0,d.Ul)(C),[T,R,I]=pe.B$.getTextureAnchor(w,this._resourceManager),H=this._getMaterialOverrides(l,e.type);H.push(...O);const G={type:"sprite-rasterization-param",resource:{...w,avoidSDFRasterization:!0},overrides:H};this._cimLayers.push({type:"marker",spriteRasterizationParam:G,colorLocked:m,effects:i,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:o,anchorPoint:{x:T,y:R},isAbsoluteAnchorPoint:!1,size:h,rotation:0,offsetX:0,offsetY:0,transform:{type:"cim-marker-transform-param",params:u},color:[255,255,255,1],outlineColor:[0,0,0,0],outlineWidth:0,scaleX:1,frameHeight:h,widthRatio:1,rotateClockwise:!!e.rotateClockwise,referenceSize:c,sizeRatio:I/(0,de.F2)(e.size),isOutline:g,markerPlacement:s})}_createMarkerPlacementOverrideExpression(e){if(!e)return null;const i=[];return v.E.findApplicableOverrides(e,this._primitiveOverrides,i),{type:"cim-marker-placement-param",placement:e,overrides:re(i)}}_createGIFAnimatedSymbolPropertiesOverrideExpression(e){if(!e)return null;const i=[];return v.E.findApplicableOverrides(e,this._primitiveOverrides,i),{type:"cim-gif-animation-params",animation:e,overrides:re(i)}}_analyzeCompositeMarkerGraphic(e,i,s,a,l,o,c,u,h,m,g){const w=a.geometry,S=l[0],C=l[1],O=(0,M.bk)(w);if(!O)return;const T="Relative"!==e.anchorPointUnits,[R,I,H,G]=(0,M.UV)(O,e.frame,e.size,e.anchorPoint,T),{path:X}=C,V=C.primitiveName,se=S.primitiveName,ee=a.primitiveName;let fe=null;C.colorLocked||m||(fe=this._maybeGetValueOrOverrideExpression(ee,"FillColor"));const le=fe??this._getValueOrOverrideExpression(C.type,V,"Color",(0,d.oY)(C.color));let Le=null;S.colorLocked||m||(Le=this._maybeGetValueOrOverrideExpression(ee,"StrokeColor"));const De=Le??this._getValueOrOverrideExpression(S.type,se,"Color",(0,d.oY)(S.color)),Ne=this._maybeGetValueOrOverrideExpression(ee,"StrokeWidth")??this._getValueOrOverrideExpression(S.type,se,"Width",(0,d.J0)(S.width,P.E.CIMSolidStroke.width));this._cimLayers.push({type:"marker",spriteRasterizationParam:{type:"sprite-rasterization-param",resource:X?{type:"path",path:X,asFill:!0}:{type:"sdf",geom:w,asFill:!0},overrides:[]},colorLocked:m,effects:i,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:o,anchorPoint:{x:I,y:H},isAbsoluteAnchorPoint:T,size:h,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:u},frameHeight:h,widthRatio:G,rotateClockwise:!1,referenceSize:c,sizeRatio:R,color:le,outlineColor:De,outlineWidth:Ne,isOutline:g,markerPlacement:s})}_setPoMap(e,i,s){let a;this._poMap[e]?a=this._poMap[e]:(a={},this._poMap[e]=a),a[i]=s}_maybeGetValueOrOverrideExpression(e,i,s){return this._getValueOrOverrideExpression("",e,i,s,!1)}_getValueOrOverrideExpression(e,i,s,a,l=!0){if(l&&!(0,d.Mk)(a)&&(a=(0,d.dT)(e,s.toLowerCase())),null==i)return a;const o=this._poMap[i];if(null==o)return a;const c=o[s];return"string"==typeof c||"number"==typeof c||Array.isArray(c)?c:c?{valueExpressionInfo:c,defaultValue:a}:a}_analyzePrimitiveOverrides(e,i,s,a){if(null==e)return!1;"string"==typeof e&&(e=[e]);for(const l of this._primitiveOverrides)if(e.includes(l.primitiveName)&&l.valueExpressionInfo)return!0;if(null!=i)for(const l of i)if(l?.overrides.length>0)return!0;if(null!=s)for(const l of s)if(l?.overrides.length>0)return!0;if(null!=a)for(const l of a)if(l?.overrides.length>0)return!0;return!1}_getMaterialOverrides(e,i){if(!e)return[];const s=[];for(const a of e)s.push(...this._getPrimitiveMaterialOverrides(a,i));return s}_getPrimitiveMaterialOverrides(e,i){if(!e)return[];const s=(0,d.Ul)(this._primitiveOverrides.filter(a=>a.primitiveName===e));return s.forEach(a=>a.defaultValue=(0,d.dT)(i,a.propertyName.toLowerCase())),s}_analyzeMaterialOverrides(e,i){return this._primitiveOverrides.filter(s=>s.primitiveName!==e||!i.includes(s.propertyName))}}function j(f){if(f&&0===f.indexOf("Level_")){const e=parseInt(f.substr(6),10);if(!isNaN(e))return e}return 0}const $=f=>f&&2===f.length&&f[0].enable&&f[1].enable&&"CIMSolidStroke"===f[0].type&&"CIMSolidFill"===f[1].type&&null==f[0].path&&null==f[1].path&&!f[0].effects&&!f[1].effects;function K(f){const e=f.symbolLayers;if(!e||2!==e.length)return!1;const i=e.find(a=>a.effects?.find(l=>"CIMGeometricEffectDashes"===l.type&&null!=l.dashTemplate)),s=e.find(a=>a.effects?.find(l=>"CIMGeometricEffectAddControlPoints"===l.type));return!!i||!!s}function re(f){return(0,Ee.d9)(f).map(e=>({...e,propertyName:(0,d.Le)(e.propertyName)}))}var he=y(85338),me=y(88278),te=y(90984),ne=y(1258),ae=y(55117),q=y(60902),Re=y(39754),ze=y(99273);class Be{constructor(e){this.events=new me.Z,this._hasMajorPerformanceCaveat=!1,this._lastRenderFrameCounter=0,this._canvas=document.createElement("canvas"),this._canvas.setAttribute("style","width: 100%; height:100%; display:block; willChange:transform");const i={failIfMajorPerformanceCaveat:!0,alpha:!0,antialias:!1,depth:!0,stencil:!0};e.appendChild(this._canvas);let s=(0,ze.k)(this._canvas,i);s||(s=(0,ze.k)(this._canvas,{...i,failIfMajorPerformanceCaveat:!1}),this._hasMajorPerformanceCaveat=!0),this._gl=s,this._handles=(0,ne.AL)([(0,te.on)(this._canvas,"webglcontextlost",a=>this.events.emit("webgl-context-lost",a))])}destroy(){this._canvas.parentNode?.removeChild(this._canvas),this._canvas=null,this._handles.remove(),this._gl=null}get gl(){return this._gl}render(e,i){if(this._hasMajorPerformanceCaveat||(0,ce.Z)("esri-force-performance-mode")){if(++this._lastRenderFrameCounter>=(0,ce.Z)("esri-performance-mode-frames-between-render")&&(i(),this._lastRenderViewState=e.state.clone(),this._lastRenderFrameCounter=0),this._lastRenderViewState){const[s,a,l,o,c,u]=this._computeViewTransform(this._lastRenderViewState,e.state);this._canvas.style.transform=`matrix(${s}, ${a}, ${l}, ${o}, ${c}, ${u})`}}else i()}resize(e){const i=this._canvas,s=i.style,{state:{size:a},pixelRatio:l}=e,o=a[0],c=a[1],u=Math.round(o*l),h=Math.round(c*l);i.width===u&&i.height===h||(i.width=u,i.height=h),s.width=o+"px",s.height=c+"px"}_computeViewTransform(e,i){const[s,a]=e.center,[l,o]=i.center,[c,u]=e.toScreen([0,0],l,o),[h,m]=e.toScreen([0,0],s,a),g=h-c,w=m-u,S=e.scale/i.scale,C=i.rotation-e.rotation,O=(0,Re.Ue)();return(0,q.yR)(O),(0,q.bA)(O,O,[S,S]),(0,q.U1)(O,O,(0,ae.Vl)(C)),(0,q.Iu)(O,O,[g,w]),O}}var ie=y(43101),_=y(15805),z=y(17866);const B={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform lowp sampler2D u_texture;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\nvoid main() {\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = u_opacity * color;\n#else\ngl_FragColor = u_color;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\nuniform mediump vec4 u_tlbr;\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\n#endif\nvoid main() {\ngl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\nv_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\nv_tlbr             = u_tlbr / u_mosaicSize.xyxy;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nvoid main()\n{\nmediump float dist = length(v_offset);\nmediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\nlowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\ngl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_stroke_color = stroke_color * stroke_opacity;\nv_stroke_width = stroke_width;\nv_radius = radius;\nv_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\nmediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\nv_offset = offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = v_color[3] * color;\n#else\ngl_FragColor = v_color;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\n#include <util/util.glsl>\nuniform mediump vec2 u_mosaicSize;\nuniform mediump float u_patternFactor;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef PATTERN\nfloat patternWidth = nextPOT(tlbr.z - tlbr.x);\nfloat patternHeight = nextPOT(tlbr.w - tlbr.y);\nfloat scaleX = 1.0 / (patternWidth * u_patternFactor);\nfloat scaleY = 1.0 / (patternHeight * u_patternFactor);\nmat3 patterMat = mat3(scaleX, 0.0,    0.0,\n0.0,    -scaleY, 0.0,\n0.0,    0.0,    1.0);\nv_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;\nv_tlbr             = tlbr / u_mosaicSize.xyxy;\n#endif\nvec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\nlowp vec4 fillPixelColor = v_color;\nfloat d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\nconst float softEdgeRatio = 0.248062016;\nfloat size = max(v_size.x, v_size.y);\nfloat dist = d * softEdgeRatio * size;\nfillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\nif (v_halo_width > 0.25) {\nlowp vec4 outlinePixelColor = u_outlineColor;\nconst float outlineLimitRatio = (16.0 / 86.0);\nfloat clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\noutlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\ngl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n}\nelse {\ngl_FragColor = v_opacity * fillPixelColor;\n}\n#else\nlowp vec4 texColor = texture2D(u_texture, v_tex);\ngl_FragColor = v_opacity * texColor;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nv_color = color;\nv_opacity = opacity;\n#ifdef SDF\nv_halo_width = halo_width;\n#endif\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_opacity *= interpolatedOpacity;\nmediump float a_angle         = a_levelInfo[1];\nmediump float a_minLevel      = a_levelInfo[2];\nmediump float a_maxLevel      = a_levelInfo[3];\nmediump vec2 a_tex            = a_texAngleRange.xy;\nmediump float delta_z = 0.0;\nmediump float rotated = mod(a_angle + u_mapRotation, 256.0);\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_opacity, 0.0);\nvec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\nv_size = abs(offset);\n#ifdef SDF\noffset = (120.0 / 86.0) * offset;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\nv_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"precision lowp float;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#if defined (PATTERN) || defined(SDF)\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\nuniform sampler2D u_texture;\nuniform mediump float u_antialiasing;\n#endif\n#ifdef SDF\n#include <util/encoding.glsl>\n#endif\nvoid main()\n{\nmediump float fragDist = length(v_normal) * v_lineHalfWidth;\nlowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\nmediump float relativeTexX = fract(v_accumulatedDistance / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nlowp vec4 color = texture2D(u_texture, texCoord);\ngl_FragColor = alpha * v_color[3] * color;\n#elif defined(SDF)\nmediump float relativeTexX = fract((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY =  0.5 + 0.25 * v_normal.y;\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nmediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;\nfloat dist = d * (v_lineHalfWidth + u_antialiasing / 2.0);\ngl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;\n#else\ngl_FragColor = alpha * v_color;\n#endif\n}","line.vert":"precision mediump float;\nattribute vec2 a_pos;\nattribute vec4 a_extrude_offset;\nattribute vec4 a_dir_normal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump float u_zoomFactor;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\nconst mediump float tileCoordRatio = 8.0;\n#if defined (SDF)\nconst mediump float sdfPatternHalfWidth = 15.5;\n#endif\n#if defined (PATTERN) || defined(SDF)\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_blur = blur + u_antialiasing;\nv_normal = a_dir_normal.zw * scale;\n#if defined (PATTERN) || defined(SDF)\nv_tlbr          = tlbr / u_mosaicSize.xyxy;\nv_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);\n#if defined (PATTERN)\nv_widthRatio = width / v_patternSize.y;\n#else\nv_widthRatio = width / sdfPatternHalfWidth / 2.0;\n#endif\n#endif\nv_lineHalfWidth = (width + u_antialiasing) * 0.5;\nmediump vec2 dir = a_dir_normal.xy * scale;\nmediump vec2 offset_ = a_extrude_offset.zw * scale * offset;\nmediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n#if defined (PATTERN) || defined(SDF)\nv_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);\n#endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\nvoid main()\n{\nlowp float dist = abs(v_normal.y);\nlowp float alpha = smoothstep(1.0, 0.0, dist);\ngl_FragColor = alpha * v_color;\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_normal = a_xnormal;\nmediump vec2 dist = u_outline_width * scale * a_offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\nvoid main()\n{\nlowp float dist = texture2D(u_texture, v_tex).a;\nmediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\ngl_FragColor = alpha * v_color;\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nif (u_halo > 0.5)\n{\nv_color = halo_color * opacity;\nhalo_width *= sdfPixel;\nhalo_blur *= sdfPixel;\n}\nelse\n{\nv_color = color * opacity;\nhalo_width = 0.0;\nhalo_blur = 0.0;\n}\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_color *= interpolatedOpacity;\nmediump float a_angle       = a_levelInfo[1];\nmediump float a_minLevel    = a_levelInfo[2];\nmediump float a_maxLevel    = a_levelInfo[3];\nmediump vec2 a_tex          = a_texAngleRange.xy;\nmediump float a_visMinAngle    = a_texAngleRange.z;\nmediump float a_visMaxAngle    = a_texAngleRange.w;\nmediump float delta_z = 0.0;\nmediump float angle = mod(a_angle + u_mapRotation, 256.0);\nif (a_visMinAngle < a_visMaxAngle)\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n}\nelse\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n}\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_color[3], 0.0);\nv_tex = a_tex.xy / u_mosaicSize;\nv_edgeDistance = edgePos - halo_width / size;\nv_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, rgba2float_factors);\n}","util.glsl":"float nextPOT(in float x) {\nreturn pow(2.0, ceil(log2(abs(x))));\n}"}},J=new(y(52190).B)(function U(f){let e=B;return f.split("/").forEach(i=>{e&&(e=e[i])}),e});function Z(f){return J.resolveIncludes(f)}var ge=y(93344);const He=f=>(0,ge.K)({PATTERN:f.pattern}),Wt={shaders:f=>({vertexShader:He(f)+Z("background/background.vert"),fragmentShader:He(f)+Z("background/background.frag")})},Xt={shaders:f=>({vertexShader:Z("circle/circle.vert"),fragmentShader:Z("circle/circle.frag")})},vt=f=>(0,ge.K)({PATTERN:f.pattern}),Zt={shaders:f=>({vertexShader:vt(f)+Z("fill/fill.vert"),fragmentShader:vt(f)+Z("fill/fill.frag")})},jt={shaders:f=>({vertexShader:Z("outline/outline.vert"),fragmentShader:Z("outline/outline.frag")})},yt=f=>(0,ge.K)({SDF:f.sdf}),Yt={shaders:f=>({vertexShader:yt(f)+Z("icon/icon.vert"),fragmentShader:yt(f)+Z("icon/icon.frag")})},bt=f=>(0,ge.K)({PATTERN:f.pattern,SDF:f.sdf}),$t={shaders:f=>({vertexShader:bt(f)+Z("line/line.vert"),fragmentShader:bt(f)+Z("line/line.frag")})},Jt={shaders:f=>({vertexShader:Z("text/text.vert"),fragmentShader:Z("text/text.frag")})};class Kt{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getMaterialProgram(e,i,s){const a=i.key<<3|this._getMaterialOptionsValue(i.type,s);if(this._programByKey.has(a))return this._programByKey.get(a);const l=this._getProgramTemplate(i.type),{shaders:o}=l,{vertexShader:c,fragmentShader:u}=o(s),h=i.getShaderHeader(),m=i.getShaderMain(),g=c.replace("#pragma header",h).replace("#pragma main",m),w=e.programCache.acquire(g,u,i.getAttributeLocations());return this._programByKey.set(a,w),w}_getMaterialOptionsValue(e,i){switch(e){case z._K.BACKGROUND:case z._K.FILL:return(i.pattern?1:0)<<1;case z._K.OUTLINE:return 0;case z._K.LINE:return(i.sdf?1:0)<<2|(i.pattern?1:0)<<1;case z._K.ICON:return(i.sdf?1:0)<<1;default:return 0}}_getProgramTemplate(e){switch(e){case z._K.BACKGROUND:return Wt;case z._K.CIRCLE:return Xt;case z._K.FILL:return Zt;case z._K.ICON:return Yt;case z._K.LINE:return $t;case z._K.OUTLINE:return jt;case z._K.TEXT:return Jt;default:return null}}}var xt=y(40176),Mt=y(59319),ot=y(39853),x=y(39237),Je=y(82003),lt=y(46682);class wt{constructor(){this._initialized=!1}dispose(){this._program=(0,W.M2)(this._program),this._vertexArrayObject=(0,W.M2)(this._vertexArrayObject)}render(e,i,s,a){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA,x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),i.setSamplingMode(s),e.bindTexture(i,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",a),e.drawArrays(x.MX.TRIANGLE_STRIP,0,4),e.bindTexture(null,0),e.bindVAO())}_initialize(e){if(this._initialized)return!0;const i=(0,Je.H)(e,Mt.Q);if(!i)return!1;const s=new Int8Array(16);s[0]=-1,s[1]=-1,s[2]=0,s[3]=0,s[4]=1,s[5]=-1,s[6]=1,s[7]=0,s[8]=-1,s[9]=1,s[10]=0,s[11]=1,s[12]=1,s[13]=1,s[14]=1,s[15]=1;const l=new lt.U(e,Mt.Q.attributes,xt.As,{geometry:ot.f.createVertex(e,x.l1.STATIC_DRAW,s)});return this._program=i,this._vertexArrayObject=l,this._initialized=!0,!0}}var Qt=y(61326);class qt{constructor(e){this._rctx=e,this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getProgram(e,i=[]){const s=e.vsPath+"."+e.fsPath+JSON.stringify(i);if(this._programByKey.has(s))return this._programByKey.get(s);const a={...i.map(m=>"string"==typeof m?{name:m,value:!0}:m).reduce((m,g)=>({...m,[g.name]:g.value}),{})},{vsPath:l,fsPath:o,attributes:c}=e,u=(0,Qt.s)(l,o,c,a),h=this._rctx.programCache.acquire(u.shaders.vertexShader,u.shaders.fragmentShader,u.attributes);if(!h)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(s,h),h}}var er=y(11931),We=y(66476),tr=y(19939),Se=y(79412),rr=y(51571),St=y(52793),ir=y(43818);class ar{constructor(e){this._resourceManager=e,this._cachedRasterizationCanvas=null}dispose(){this._cachedRasterizationCanvas=null}get _canvas(){return this._cachedRasterizationCanvas||(this._cachedRasterizationCanvas=document.createElement("canvas")),this._cachedRasterizationCanvas}rasterizeJSONResource(e){switch(e.type){case"dash":{const i=e.dashTemplate,s=e.capStyle,[a,l,o]=(0,St.m)(i,s);return{size:[l,o],image:new Uint32Array(a.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}case"fill-style":{const[i,s,a,l]=(0,St.Y)(this._canvas,e,b.FM);return{size:[s,a],image:new Uint32Array(i.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:l}}case"sdf":return Ot(e);case"CIMHatchFill":case"CIMVectorMarker":case"CIMPictureMarker":return this._rasterizeCIMJSONResource(e)}}_rasterizeCIMJSONResource(e){switch(e.type){case"CIMHatchFill":{const i=pe.B$.fromCIMHatchFill(e,b.FM);return this._rasterizeCIMVectorMarker(i)}case"CIMPictureMarker":{const i=pe.B$.fromCIMInsidePolygon(e);return this._rasterizeCIMVectorMarker(i)}case"CIMVectorMarker":{if("CIMMarkerPlacementInsidePolygon"===e.markerPlacement?.type){const s=pe.B$.fromCIMInsidePolygon(e);return this._rasterizeCIMVectorMarker(s)}const i=(0,M.Fp)(e);return i&&!e.avoidSDFRasterization?Ot(i):this._rasterizeCIMVectorMarker(e,!1)}}}_rasterizeCIMVectorMarker(e,i=!0){const s=i?ir.Z.fromExtent(e.frame):null,[a,l,o,c,u]=pe.B$.rasterize(this._canvas,e,s,this._resourceManager);return a?{size:[l,o],image:new Uint32Array(a.buffer),sdf:!1,simplePattern:!1,anchorX:c,anchorY:u}:null}rasterizeImageResource(e,i,s,a){this._canvas.width=e,this._canvas.height=i;const l=this._canvas.getContext("2d",{willReadFrequently:!0});s instanceof ImageData?l.putImageData(s,0,0):(s.setAttribute("width",`${e}px`),s.setAttribute("height",`${i}px`),l.drawImage(s,0,0,e,i));const o=l.getImageData(0,0,e,i),c=new Uint8Array(o.data);if(a)for(const S of a)if(S&&S.oldColor&&4===S.oldColor.length&&S.newColor&&4===S.newColor.length){const[C,O,T,R]=S.oldColor,[I,H,G,X]=S.newColor;if(C===I&&O===H&&T===G&&R===X)continue;for(let V=0;V<c.length;V+=4)C===c[V]&&O===c[V+1]&&T===c[V+2]&&R===c[V+3]&&(c[V]=I,c[V+1]=H,c[V+2]=G,c[V+3]=X)}let u;for(let S=0;S<c.length;S+=4)u=c[S+3]/255,c[S]=c[S]*u,c[S+1]=c[S+1]*u,c[S+2]=c[S+2]*u;let h=c,m=e,g=i;const w=512;if(m>=w||g>=w){const S=m/g;S>1?(m=w,g=Math.round(w/S)):(g=w,m=Math.round(w*S)),h=new Uint8Array(4*m*g);const C=new Uint8ClampedArray(h.buffer);(0,d.TT)(c,e,i,C,m,g,!1)}return{size:[m,g],image:new Uint32Array(h.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}function Ot(f){if(!f)return null;const[e,i,s]=(0,M.RL)(f);return e?{size:[i,s],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}var ye=y(46117);class Ke{constructor(e,i){this._width=0,this._height=0,this._free=[],this._width=e,this._height=i,this._free.push(new ye.Z(0,0,e,i))}get width(){return this._width}get height(){return this._height}allocate(e,i){if(e>this._width||i>this._height)return new ye.Z;let s=null,a=-1;for(let l=0;l<this._free.length;++l){const o=this._free[l];e<=o.width&&i<=o.height&&(null===s||o.y<=s.y&&o.x<=s.x)&&(s=o,a=l)}return null===s?new ye.Z:(this._free.splice(a,1),s.width<s.height?(s.width>e&&this._free.push(new ye.Z(s.x+e,s.y,s.width-e,i)),s.height>i&&this._free.push(new ye.Z(s.x,s.y+i,s.width,s.height-i))):(s.width>e&&this._free.push(new ye.Z(s.x+e,s.y,s.width-e,s.height)),s.height>i&&this._free.push(new ye.Z(s.x,s.y+i,e,s.height-i))),new ye.Z(s.x,s.y,e,i))}release(e){for(let i=0;i<this._free.length;++i){const s=this._free[i];if(s.y===e.y&&s.height===e.height&&s.x+s.width===e.x)s.width+=e.width;else if(s.x===e.x&&s.width===e.width&&s.y+s.height===e.y)s.height+=e.height;else if(e.y===s.y&&e.height===s.height&&e.x+e.width===s.x)s.x=e.x,s.width+=e.width;else{if(e.x!==s.x||e.width!==s.width||e.y+e.height!==s.y)continue;s.y=e.y,s.height+=e.height}this._free.splice(i,1),this.release(e)}this._free.push(e)}}var Ce=y(17091),oe=y(22784);const or=f=>Math.floor(f/256);class ur{constructor(e,i,s){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this._preloadCache={},this.width=e,this.height=i,this._glyphSource=s,this._binPack=new Ke(e-4,i-4),this._glyphData.push(new Uint8Array(e*i)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs()}dispose(){this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyphs(){const e=[117,149,181,207,207,181,149,117],i=[],s=[];for(let o=0;o<e.length;o++){const c=e[o];for(let u=0;u<11;u++){const h=o>=3&&o<5&&u>=3&&u<8?255:0;i.push(c),s.push(h)}}const a={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(i)},l={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(s)};this._recordGlyph(a),this._recordGlyph(l)}getTexture(e,i){if(!this._textures[i]){const s=new oe.X;s.pixelFormat=x.VI.ALPHA,s.wrapMode=x.e8.CLAMP_TO_EDGE,s.width=this.width,s.height=this.height,this._textures[i]=new Ce.x(e,s,new Uint8Array(this.width*this.height))}return this._dirties[i]&&(this._textures[i].setData(this._glyphData[i]),this._dirties[i]=!1),this._textures[i]}getGlyphItems(e,i,s){var a=this;return(0,Q.Z)(function*(){const l=a._getGlyphCache(e);return yield a._fetchRanges(e,i,s),i.map(o=>a._getMosaicItem(l,e,o))})()}bind(e,i,s,a){const l=this.getTexture(e,s);l.setSamplingMode(i),e.bindTexture(l,a)}preloadASCIIGlyphCache(e){const i=this._preloadCache[e];if(null!=i)return i;const s=this._glyphSource.preloadASCIIRange(e).then(()=>{const a=this._getGlyphCache(e);for(let l=0;l<256;l++)this._getMosaicItem(a,e,l)});return this._preloadCache[e]=s,s}_getGlyphCache(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}_invalidate(){this._dirties[this._currentPage]=!0}_fetchRanges(e,i,s){var a=this;return(0,Q.Z)(function*(){const l=function lr(f){const e=new Set;for(const i of f)e.add(or(i));return e}(i),o=[];l.forEach(c=>{o.push(a._fetchRange(e,c,s))}),yield Promise.all(o)})()}_fetchRange(e,i,s){var a=this;return(0,Q.Z)(function*(){if(!(i>256))return function cr(f,e,i){return f.has(e)||f.set(e,i().then(()=>{f.delete(e)}).catch(s=>{f.delete(e),(0,Se.H9)(s)})),f.get(e)}(a._rangePromises,e+i,()=>a._glyphSource.getRange(e,i,s))})()}_getMosaicItem(e,i,s){if(!e[s]){const a=this._glyphSource.getGlyph(i,s);if(!a?.metrics)return f=s,{rect:new ye.Z(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:f,sdf:!0};const l=this._recordGlyph(a);e[s]={rect:l,page:this._currentPage,metrics:a.metrics,code:s,sdf:!0},this._invalidate()}var f;return e[s]}_recordGlyph(e){const i=e.metrics;let s;if(0===i.width)s=new ye.Z(0,0,0,0);else{const l=i.width+6,o=i.height+6;s=this._binPack.allocate(l,o),s.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new Ke(this.width-4,this.height-4),s=this._binPack.allocate(l,o));const c=this._glyphData[this._currentPage],u=e.bitmap;let h,m;if(u)for(let g=0;g<o;g++){h=l*g,m=this.width*(s.y+g)+s.x;for(let w=0;w<l;w++)c[m+w]=u[h+w]}(0,ce.Z)("esri-glyph-debug")&&this._showDebugPage(c)}return s}_showDebugPage(e){const i=document.createElement("canvas"),s=i.getContext("2d"),a=new ImageData(this.width,this.height),l=a.data;i.width=this.width,i.height=this.height,i.style.border="1px solid black";for(let o=0;o<e.length;++o)l[4*o]=e[o],l[4*o+1]=0,l[4*o+2]=0,l[4*o+3]=255;s.putImageData(a,0,0),document.body.appendChild(i)}}var Pt=y(40485);class Ct{constructor(e){for(this._metrics=[],this._bitmaps=[];e.next();)switch(e.tag()){case 1:{const i=e.getMessage();for(;i.next();)switch(i.tag()){case 3:{const s=i.getMessage();let a,l,o,c,u,h,m;for(;s.next();)switch(s.tag()){case 1:a=s.getUInt32();break;case 2:l=s.getBytes();break;case 3:o=s.getUInt32();break;case 4:c=s.getUInt32();break;case 5:u=s.getSInt32();break;case 6:h=s.getSInt32();break;case 7:m=s.getUInt32();break;default:s.skip()}s.release(),a&&(this._metrics[a]={width:o,height:c,left:u,top:h,advance:m},this._bitmaps[a]=l);break}default:i.skip()}i.release();break}default:e.skip()}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class dr{constructor(){this._ranges=[]}getRange(e){return this._ranges[e]}addRange(e,i){this._ranges[e]=i}}class fr{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,i,s){const a=this._getFontStack(e);if(a.getRange(i))return Promise.resolve();const l=256*i,o=l+255,c=this._baseURL.replace("{fontstack}",e).replace("{range}",l+"-"+o);return(0,We.Z)(c,{responseType:"array-buffer",...s}).then(u=>{a.addRange(i,new Ct(new Pt.Z(new Uint8Array(u.data),new DataView(u.data))))})}preloadASCIIRange(e){var i=this;return(0,Q.Z)(function*(){const s=i._getFontStack(e),o=i._baseURL.replace("{fontstack}",e).replace("{range}","0-255"),c=yield(0,We.Z)(o,{responseType:"array-buffer"}),u=new Ct(new Pt.Z(new Uint8Array(c.data),new DataView(c.data)));for(let h=0;h<=255;h++)s.getRange(h)||s.addRange(h,u)})()}getGlyph(e,i){const s=this._getFontStack(e);if(!s)return;const a=Math.floor(i/256),l=s.getRange(a);return l?{metrics:l.getMetrics(i),bitmap:l.getBitmap(i)}:void 0}_getFontStack(e){let i=this._glyphInfo[e];return i||(i=this._glyphInfo[e]=new dr),i}}var pr=y(11462);const Xe=1e20;class mr{constructor(e,i=2){this._textureSize=e,this._rasterizationScale=i,this._canvasSize=this._textureSize*this._rasterizationScale,this._svg=null;const{_canvasSize:s}=this,a=document.createElement("canvas");a.width=a.height=s,this._context=a.getContext("2d",{willReadFrequently:!1}),this._gridOuter=new Float64Array(s*s),this._gridInner=new Float64Array(s*s),this._f=new Float64Array(s),this._d=new Float64Array(s),this._z=new Float64Array(s+1),this._v=new Int16Array(s)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(e,i,s){const{_canvasSize:a,_textureSize:l,_rasterizationScale:o}=this,c=l/4;this._initSVG();const u=this.createSVGString(e,i);return new Promise((h,m)=>{const g=new Image;g.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(u),g.onload=()=>{g.onload=null,this._context.clearRect(0,0,a,a),this._context.drawImage(g,0,0,a,a);const S=this._context.getImageData(0,0,a,a),C=new Uint8Array(l*l*4);for(let O=0;O<a*a;O++){const T=S.data[4*O+3]/255;this._gridOuter[O]=1===T?0:0===T?Xe:Math.max(0,.5-T)**2,this._gridInner[O]=1===T?Xe:0===T?0:Math.max(0,T-.5)**2}this._edt(this._gridOuter,a,a),this._edt(this._gridInner,a,a);for(let O=0;O<l*l;O++){let T=0;for(let R=0;R<o;R++){const I=Math.floor(O/l)*o+R;for(let H=0;H<o;H++){const G=I*a+(O%l*o+H);T+=this._gridOuter[G]-this._gridInner[G]}}T/=o*o,T/=o,(0,pr.I)(.5-T/(2*c),C,4*O)}h(C)};const w=s?.signal;w&&(0,Se.fu)(w,()=>m((0,Se.zE)()))})}_initSVG(){if(!this._svg){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}return this._svg}createSVGString(e,i){const s=this._initSVG(),a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d",e),s.appendChild(a);const l=a.getBBox(),o=l.width/l.height,c=this._canvasSize/2;let u,h,m;o>1?(u=c/l.width,h=this._canvasSize/4,m=c-c*(1/o)/2):(u=c/l.height,h=c-c*o/2,m=this._canvasSize/4),a.setAttribute("style",`transform: matrix(${u}, 0, 0, ${u}, ${-l.x*u+h}, ${-l.y*u+m})`),a.setAttribute("stroke-width",""+.5/u);const S=`<svg style="fill:${i?"red":"none"}; stroke:${i?"none":"red"}" height="${this._canvasSize}" width="${this._canvasSize}" xmlns="http://www.w3.org/2000/svg">${s.innerHTML}</svg>`;return s.removeChild(a),S}_edt(e,i,s){const a=this._f,l=this._d,o=this._v,c=this._z;for(let u=0;u<i;u++){for(let h=0;h<s;h++)a[h]=e[h*i+u];this._edt1d(a,l,o,c,s);for(let h=0;h<s;h++)e[h*i+u]=l[h]}for(let u=0;u<s;u++){for(let h=0;h<i;h++)a[h]=e[u*i+h];this._edt1d(a,l,o,c,i);for(let h=0;h<i;h++)e[u*i+h]=Math.sqrt(l[h])}}_edt1d(e,i,s,a,l){s[0]=0,a[0]=-Xe,a[1]=+Xe;for(let o=1,c=0;o<l;o++){let u=(e[o]+o*o-(e[s[c]]+s[c]*s[c]))/(2*o-2*s[c]);for(;u<=a[c];)c--,u=(e[o]+o*o-(e[s[c]]+s[c]*s[c]))/(2*o-2*s[c]);c++,s[c]=o,a[c]=u,a[c+1]=+Xe}for(let o=0,c=0;o<l;o++){for(;a[c+1]<o;)c++;i[o]=(o-s[c])*(o-s[c])+e[s[c]]}}}var Tt=y(69425);function Fe(f){return f&&"static"===f.type}class ct{constructor(e,i,s=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,this._pageWidth=e,this._pageHeight=i,s>0&&(this._maxItemSize=s),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new Ke(this._pageWidth,this._pageHeight);const a=Math.floor(this._pageWidth),l=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*l)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}getHeight(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}getPageTexture(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}has(e){return this._mosaicRects.has(e)}get itemCount(){return this._mosaicRects.size}getSpriteItem(e){return this._mosaicRects.get(e)}addSpriteItem(e,i,s,a,l,o,c=1){if(this._mosaicRects.has(e))return this._mosaicRects.get(e);let u,h,m;if(Fe(s)?[u,h,m]=this._allocateImage(i[0],i[1]):(u=new ye.Z(0,0,i[0],i[1]),h=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:s,size:[i[0]+2*b.s4,i[1]+2*b.s4],dirty:!0,texture:void 0})),u.width<=0||u.height<=0)return null;const g={type:"sprite",rect:u,width:i[0],height:i[1],sdf:l,simplePattern:o,rasterizationScale:c,page:h};return this._mosaicRects.set(e,g),Fe(s)&&((0,ce.Z)("esri-mosaic-debug")&&this._showDebugSprite(i,s.data),this._copy({rect:u,spriteSize:i,spriteData:s.data,page:h,pageSize:m,repeat:a,sdf:l})),g}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const e=this._spriteCopyQueue.pop();e&&this._copy(e)}getMosaicItemPosition(e){const i=this.getSpriteItem(e),s=i?.rect;if(!s)return null;s.width=i.width,s.height=i.height;const o=b.s4,c=this._mosaicPages[i.page].size;return{size:[i.width,i.height],tl:[(s.x+o)/c[0],(s.y+o)/c[1]],br:[(s.x+o+i.width)/c[0],(s.y+o+i.height)/c[1]],page:i.page}}bind(e,i,s=0,a=0){const l=this._mosaicPages[s],o=l.mosaicsData;let c=l.texture;c||(c=Et(e,l.size),l.texture=c),c.setSamplingMode(i),Fe(o)?(e.bindTexture(c,a),l.dirty&&(c.setData(new Uint8Array(o.data.buffer)),c.generateMipmap(),(0,ce.Z)("esri-mosaic-debug")&&this._showDebugPage(s))):(o.data.loadFrame(c),e.bindTexture(c,a),c.generateMipmap()),l.dirty=!1}getTexture(e,i=0){const s=this._mosaicPages[i],a=s.mosaicsData;let l=s.texture;return l||(l=Et(e,s.size),s.texture=l),Fe(a)?s.dirty&&(l.setData(new Uint8Array(a.data.buffer)),l.generateMipmap(),(0,ce.Z)("esri-mosaic-debug")&&this._showDebugPage(i)):(a.data.loadFrame(l),l.generateMipmap()),s.dirty=!1,l}dispose(){this._binPack=null;for(const e of this._mosaicPages){const i=e.texture;i&&i.dispose();const s=e.mosaicsData;Fe(s)||s.data.destroy()}this._mosaicPages=null,this._mosaicRects.clear()}static _copyBits(e,i,s,a,l,o,c,u,h,m,g){let w=a*i+s,S=u*o+c;if(g){S-=o;for(let C=-1;C<=m;C++,w=((C+m)%m+a)*i+s,S+=o)for(let O=-1;O<=h;O++)l[S+O]=e[w+(O+h)%h]}else for(let C=0;C<m;C++){for(let O=0;O<h;O++)l[S+O]=e[w+O];w+=i,S+=o}}_copy(e){if(e.page>=this._mosaicPages.length)return;const i=this._mosaicPages[e.page],s=i.mosaicsData;if(!Fe(i.mosaicsData))throw new _e.Z("mapview-invalid-resource","unsuitable data type!");ct._copyBits(e.spriteData,e.spriteSize[0],0,0,s.data,e.pageSize[0],e.rect.x+b.s4,e.rect.y+b.s4,e.spriteSize[0],e.spriteSize[1],e.repeat),i.dirty=!0}_allocateImage(e,i){e+=2*b.s4,i+=2*b.s4;const s=Math.max(e,i);if(this._maxItemSize&&this._maxItemSize<s){const l=2**Math.ceil((0,Tt.k3)(e)),o=2**Math.ceil((0,Tt.k3)(i)),c=new ye.Z(0,0,e,i);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(l*o)},size:[l,o],dirty:!0,texture:void 0}),[c,this._mosaicPages.length-1,[l,o]]}const a=this._binPack.allocate(e,i);if(a.width<=0){const l=this._mosaicPages[this._currentPage];return!l.dirty&&Fe(l.mosaicsData)&&(l.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new Ke(this._pageWidth,this._pageHeight),this._allocateImage(e,i)}return[a,this._currentPage,[this._pageWidth,this._pageHeight]]}_showDebugSprite([e,i],s){const a=document.createElement("canvas");a.width=e,a.height=i,a.setAttribute("style",`position: absolute; top: ${4+204*gr++}px; right: 208px; width: 200px; height: 200px; border: 1px solid black;`);const l=a.getContext("2d"),o=new ImageData(e,i);o.data.set(new Uint8Array(s.buffer)),l.putImageData(o,0,0),document.body.appendChild(a)}_showDebugPage(e){const i=this._mosaicPages[e],{size:[s,a],mosaicsData:l}=i;if(!Fe(l))return;const o=`mosaicDebugPage${e}`,c=document.getElementById(o)??document.createElement("canvas");c.id=o,c.width=s,c.height=a,c.setAttribute("style",`position: absolute; top: ${4+204*e}px; right: 4px; width: 200px; height: 200px; border: 1px solid black;`);const u=c.getContext("2d"),h=new ImageData(s,a);h.data.set(new Uint8Array(l.data.buffer)),u.putImageData(h,0,0),document.body.appendChild(c)}}let gr=0;function Et(f,e){const i=new oe.X;return i.width=e[0],i.height=e[1],i.wrapMode=x.e8.CLAMP_TO_EDGE,new Ce.x(f,i,null)}var ht=y(32196),_r=y(23306);class vr{constructor(e,i,s,a){this._animation=e,this._frameData=null,this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=(0,_r.hY)(this._animation,s,a,o=>{this._frameData=o,i.requestRender()})}destroy(){this._playHandle.remove()}loadFrame(e){const i=this._frameData;null!=i&&(e.updateData(0,b.s4,b.s4,"width"in i?i.width:i.codedWidth,"height"in i?i.height:i.codedHeight,i),this._frameData=null)}}var yr=y(96214);const Rt="arial-unicode-ms-regular",Ae=(f,e,i)=>ve.Z.getLogger("esri.views.2d.engine.webgl.TextureManager").error(new _e.Z(f,e,i));class ut{static fromMosaic(e,i){return new ut(e,i.page,i.sdf)}constructor(e,i,s){this.mosaicType=e,this.page=i,this.sdf=s}}class xr{constructor(e){var i;this._requestRender=e,this._resourceManager=new rr.Z,this._invalidFontsMap=new Map,this._sdfConverter=new mr(b.$0),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new yr.e({concurrency:10,process:(i=(0,Q.Z)(function*(s,a){(0,Se.k_)(a);try{return yield(0,We.Z)(s,{responseType:"image",signal:a})}catch(l){throw(0,Se.D_)(l)?l:new _e.Z("mapview-invalid-resource",`Could not fetch requested resource at ${s}`,l)}}),function(a,l){return i.apply(this,arguments)})}),this._spriteMosaic=new ct(2048,2048,500),this._glyphSource=new fr(`${er.default.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new ur(1024,1024,this._glyphSource),this._rasterizer=new ar(this.resourceManager)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null,this._resourceManager.destroy()}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}get resourceManager(){return this._resourceManager}rasterizeItem(e,i){var s=this;return(0,Q.Z)(function*(){if(null==e)return Ae("mapview-null-resource","Unable to rasterize null resource"),null;if("cim-rasterization-info"!==e.type)return Ae("mapview-unexpected-resource","Unable to rasterize resource"),null;const{resource:a}=e;if("text"===a.type){const o=yield s._rasterizeText(a,i);for(const c of o.glyphs)s._setTextureBinding(ie.Un.GLYPH,c);return o}const l=yield s._rasterizeSprite(a,i);return l&&s._setTextureBinding(ie.Un.SPRITE,l),l})()}getMosaicInfo(e,i,s=!1){const a=this._getTextureBindingInfo(e,i,s);return a?{size:a.size,texture:{texture:a.texture,unit:"sprite"===a.type?b.Kt:b.wJ}}:(Ae("mapview-invalid-resource",`Unable to find resource for ${i}`),{size:[0,0],texture:{texture:null,unit:0}})}_getTextureBindingInfo(e,i,s){const a=this._bindingInfos[i-1],l=a.page,o=s?x.cw.LINEAR_MIPMAP_LINEAR:x.cw.LINEAR;switch(a.mosaicType){case ie.Un.SPRITE:{const c=[this.sprites.getWidth(l),this.sprites.getHeight(l)],u=this._spriteMosaic.getTexture(e,l);return u.setSamplingMode(o),{type:"sprite",texture:u,size:c}}case ie.Un.GLYPH:{const c=[this.glyphs.width,this.glyphs.height],u=this._glyphMosaic.getTexture(e,l);return this._glyphMosaic.bind(e,o,l,b.wJ),u.setSamplingMode(o),{type:"glyph",texture:u,size:c}}default:return Ae("mapview-texture-manager",`Cannot handle unknown type ${a.mosaicType}`),null}}_hashMosaic(e,i){return 1|e<<1|(i.sdf?1:0)<<2|i.page<<3}_setTextureBinding(e,i){const s=this._hashMosaic(e,i);if(!this._hashToBindingIndex.has(s)){const a=ut.fromMosaic(e,i);this._hashToBindingIndex.set(s,this._bindingInfos.length+1),this._bindingInfos.push(a)}i.textureBinding=this._hashToBindingIndex.get(s)}_rasterizeText(e,i){var s=this;return(0,Q.Z)(function*(){const{font:a,textString:l}=e,o=(0,xe.Yc)(a),c=s._invalidFontsMap.has(o),[u,h]=(0,tr.E)(l),m=(0,ht.Jq)(u);try{const g=c?Rt:o;return(0,ce.Z)("esri-2d-stabilize-glyphs")&&(yield s._glyphMosaic.preloadASCIIGlyphCache(g)),{type:"glyphs",glyphs:yield s._glyphMosaic.getGlyphItems(g,m,i),isRightToLeft:h}}catch{return Ae("mapview-invalid-resource",`Couldn't find font ${o}. Falling back to Arial Unicode MS Regular`),s._invalidFontsMap.set(o,!0),{type:"glyphs",glyphs:yield s._glyphMosaic.getGlyphItems(Rt,m,i),isRightToLeft:h}}})()}_hashSpriteResource(e){switch(e.type){case"path":return`path:${e.path}.${e.asFill?1:0}`;case"CIMPictureMarker":return`${e.type}:${e.url}:${e.size}`;case"CIMPictureFill":return`${e.type}:${e.url}:${e.height}`;case"CIMPictureStroke":return`${e.type}:${e.url}:${e.width}`;case"dash":return`dash:${e.capStyle}.${e.dashTemplate.join("")}`;case"sdf":return`sdf:${JSON.stringify(e.geom)}.${e.asFill?1:0}`;case"fill-style":return`fill_style:${e.style}`;case"animated":return JSON.stringify((0,ht.IS)(e));case"CIMHatchFill":case"CIMVectorMarker":return JSON.stringify(e)}}_rasterizeSprite(e,i){var s=this;return(0,Q.Z)(function*(){if(!e)return null;const a=(0,we.hP)(s._hashSpriteResource(e));if(s._spriteMosaic.has(a))return s._spriteMosaic.getSpriteItem(a);if("url"in e&&e.url||"CIMPictureFill"===e.type||"CIMPictureStroke"===e.type||"CIMPictureMarker"===e.type||"CIMVectorMarker"===e.type){const l=[];pe.B$.fetchResources({type:"CIMPointSymbol",symbolLayers:[e]},s._resourceManager,l),l.length>0&&(yield Promise.all(l))}switch(e.type){case"CIMPictureMarker":return"CIMMarkerPlacementInsidePolygon"===e.markerPlacement?.type?s._rasterizeJSONResource(a,e):s._handleAsyncResource(a,e,i);case"animated":case"CIMPictureFill":case"CIMPictureStroke":case"path":return s._handleAsyncResource(a,e,i);case"sdf":case"dash":case"fill-style":case"CIMVectorMarker":case"CIMHatchFill":return s._rasterizeJSONResource(a,e)}})()}_rasterizeJSONResource(e,i){const s=this._rasterizer.rasterizeJSONResource(i);if(s){const{size:a,image:l,sdf:o,simplePattern:c,rasterizationScale:u}=s;return this._addItemToMosaic(e,a,{type:"static",data:l},Qe(i),o,c,u)}return null}_handleAsyncResource(e,i,s){var a=this;return(0,Q.Z)(function*(){if(a._ongoingRasterizations.has(e))return a._ongoingRasterizations.get(e);let l;return l="path"===i.type?a._handleSVG(i,e,s):a._handleImage(i,e,s),a._ongoingRasterizations.set(e,l),l.finally(()=>a._ongoingRasterizations.delete(e)),l})()}_handleSVG(e,i,s){var a=this;return(0,Q.Z)(function*(){const l=[b.$0,b.$0],{asFill:o}=e,c=yield a._sdfConverter.draw(e.path,o,s);return a._addItemToMosaic(i,l,{type:"static",data:new Uint32Array(c.buffer)},!1,!0,!0)})()}_handleGIFOrPNG(e,i,s){var a=this;return(0,Q.Z)(function*(){const o=a.resourceManager.getResource(e.url);if(null==o)return null;const{width:c,height:u}=o;if(o instanceof HTMLImageElement){if("animated"===e.type)return Ae("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;const S="colorSubstitutions"in e?e.colorSubstitutions:void 0,{size:C,sdf:O,image:T}=a._rasterizer.rasterizeImageResource(c,u,o,S);return a._addItemToMosaic(i,C,{type:"static",data:T},Qe(e),O,!1)}let h,m,g;"animated"===e.type?(h=!1,m={playAnimation:e.playAnimation,reverseAnimation:e.reverseAnimation,randomizeStartTime:e.randomizeStartTime,randomizeStartSeed:e.randomizeStartSeed,startTimeOffset:e.startTimeOffset,duration:e.duration,repeatType:e.repeatType,repeatDelay:e.repeatDelay},g=e.startGroup||0):(h=Qe(e),m={},g=0);const w=new vr(o,a._requestRender,m,g);return a._addItemToMosaic(i,[w.width,w.height],{type:"animated",data:w},h,!1,!1)})()}_handleImage(e,i,s){var a=this;return(0,Q.Z)(function*(){const l=e.url;if(wr(l)||Or(l))return a._handleGIFOrPNG(e,i,s);if("animated"===e.type)return Ae("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;try{let o;const c=a.resourceManager.getResource(l);if(null!=c&&c instanceof HTMLImageElement)o=c;else{const{data:C}=yield a._imageRequestQueue.push(l,{...s});o=C}if((0,ht.TB)(l))if("width"in e&&"height"in e)o.width=(0,de.F2)(e.width),o.height=(0,de.F2)(e.height);else if("cim"in e){const C=e;o.width=(0,de.F2)(C.width??C.scaleX*C.size),o.height=(0,de.F2)(C.size)}if(!o.width||!o.height)return null;const u=o.width,h=o.height,m="colorSubstitutions"in e?e.colorSubstitutions:void 0,{size:g,sdf:w,image:S}=a._rasterizer.rasterizeImageResource(u,h,o,m);return a._addItemToMosaic(i,g,{type:"static",data:S},Qe(e),w,!1)}catch(o){throw(0,Se.D_)(o)?o:new _e.Z("mapview-invalid-resource",`Could not fetch requested resource at ${l}. ${o.message}`)}})()}_addItemToMosaic(e,i,s,a,l,o,c){return this._spriteMosaic.addSpriteItem(e,i,s,a,l,o,c)}}function Qe(f){switch(f.type){case"CIMVectorMarker":case"CIMPictureMarker":return Pr(f);default:return!0}}const wr=f=>f&&(f.includes(".gif")||(f=>null!=f&&f.startsWith("data:image/gif"))(f)),Or=f=>f&&(f.includes(".png")||(f=>null!=f&&f.startsWith("data:image/png"))(f)),Pr=f=>f&&"markerPlacement"in f&&f.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===f.markerPlacement.type;class Cr{constructor(e){this._queue=[],this._refreshable=e}destroy(){this._queue=[]}enqueueTextureUpdate(e,i){const s=(0,Se.hh)(),a=e,l=b.Uz,o=Math.ceil(a.height/l);(0,Se.k_)(i);for(let c=0;c<o;c++){const h=c===o-1;this._queue.push({type:"chunk",request:e,resolver:s,chunk:c,chunkOffset:c*l,destHeight:h?a.height-l*c:l,chunkIsLast:h,options:i})}return(0,Se.$F)(i,c=>s.reject(c)),s.promise}upload(){let e=0;for(;this._queue.length;){const i=performance.now(),s=this._queue.shift();if(s){if(null!=s.options.signal&&s.options.signal.aborted)continue;switch(s.type){case"chunk":this._uploadChunk(s);break;case"no-chunk":this._uploadNoChunk(s)}const a=performance.now()-i;if(e+=a,e+a>=b.NG)break}}this._queue.length&&this._refreshable.requestRender()}_uploadChunk(e){const{request:i,resolver:s,chunkOffset:a,chunkIsLast:l,destHeight:o}=e,{data:c,texture:u,width:h}=i;null!=c&&(u.updateData(0,0,a,h,o,c,a),l&&s.resolve())}_uploadNoChunk(e){const{request:i,resolver:s}=e,{data:a,texture:l}=i;l.setData(a),s.resolve()}}var Ie=y(43106),Tr=y(89612),Ze=y(92899),Er=y(89014),dt=y(43548),ft=y(73145),Rr=y(23783);const zr=(0,Er.al)(-.5,-.5);class Fr{constructor(){this._centerNdc=(0,ft.Ue)(),this._pxToNdc=(0,ft.Ue)(),this._worldDimensionsPx=(0,ft.Ue)(),this._mat3=(0,Me.Ue)(),this._initialized=!1}dispose(){this._program=(0,W.M2)(this._program),this._quad=(0,W.M2)(this._quad)}render(e,i,s){const{context:a}=e,l=this._updateGeometry(e,s);if(null!=i){const{r:o,g:c,b:u,a:h}=i;a.setClearColor(h*o/255,h*c/255,h*u/255,h)}else a.setClearColor(0,0,0,0);if(a.setStencilFunction(x.wb.ALWAYS,0,255),a.setStencilWriteMask(255),!l)return a.setClearStencil(1),void a.clear(a.gl.STENCIL_BUFFER_BIT|a.gl.COLOR_BUFFER_BIT);a.setClearStencil(0),a.clear(a.gl.STENCIL_BUFFER_BIT|a.gl.COLOR_BUFFER_BIT),this._initialized||this._initialize(a),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1),a.setColorMask(!1,!1,!1,!1),a.setBlendingEnabled(!1),a.setStencilOp(x.xS.KEEP,x.xS.KEEP,x.xS.REPLACE),a.setStencilFunction(x.wb.ALWAYS,1,255),a.setStencilTestEnabled(!0),a.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind()}_initialize(e){if(this._initialized)return;const i=(0,Je.H)(e,Rr.H);i&&(this._program=i,this._quad=new Ie.Z(e,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(e,i){const{state:s,pixelRatio:a}=e,{size:l,rotation:o}=s,c=Math.round(l[0]*a),u=Math.round(l[1]*a);if(!s.spatialReference.isWrappable)return!1;const h=(0,Tr.c$)(o),m=Math.abs(Math.cos(h)),g=Math.abs(Math.sin(h)),w=Math.round(c*m+u*g),S=Math.round(a*s.worldScreenWidth);if(w<=S)return!1;const O=(i.left-i.right)*a/c,T=(i.bottom-i.top)*a/u;(0,dt.s)(this._worldDimensionsPx,S,c*g+u*m,1),(0,dt.s)(this._pxToNdc,2/c,-2/u,1),(0,dt.s)(this._centerNdc,O,T,1);const R=this._mat3;return(0,Ze.vc)(R,this._centerNdc),(0,Ze.bA)(R,R,this._pxToNdc),0!==o&&(0,Ze.U1)(R,R,h),(0,Ze.bA)(R,R,this._worldDimensionsPx),(0,Ze.Iu)(R,R,zr),!0}}class qe{constructor(){this.name=this.constructor.name}createOptions(e,i){return null}}class Ir extends qe{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(e,i){if(!i?.size)return;const{context:s,renderingOptions:a}=e;this._quad||(this._quad=new Ie.Z(s,[0,0,1,0,0,1,1,1]));const l=s.getBoundFramebufferObject(),{x:o,y:c,width:u,height:h}=s.getViewport(),m=i.getBlock(b.wi.Animation);if(null==m)return;const g=i.getUniforms(s);s.setViewport(0,0,i.size,i.size);const w=g.filterFlags,S=g.animation,C=(0,ce.Z)("featurelayer-animation-enabled")?a.labelsAnimationTime:1,O=m.getFBO(s,1);s.unbindTexture(O.colorTexture),this._computeDelta(e,O,S,w,C);const T=m.getFBO(s);s.unbindTexture(T.colorTexture),this._updateAnimationState(e,O,T),s.bindFramebuffer(l),s.setViewport(o,c,u,h)}_computeDelta(e,i,s,a,l){const{context:o,painter:c,displayLevel:u}=e,h=c.materialManager.getProgram(this._desc,["delta"]);if(o.bindFramebuffer(i),o.setColorMask(!0,!0,!0,!0),o.setClearColor(0,0,0,0),o.clear(o.gl.COLOR_BUFFER_BIT),o.useProgram(h),!("type"in a.texture)||!("type"in s.texture))throw new Error("InternalError: Expected to find texture");o.bindTexture(a.texture,a.unit),o.bindTexture(s.texture,s.unit),h.setUniform1i("u_maskTexture",a.unit),h.setUniform1i("u_sourceTexture",s.unit),h.setUniform1f("u_timeDelta",e.deltaTime),h.setUniform1f("u_animationTime",l),h.setUniform1f("u_zoomLevel",Math.round(10*u)),this._quad.draw()}_updateAnimationState(e,i,s){const{context:a,painter:l}=e,o=l.materialManager.getProgram(this._desc,["update"]);a.bindTexture(i.colorTexture,1),a.useProgram(o),o.setUniform1i("u_sourceTexture",1),a.bindFramebuffer(s),a.setColorMask(!0,!0,!0,!0),a.setClearColor(0,0,0,0),a.clear(a.gl.COLOR_BUFFER_BIT),this._quad.draw()}}var zt=y(61362);const Ft=f=>`#define ${(f=>f.replace("-","_").toUpperCase())(f)}\n`;function It(f){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:Ft(f)+(0,zt.w)("blend/blend.vert"),fragmentShader:Ft(f)+(0,zt.w)("blend/blend.frag")}}}const Bt=()=>ve.Z.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class Ar{constructor(){this._size=[0,0]}dispose(e){this._backBufferTexture=(0,W.M2)(this._backBufferTexture),this._quad=(0,W.M2)(this._quad)}draw(e,i,s,a,l){const{context:o,drawPhase:c}=e;if(this._setupShader(o),a&&"normal"!==a&&c!==ie.jx.LABEL)return void this._drawBlended(e,i,s,a,l);const u=It("normal"),h=o.programCache.acquire(u.shaders.vertexShader,u.shaders.fragmentShader,u.attributes);if(!h)return void Bt().error(new _e.Z("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));o.useProgram(h),i.setSamplingMode(s),o.bindTexture(i,0),h.setUniform1i("u_layerTexture",0),h.setUniform1f("u_opacity",l),o.setBlendingEnabled(!0),o.setBlendFunction(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA);const m=this._quad;m.draw(),m.unbind(),h.dispose()}_drawBlended(e,i,s,a,l){const{context:o,state:c,pixelRatio:u,inFadeTransition:h}=e,{size:m}=c,g=o.getBoundFramebufferObject();let w,S;null!=g?(w=g.width,S=g.height):(w=Math.round(u*m[0]),S=Math.round(u*m[1])),this._createOrResizeTexture(e,w,S);const C=this._backBufferTexture;g.copyToTexture(0,0,w,S,0,0,C),o.setStencilTestEnabled(!1),o.setStencilWriteMask(0),o.setBlendingEnabled(!0),o.setDepthTestEnabled(!1),o.setDepthWriteEnabled(!1);const O=It(a),T=o.programCache.acquire(O.shaders.vertexShader,O.shaders.fragmentShader,O.attributes);if(!T)return void Bt().error(new _e.Z("mapview-BlendEffect",`Error creating shader program for blend mode ${a}`));o.useProgram(T),C.setSamplingMode(s),o.bindTexture(C,0),T.setUniform1i("u_backbufferTexture",0),i.setSamplingMode(s),o.bindTexture(i,1),T.setUniform1i("u_layerTexture",1),T.setUniform1f("u_opacity",l),T.setUniform1f("u_inFadeOpacity",h?1:0),o.setBlendFunction(x.zi.ONE,x.zi.ZERO);const R=this._quad;R.draw(),R.unbind(),T.dispose(),o.setBlendFunction(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA)}_setupShader(e){this._quad||(this._quad=new Ie.Z(e,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(e,i,s){const{context:a}=e;if(null===this._backBufferTexture||i!==this._size[0]||s!==this._size[1]){if(this._backBufferTexture)this._backBufferTexture.resize(i,s);else{const l=new oe.X;l.internalFormat=x.VI.RGBA,l.wrapMode=x.e8.CLAMP_TO_EDGE,l.width=i,l.height=s,this._backBufferTexture=new Ce.x(a,l)}this._size[0]=i,this._size[1]=s}}}class At extends qe{constructor(e){super(),this.name=this.constructor.name,this.defines=[e]}dispose(){}bind({context:e,painter:i}){this._prev=e.getBoundFramebufferObject();const s=i.getFbos().effect0;e.bindFramebuffer(s),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw(e,i){const{context:s,painter:a}=e,l=a.getPostProcessingEffects(i),o=s.getBoundFramebufferObject();for(const{postProcessingEffect:c,effect:u}of l)c.draw(e,o,u);s.bindFramebuffer(this._prev),s.setStencilTestEnabled(!1),a.blitTexture(s,o.colorTexture,x.cw.NEAREST),s.setStencilTestEnabled(!0)}}var et=y(40125),kt=y(8735),Dt=y(50205);class kr{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(e,i){e.bindTexture(i,b.Zt),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",et.bM),e.bindVAO(this._resources.quadVAO),e.drawArrays(x.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}finalBlur(e,i){e.bindTexture(i,b.Zt),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",et.dl),e.bindVAO(this._resources.quadVAO),e.drawArrays(x.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}renderHighlight(e,i,s){e.bindTexture(i,b.Zt),e.useProgram(this._resources.highlightProgram),s.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA),e.drawArrays(x.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}_initialize(e,i,s){this._width=i,this._height=s;const a=ot.f.createVertex(e,x.l1.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),l=new lt.U(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new Dt.G("a_position",2,x.g.BYTE,0,4),new Dt.G("a_texcoord",2,x.g.UNSIGNED_BYTE,2,4)]},{geometry:a}),o=(0,Je.H)(e,kt.C),c=(0,Je.H)(e,kt.y);e.useProgram(o),o.setUniform1i("u_texture",b.Zt),o.setUniform1i("u_shade",b.Sf),o.setUniform1f("u_sigma",et.pW),e.useProgram(c),c.setUniform1i("u_texture",b.Zt),c.setUniform1f("u_sigma",et.pW),this._resources={quadGeometry:a,quadVAO:l,highlightProgram:o,blurProgram:c}}setup(e,i,s){this._resources?(this._width=i,this._height=s):this._initialize(e,i,s)}}var be=y(83018),pt=y(61312);function Ut(f,e,i){const s=new oe.X(e,i);return s.wrapMode=x.e8.CLAMP_TO_EDGE,new be.X(f,s,new pt.Y(x.Tg.STENCIL_INDEX8,e,i))}class Dr{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(e,i,s){this._width=i,this._height=s;const a=Ut(e,i,s),l=Ut(e,i,s);this._resources={sharedBlur1Fbo:a,sharedBlur2Fbo:l}}setup(e,i,s){!this._resources||this._width===i&&this._height===s||this.dispose(),this._resources||this._initialize(e,i,s)}get sharedBlur1Tex(){return this._resources.sharedBlur1Fbo.colorTexture}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Fbo.colorTexture}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}class Ur extends qe{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new kr,this._width=void 0,this._height=void 0,this._boundFBO=null,this._hlSurfaces=new Dr,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new wt}dispose(){this._hlSurfaces?.dispose(),this._hlRenderer?.dispose(),this._boundFBO=null}bind(e){const{context:i,painter:s}=e,{width:a,height:l}=i.getViewport(),o=s.getFbos().effect0;this.setup(e,a,l),i.bindFramebuffer(o),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:e},i,s){this._width=i,this._height=s;const a=i%4,l=s%4;s+=l<2?-l:4-l,this._adjustedWidth=i+=a<2?-a:4-a,this._adjustedHeight=s,this._boundFBO=e.getBoundFramebufferObject();const o=Math.round(1*i),c=Math.round(1*s);this._hlRenderer.setup(e,o,c),this._hlSurfaces.setup(e,o,c)}draw(e){const{context:i,passOptions:s}=e,a=s.activeGradient,l=i.getBoundFramebufferObject();i.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),i.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),i.setStencilTestEnabled(!1),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(i,l.colorTexture,x.cw.NEAREST,1),i.setStencilTestEnabled(!1),i.setBlendingEnabled(!1),i.setColorMask(!1,!1,!1,!0),i.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(i,this._hlSurfaces.sharedBlur1Tex),i.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(i,this._hlSurfaces.sharedBlur2Tex),i.bindFramebuffer(this._boundFBO),i.setBlendingEnabled(!0),i.setColorMask(!0,!0,!0,!0),i.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(i,this._hlSurfaces.sharedBlur1Tex,a),this._boundFBO=null}}class Lr extends qe{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions({pixelRatio:e},i){if(!i.length)return null;const s=i.shift(),a=s.x,l=s.y;this._outstanding=s;const o=(0,ce.Z)("esri-mobile");return{type:"hittest",distance:(o?b.wN:b.S3)*e,smallSymbolDistance:(o?b.wN:b.pd)*e,smallSymbolSizeThreshold:b.fG,position:[a,l]}}bind(e){const{context:i,attributeView:s}=e;if(!s.size)return;const a=s.getBlock(b.wi.GPGPU);if(null==a)return;const l=a.getFBO(i);i.setViewport(0,0,s.size,s.size),i.bindFramebuffer(l),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT|i.gl.DEPTH_BUFFER_BIT)}unbind(){}draw(e){if(null==this._outstanding)return;const i=this._outstanding;this._outstanding=null,this._resolve(e,i.resolvers)}_resolve(e,i){return(0,Q.Z)(function*(){const{context:s,attributeView:a}=e,l=a.getBlock(b.wi.GPGPU);if(null==l)return void i.forEach(h=>h.resolve([]));const o=l.getFBO(s),c=new Uint8Array(o.width*o.height*4);try{yield o.readPixelsAsync(0,0,o.width,o.height,x.VI.RGBA,x.Br.UNSIGNED_BYTE,c)}catch{return void i.forEach(m=>m.resolve([]))}const u=[];for(let h=0;h<c.length;h+=4)c[h]&&u.push(h/4);i.forEach(h=>h.resolve(u))})()}}const Nr=[1,0],Vr=[0,1],Gr=[1,.8,.6,.4,.2],Hr=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class Wr{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad=(0,W.M2)(this._quad),this._intensityFBO=(0,W.M2)(this._intensityFBO),this._compositeFBO=(0,W.M2)(this._compositeFBO),this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}draw(e,i,s){const{width:a,height:l}=i,{context:o,painter:c}=e,{materialManager:u}=c,h=o.gl,m=this._programDesc,{strength:g,radius:w,threshold:S}=s;this._quad||(this._quad=new Ie.Z(o,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,a,l),o.setStencilTestEnabled(!1),o.setBlendingEnabled(!0),o.setBlendFunction(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA),o.setStencilWriteMask(0);const C=this._quad;C.bind(),o.bindFramebuffer(this._intensityFBO);const O=u.getProgram(m.luminosityHighPass);o.useProgram(O),o.bindTexture(i.colorTexture,0),O.setUniform1i("u_texture",0),O.setUniform3fv("u_defaultColor",[0,0,0]),O.setUniform1f("u_defaultOpacity",0),O.setUniform1f("u_luminosityThreshold",S),O.setUniform1f("u_smoothWidth",.01);const T=[Math.round(a/2),Math.round(l/2)];o.setViewport(0,0,T[0],T[1]),o.setClearColor(0,0,0,0),o.clear(h.COLOR_BUFFER_BIT),C.draw(),o.setBlendingEnabled(!1);let R=this._intensityFBO.colorTexture;for(let G=0;G<this._nMips;G++){const X=u.getProgram(m.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[G]}]);o.useProgram(X),o.bindTexture(R,G+1),X.setUniform1i("u_colorTexture",G+1),X.setUniform2fv("u_texSize",T),X.setUniform2fv("u_direction",Nr),o.setViewport(0,0,T[0],T[1]);const V=this._mipsFBOs[G];o.bindFramebuffer(V.horizontal),C.draw(),R=V.horizontal.colorTexture,o.bindFramebuffer(V.vertical),o.bindTexture(R,G+1),X.setUniform2fv("u_direction",Vr),C.draw(),R=V.vertical.colorTexture,T[0]=Math.round(T[0]/2),T[1]=Math.round(T[1]/2)}o.setViewport(0,0,a,l);const I=u.getProgram(m.composite,[{name:"nummips",value:5}]);o.bindFramebuffer(this._compositeFBO),o.useProgram(I),I.setUniform1f("u_bloomStrength",g),I.setUniform1f("u_bloomRadius",w),I.setUniform1fv("u_bloomFactors",Gr),I.setUniform3fv("u_bloomTintColors",Hr),o.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),I.setUniform1i("u_blurTexture1",1),o.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),I.setUniform1i("u_blurTexture2",2),o.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),I.setUniform1i("u_blurTexture3",3),o.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),I.setUniform1i("u_blurTexture4",4),o.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),I.setUniform1i("u_blurTexture5",5),C.draw(),o.bindFramebuffer(i),o.setBlendingEnabled(!0);const H=u.getProgram(m.blit);o.useProgram(H),o.bindTexture(this._compositeFBO.colorTexture,6),H.setUniform1i("u_texture",6),o.setBlendFunction(x.zi.ONE,x.zi.ONE),C.draw(),C.unbind(),o.setBlendFunction(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA),o.setStencilTestEnabled(!0)}_createOrResizeResources(e,i,s){const{context:a}=e;if(this._compositeFBO&&this._size[0]===i&&this._size[1]===s)return;this._size[0]=i,this._size[1]=s;const l=[Math.round(i/2),Math.round(s/2)];if(this._compositeFBO)this._compositeFBO.resize(i,s);else{const o=new oe.X(i,s);o.internalFormat=x.VI.RGBA,o.wrapMode=x.e8.CLAMP_TO_EDGE,this._compositeFBO=new be.X(a,o)}if(this._intensityFBO)this._intensityFBO.resize(l[0],l[1]);else{const o=new oe.X(l[0],l[1]);o.internalFormat=x.VI.RGBA,o.wrapMode=x.e8.CLAMP_TO_EDGE,this._intensityFBO=new be.X(a,o)}for(let o=0;o<this._nMips;o++){if(this._mipsFBOs[o])this._mipsFBOs[o].horizontal.resize(l[0],l[1]),this._mipsFBOs[o].vertical.resize(l[0],l[1]);else{const c=new oe.X(l[0],l[1]);c.internalFormat=x.VI.RGBA,c.wrapMode=x.e8.CLAMP_TO_EDGE,this._mipsFBOs[o]={horizontal:new be.X(a,c),vertical:new be.X(a,c)}}l[0]=Math.round(l[0]/2),l[1]=Math.round(l[1]/2)}}}const Xr=[1,0],Zr=[0,1];class jr{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(e,i,s){const{context:a}=e,{type:l,radius:o}=s;if(0===o)return;this._createOrResizeResources(e),this._quad||(this._quad=new Ie.Z(a,[-1,-1,1,-1,-1,1,1,1]));const c=this._quad;c.bind(),"blur"===l?this._gaussianBlur(e,i,o):this._radialBlur(e,i),c.unbind()}_gaussianBlur(e,i,s){const{context:a,state:l,painter:o,pixelRatio:c}=e,{size:u}=l,{materialManager:h}=o,m=this._programDesc,g=this._quad,w=[Math.round(c*u[0]),Math.round(c*u[1])],S=this._blurFBO,C=h.getProgram(m.gaussianBlur,[{name:"radius",value:Math.ceil(s)}]);a.useProgram(C),a.setBlendingEnabled(!1),a.bindFramebuffer(S),a.bindTexture(i.colorTexture,4),C.setUniform1i("u_colorTexture",4),C.setUniform2fv("u_texSize",w),C.setUniform2fv("u_direction",Xr),C.setUniform1f("u_sigma",s),g.draw(),a.bindFramebuffer(i),a.setStencilWriteMask(0),a.setStencilTestEnabled(!1),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1),a.bindTexture(S?.colorTexture,5),C.setUniform1i("u_colorTexture",5),C.setUniform2fv("u_direction",Zr),g.draw(),a.setBlendingEnabled(!0),a.setBlendFunction(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0)}_radialBlur(e,i){const{context:s,painter:a}=e,{materialManager:l}=a,o=this._programDesc,c=this._quad,u=this._blurFBO;s.bindFramebuffer(u);const h=l.getProgram(o.radialBlur);s.useProgram(h),s.setBlendingEnabled(!1),s.bindTexture(i.colorTexture,4),h.setUniform1i("u_colorTexture",4),c.draw(),s.bindFramebuffer(i),s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setBlendingEnabled(!0);const m=l.getProgram(o.blit);s.useProgram(m),s.bindTexture(u?.colorTexture,5),m.setUniform1i("u_texture",5),s.setBlendFunction(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA),c.draw()}_createOrResizeResources(e){const{context:i,state:s,pixelRatio:a}=e,{size:l}=s,o=Math.round(a*l[0]),c=Math.round(a*l[1]);if(!this._blurFBO||this._size[0]!==o||this._size[1]!==c)if(this._size[0]=o,this._size[1]=c,this._blurFBO)this._blurFBO.resize(o,c);else{const u=new oe.X(o,c);u.internalFormat=x.VI.RGBA,u.wrapMode=x.e8.CLAMP_TO_EDGE,this._blurFBO=new be.X(i,u)}}}class Yr{constructor(){this._layerFBOTexture=null,this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture=(0,W.M2)(this._layerFBOTexture)}draw(e,i,s){const{width:a,height:l}=i;this._createOrResizeResources(e,a,l);const{context:o,painter:c}=e,{materialManager:u}=c,h=this._programDesc,m=this._quad,g=s.colorMatrix;m.bind();const w=this._layerFBOTexture;o.bindFramebuffer(i),i.copyToTexture(0,0,a,l,0,0,w),o.setBlendingEnabled(!1),o.setStencilTestEnabled(!1);const S=u.getProgram(h);o.useProgram(S),o.bindTexture(w,2),S.setUniformMatrix4fv("u_coefficients",g),S.setUniform1i("u_colorTexture",2),m.draw(),o.setBlendingEnabled(!0),o.setBlendFunction(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA),o.setStencilTestEnabled(!0),m.unbind()}_createOrResizeResources(e,i,s){const{context:a}=e;if(!this._layerFBOTexture||this._size[0]!==i||this._size[1]!==s){if(this._size[0]=i,this._size[1]=s,this._layerFBOTexture)this._layerFBOTexture.resize(i,s);else{const l=new oe.X;l.internalFormat=x.VI.RGBA,l.wrapMode=x.e8.CLAMP_TO_EDGE,l.width=i,l.height=s,this._layerFBOTexture=new Ce.x(a,l)}this._quad||(this._quad=new Ie.Z(a,[-1,-1,1,-1,-1,1,1,1]))}}}const $r=[1,0],Jr=[0,1];class Kr{constructor(){this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture=(0,W.M2)(this._layerFBOTexture),this._horizontalBlurFBO=(0,W.M2)(this._horizontalBlurFBO),this._verticalBlurFBO=(0,W.M2)(this._verticalBlurFBO)}draw(e,i,s){const{context:a,state:l,painter:o}=e,{materialManager:c}=o,u=this._programDesc,h=i.width,m=i.height,g=[Math.round(h),Math.round(m)],{blurRadius:w,offsetX:S,offsetY:C,color:O}=s,T=[(0,de.F2)(S),(0,de.F2)(C)];this._createOrResizeResources(e,h,m,g);const R=this._horizontalBlurFBO,I=this._verticalBlurFBO;a.setStencilWriteMask(0),a.setStencilTestEnabled(!1),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1);const H=this._layerFBOTexture;i.copyToTexture(0,0,h,m,0,0,H),this._quad||(this._quad=new Ie.Z(a,[-1,-1,1,-1,-1,1,1,1])),a.setViewport(0,0,g[0],g[1]);const G=this._quad;G.bind(),a.setBlendingEnabled(!1);const X=c.getProgram(u.blur,[{name:"radius",value:Math.ceil(w)}]);a.useProgram(X),a.bindFramebuffer(R),a.bindTexture(i.colorTexture,4),X.setUniform1i("u_colorTexture",4),X.setUniform2fv("u_texSize",g),X.setUniform2fv("u_direction",$r),X.setUniform1f("u_sigma",w),G.draw(),a.bindFramebuffer(I),a.bindTexture(R?.colorTexture,5),X.setUniform1i("u_colorTexture",5),X.setUniform2fv("u_direction",Jr),G.draw(),a.bindFramebuffer(i),a.setViewport(0,0,h,m);const V=c.getProgram(u.composite);a.useProgram(V),a.bindTexture(I?.colorTexture,2),V.setUniform1i("u_blurTexture",2),a.bindTexture(H,3),V.setUniform1i("u_layerFBOTexture",3),V.setUniform4fv("u_shadowColor",[O[3]*(O[0]/255),O[3]*(O[1]/255),O[3]*(O[2]/255),O[3]]),V.setUniformMatrix3fv("u_displayViewMat3",l.displayMat3),V.setUniform2fv("u_shadowOffset",T),G.draw(),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!0),a.setBlendFunction(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA),G.unbind()}_createOrResizeResources(e,i,s,a){const{context:l}=e;if(!this._horizontalBlurFBO||this._size[0]!==i||this._size[1]!==s){if(this._size[0]=i,this._size[1]=s,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(a[0],a[1]);else{const o=new oe.X(a[0],a[1]);o.internalFormat=x.VI.RGBA,o.wrapMode=x.e8.CLAMP_TO_EDGE,this._horizontalBlurFBO=new be.X(l,o)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(a[0],a[1]);else{const o=new oe.X(a[0],a[1]);o.internalFormat=x.VI.RGBA,o.wrapMode=x.e8.CLAMP_TO_EDGE,this._verticalBlurFBO=new be.X(l,o)}if(this._layerFBOTexture)this._layerFBOTexture.resize(i,s);else{const o=new oe.X;o.internalFormat=x.VI.RGBA,o.wrapMode=x.e8.CLAMP_TO_EDGE,o.width=i,o.height=s,this._layerFBOTexture=new Ce.x(l,o)}}}}class Qr{constructor(){this._size=[0,0],this._layerFBOTexture=null}dispose(){this._layerFBOTexture=(0,W.M2)(this._layerFBOTexture)}draw(e,i,s){const{width:a,height:l}=i;this._createOrResizeResources(e,a,l);const{context:o,painter:c}=e,{amount:u}=s,h=o.gl,m=this._layerFBOTexture;o.bindFramebuffer(i),i.copyToTexture(0,0,a,l,0,0,m),o.setBlendingEnabled(!0),o.setStencilTestEnabled(!1),o.setDepthTestEnabled(!1),o.setClearColor(0,0,0,0),o.clear(h.COLOR_BUFFER_BIT),c.blitTexture(o,m,x.cw.NEAREST,u)}_createOrResizeResources(e,i,s){const{context:a}=e;if(!this._layerFBOTexture||this._size[0]!==i||this._size[1]!==s)if(this._size[0]=i,this._size[1]=s,this._layerFBOTexture)this._layerFBOTexture.resize(i,s);else{const l=new oe.X;l.internalFormat=x.VI.RGBA,l.wrapMode=x.e8.CLAMP_TO_EDGE,l.samplingMode=x.cw.NEAREST,l.width=i,l.height=s,this._layerFBOTexture=new Ce.x(a,l)}}}function qr(f){switch(f){case"bloom":case"blur":case"opacity":case"drop-shadow":return f;default:return"colorize"}}const ei={colorize:()=>new Yr,blur:()=>new jr,bloom:()=>new Wr,opacity:()=>new Qr,"drop-shadow":()=>new Kr};class ti{constructor(){this._effectMap=new Map}dispose(){this._effectMap.forEach(e=>e.dispose()),this._effectMap.clear()}getPostProcessingEffects(e){if(!e||0===e.length)return[];const i=[];for(const s of e){const a=qr(s.type);let l=this._effectMap.get(a);l||(l=ei[a](),this._effectMap.set(a,l)),i.push({postProcessingEffect:l,effect:s})}return i}}var ri=y(57678);class ii{constructor(e,i){this.brushes=e,this.name=i.name,this.drawPhase=i.drawPhase||ie.jx.MAP,this._targetFn=i.target,this.effects=i.effects||[],this.enableDefaultDraw=i.enableDefaultDraw??(()=>!0),this.forceDrawByDisplayOrder=!!i.forceDrawByDisplayOrder}render(e){const{context:i,profiler:s}=e,a=this._targetFn(),l=this.drawPhase&e.drawPhase;if(s.recordPassStart(this.name),l){this.enableDefaultDraw()&&this._doRender(e,a),s.recordPassEnd();for(const o of this.effects){if(!o.enable())continue;const c=o.apply,u=o.args?.(),h=i.getViewport(),m=i.getBoundFramebufferObject(),g=e.passOptions;this._bindEffect(e,c,u),this._doRender(e,a,c.defines),this._drawAndUnbindEffect(e,c,h,m,g,u)}}}_doRender(e,i,s){if(null==i)return;const{profiler:a,context:l}=e;for(const o of this.brushes){if(a.recordBrushStart(o.name),null!=o.brushEffect){const c=l.getViewport(),u=l.getBoundFramebufferObject(),h=e.passOptions;this._bindEffect(e,o.brushEffect),this._drawWithBrush(o,e,i,s),this._drawAndUnbindEffect(e,o.brushEffect,c,u,h)}else this._drawWithBrush(o,e,i,s);a.recordBrushEnd()}}_drawWithBrush(e,i,s,a){(0,ri.zG)(s)?(e.prepareState(i,a),e.drawMany(i,s,a)):s.visible&&(e.prepareState(i,a),e.draw(i,s,a))}_bindEffect(e,i,s){const{profiler:a}=e;a.recordPassStart(this.name+"."+i.name),i.bind(e,s);const l=i.createOptions(e,s);e.passOptions=l}_drawAndUnbindEffect(e,i,s,a,l,o){const{profiler:c,context:u}=e;e.passOptions=l,c.recordBrushStart(i.name),i.draw(e,o),i.unbind(e,o),u.bindFramebuffer(a);const{x:h,y:m,width:g,height:w}=s;u.setViewport(h,m,g,w),c.recordBrushEnd(),c.recordPassEnd()}}class Lt{constructor(){this._programCache=new Map}destroy(){for(const e of this._programCache.values())e.destroy();this._programCache.clear()}getProgram(e,i,s,a,l){const o=e.getShaderKey(i,s,a,l);let c=this._programCache.get(o);return c||(c=e.getProgram(i,s,a,l),this._programCache.set(o,c)),c}}var si=y(19170);class ai{constructor(e,i){this.context=e,this._currentPipelineStateNeedsUpdate=!1,this._blitRenderer=new wt,this._worldExtentRenderer=new Fr,this._brushCache=new Map,this._lastWidth=null,this._lastHeight=null,this._vtlMaterialManager=new Kt,this._blendEffect=new Ar,this._stencilBuf=null,this._prevBeforeLayerFBOStack=[],this._fboPool=[],this.effects={highlight:new Ur,hittest:new Lr,integrate:new Ir,insideEffect:new At("inside"),outsideEffect:new At("outside")},this._programCache=new Lt,this._shaderState={shader:null,uniforms:null,defines:null,optionalAttributes:null,useComputeBuffer:!1},this.materialManager=new qt(e),this.textureManager=new xr(i),this.textureUploadManager=new Cr(i),this._effectsManager=new ti,this._quadMesh=new Ie.Z(e,[0,0,1,0,0,1,1,1])}dispose(){if(this._programCache.destroy(),this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=(0,W.M2)(this._blitRenderer),this._worldExtentRenderer=(0,W.M2)(this._worldExtentRenderer),this._quadMesh.dispose(),this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache.clear(),this._brushCache=null),this._fbos){let e;for(e in this._fbos)this._fbos[e]&&this._fbos[e].dispose()}for(const e of this._fboPool)e.dispose();if(this._fboPool.length=0,this.effects){let e;for(e in this.effects)this.effects[e]&&this.effects[e].dispose()}this._effectsManager.dispose(),this._blendEffect.dispose(this.context),this._vtlMaterialManager=(0,W.M2)(this._vtlMaterialManager)}clearShaderCache(){this._programCache.destroy(),this._programCache=new Lt}get blitRenderer(){return this._blitRenderer}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getFbos(){if(!this._fbos)throw new Error("InternalError: Painter FBOs not initialized");return this._fbos}acquireFbo(e,i){let s;if(this._fboPool.length>0)s=this._fboPool.pop();else{const a=new oe.X(e,i);a.samplingMode=x.cw.NEAREST,a.wrapMode=x.e8.CLAMP_TO_EDGE,s=new be.X(this.context,a,this._stencilBuf)}return s.width===e&&s.height===i||s.resize(e,i),s}releaseFbo(e){this._fboPool.push(e)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderPhases(e,i,s){const{context:a}=e;this._worldExtentRenderer.render(e,i,s);const{width:l,height:o}=a.getViewport();if(this.updateFBOs(l,o),this._prevFBO=a.getBoundFramebufferObject(),a.bindFramebuffer(this.getFbos().output),a.setColorMask(!0,!0,!0,!0),null!=i){const{r:c,g:u,b:h,a:m}=i;a.setClearColor(m*c/255,m*u/255,m*h/255,m)}else a.setClearColor(0,0,0,0);a.setDepthWriteEnabled(!0),a.setClearDepth(1),a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT),a.setDepthWriteEnabled(!1)}afterRenderPhases(e){const{context:i}=e;i.bindFramebuffer(this._prevFBO),i.setStencilFunction(x.wb.EQUAL,1,255),i.setStencilTestEnabled(!0),i.setDepthTestEnabled(!1),this.blitTexture(i,this.getFbos().output.colorTexture,x.cw.NEAREST)}beforeRenderLayer(e,i,s){const{context:a,blendMode:l,effects:o,drawPhase:c,requireFBO:u}=e;if(u||Nt(c,l,o,s)){const h=a.getBoundFramebufferObject();this._prevBeforeLayerFBOStack.push(h);const{width:m,height:g}=a.getViewport(),w=this.acquireFbo(m,g);a.bindFramebuffer(w),a.setColorMask(!0,!0,!0,!0),a.setClearColor(0,0,0,0),a.setDepthWriteEnabled(!0),a.setClearDepth(1),a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT),a.setDepthWriteEnabled(!1)}a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1),a.setStencilTestEnabled(!0),a.setClearStencil(i),a.setStencilWriteMask(255),a.clear(a.gl.STENCIL_BUFFER_BIT)}afterRenderLayer(e,i){const{context:s,blendMode:a,effects:l,requireFBO:o,drawPhase:c}=e;if(o||Nt(c,a,l,i)){const u=s.getBoundFramebufferObject();null!=l&&l.length>0&&c===ie.jx.MAP&&(s.setColorMask(!0,!0,!0,!0),this._applyEffects(e,l,u)),s.bindFramebuffer(this._prevBeforeLayerFBOStack.pop()),s.setStencilTestEnabled(!1),s.setStencilWriteMask(0),s.setBlendingEnabled(!0),s.setBlendFunctionSeparate(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA,x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA),s.setColorMask(!0,!0,!0,!0),this._blendEffect.draw(e,u.colorTexture,x.cw.NEAREST,null==a||c===ie.jx.HIGHLIGHT?"normal":a,i),this.releaseFbo(u)}}renderObject(e,i,s,a){const l=_.U[s];if(!l)return;let o=this._brushCache.get(l);void 0===o&&(o=new l,this._brushCache.set(l,o)),o.prepareState(e),o.draw(e,i,a)}renderObjects(e,i,s,a){const l=_.U[s];if(!l)return;let o=this._brushCache.get(l);void 0===o&&(o=new l,this._brushCache.set(l,o)),o.drawMany(e,i,a)}registerRenderPass(e){const i=e.brushes.map(s=>(this._brushCache.has(s)||this._brushCache.set(s,new s),this._brushCache.get(s)));return new ii(i,e)}blitTexture(e,i,s,a=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA,x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,i,s,a),this._currentPipelineStateNeedsUpdate=!0}getPostProcessingEffects(e){return this._effectsManager.getPostProcessingEffects(e)}updateFBOs(e,i){if(e!==this._lastWidth||i!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=i,this._fbos){let l;for(l in this._fbos)this._fbos[l].resize(e,i);return}const s=new oe.X(e,i);s.samplingMode=x.cw.NEAREST,s.wrapMode=x.e8.CLAMP_TO_EDGE;const a=new pt.Y(x.Tg.DEPTH_STENCIL,e,i);this._stencilBuf=new si.r(this.context,a),this._fbos={output:new be.X(this.context,s,this._stencilBuf),effect0:new be.X(this.context,s,this._stencilBuf)}}}_applyEffects(e,i,s){const{context:a}=e,l=this._effectsManager.getPostProcessingEffects(i);for(const{postProcessingEffect:o,effect:c}of l)a.bindFramebuffer(s),o.draw(e,s,c);this._currentPipelineStateNeedsUpdate=!0}setShader(e){this._shaderState.shader=e.shader,this._shaderState.uniforms=e.uniforms,this._shaderState.defines=e.defines,this._shaderState.optionalAttributes=e.optionalAttributes,this._shaderState.useComputeBuffer=e.useComputeBuffer??!1}setPipelineState(e){e!==this._currentPipelineState&&(this._currentPipelineState=e,this._currentPipelineStateNeedsUpdate=!0)}submitDraw(e,i){const{shader:s,uniforms:a,defines:l,optionalAttributes:o}=this._shaderState,c=e.context,u=i.getAttributePrecisionPackFactors(),h=this._programCache.getProgram(s,u,a,l??{},o??{});return h.setUniforms(a),h.bind(c),this.updatePipelineState(c),this.setStencilRef(c,i),i.draw(e,s.locationInfo),h.cleanupTemporaryTextures(),{vertexShader:h.vertexShader,fragmentShader:h.fragmentShader}}submitDrawQuad(e){const{shader:i,uniforms:s,defines:a,optionalAttributes:l}=this._shaderState,o=this._programCache.getProgram(i,{},s,a??{},l??{});o.setUniforms(s),o.bind(e),this.updatePipelineState(e),this._quadMesh.draw(),e.bindVAO(null),o.cleanupTemporaryTextures()}submitDrawMesh(e,i,s){const{shader:a,uniforms:l,defines:o,optionalAttributes:c}=this._shaderState,u=this._programCache.getProgram(a,{},l,o??{},c??{});if(u.setUniforms(l),u.bind(e),this.updatePipelineState(e),s)for(const h of s)i.bind(e,h),i.draw(e);else for(let h=0;h<i.parts.length;h++)i.bind(e,h),i.draw(e);i.unbind(e),u.cleanupTemporaryTextures()}updatePipelineState(e){this._currentPipelineStateNeedsUpdate&&(this._currentPipelineStateNeedsUpdate=!1,this._updatePipelineState(e))}_updatePipelineState(e){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{color:i,depth:s,stencil:a}=this._currentPipelineState;if(i){const{blendMode:l,write:o}=i;switch(e.setColorMask(...o),e.setBlendingEnabled(!0),e.setBlendEquation(x.db.ADD),l){case"composite":e.setBlendFunctionSeparate(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA,x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA);break;case"additive":e.setBlendFunctionSeparate(x.zi.ONE,x.zi.ONE,x.zi.ONE,x.zi.ONE);break;case"custom":{const{blendParameters:c}=i,{dstAlpha:u,dstRGB:h,srcAlpha:m,srcRGB:g}=c;e.setBlendFunctionSeparate(g,h,m,u);break}case"delete":e.setBlendEquation(x.db.REVERSE_SUBTRACT),e.setBlendFunctionSeparate(x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA,x.zi.ONE,x.zi.ONE_MINUS_SRC_ALPHA)}}if(s){const{test:l,write:o}=s;o?(e.setDepthWriteEnabled(!0),e.setDepthRange(o.zNear,o.zFar)):e.setDepthWriteEnabled(!1),l?(e.setDepthTestEnabled(!0),e.setDepthFunction(l)):e.setDepthTestEnabled(!1)}else e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1);if(a){const{test:l,write:o}=a;if(l){const{compare:c,mask:u,op:h,ref:m}=l;e.setStencilTestEnabled(!0),"function"!=typeof m&&e.setStencilFunctionSeparate(x.LR.FRONT_AND_BACK,c,m,u),e.setStencilOpSeparate(x.LR.FRONT_AND_BACK,h.fail,h.zFail,h.zPass)}else e.setStencilTestEnabled(!1);if(o){const{mask:c}=o;e.setStencilWriteMask(c)}else e.setStencilWriteMask(0)}else e.setStencilTestEnabled(!1),e.setStencilWriteMask(0)}setStencilRef(e,i){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{stencil:s}=this._currentPipelineState;if(s){const{test:a}=s;if(a){const{compare:l,mask:o,ref:c}=a;if("function"==typeof c){const u=i.getStencilReference();if(null===u)throw new Error("InternalError: Stencil reference expected for target but not defined");e.setStencilFunctionSeparate(x.LR.FRONT_AND_BACK,l,u,o)}}}}}function Nt(f,e,i,s){return f!==ie.jx.LABEL_ALPHA&&f!==ie.jx.LABEL&&f!==ie.jx.HIGHLIGHT&&(1!==s||null!=e&&"normal"!==e||null!=i&&i.length>0)}var ni=y(34406),oi=y(7081);class li{constructor(){this._candidateTiles=[]}schedule(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}reshuffle(e){const i=[];for(const s of this._candidateTiles)e>0?(s.reshuffle(),e--):i.push(s);this._candidateTiles=i}}var Vt=y(34317),ci=y(75188),hi=y(76363),ui=y(82871),di=y(40631),fi=y(26517);class mi extends he.W{constructor(e,i){super(),this.meshWriterRegistry=new ci.a,this._trash=new Set,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this._renderRequested=(0,ue.t)(!1),this.stage=this,this._stationary=!0,this._reshuffleManager=new li,this._canvas=new Be(e),this.context=new di.x(this._canvas.gl,i.contextOptions??{}),this.painter=new ai(this.context,this),this._cimAnalyzer=new N(this.painter.textureManager.resourceManager),(0,ce.Z)("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(this._debugOutput));const s=()=>this._highlightGradient;this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:i.timeline||new hi.T,renderingOptions:i.renderingOptions,requestRender:()=>this.requestRender(),allowDelayedRender:!1,requireFBO:!1,profiler:new oi.Q(this.context,this._debugOutput),dataUploadCounter:0,get highlightGradient(){return s()},reshuffleManager:this._reshuffleManager,backgroundColor:i.backgroundColor},this._taskHandle=(0,Oe.A)({render:a=>this.renderFrame(a)}),this._taskHandle.pause(),this._lostWebGLContextHandle=this._canvas.events.on("webgl-context-lost",a=>this.emit("webgl-error",{error:new _e.Z("webgl-context-lost",a.statusMessage)})),this._bufferPool=new ni.o,(0,Vt.W4)()}destroy(){(0,Vt.IG)(this.context),this.removeAllChildren(),this._emptyTrash(),this._taskHandle=(0,W.hw)(this._taskHandle),this._lostWebGLContextHandle=(0,W.hw)(this._lostWebGLContextHandle),this._canvas.destroy(),this._debugOutput?.parentNode?.removeChild(this._debugOutput),this._bufferPool.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get textureManager(){return this.painter.textureManager}get backgroundColor(){return this._renderParameters.backgroundColor}set backgroundColor(e){this._renderParameters.backgroundColor=e,this.requestRender()}get bufferPool(){return this._bufferPool}get cimAnalyzer(){return this._cimAnalyzer}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get renderRequested(){return this._renderRequested.value}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._renderRemainingTime=2e3,this.renderRequested||(this._renderRequested.value=!0,this._taskHandle.resume())}renderFrame(e){this._renderRemainingTime-=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this._renderRequested.value=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash()}_createTransforms(){return{displayViewScreenMat3:(0,Me.Ue)()}}renderChildren(e){for(const i of this.children)i.beforeRender(e);this._reshuffleManager.reshuffle(b.BZ),this._canvas.render(e,()=>this._renderChildren(this.children,e));for(const i of this.children)i.afterRender(e)}_renderChildren(e,i){const s=this.context;this.painter.textureUploadManager.upload(),s.resetInfo(),i.profiler.recordStart("drawLayers"),i.dataUploadCounter=0,this.painter.beforeRenderPhases(i,i.backgroundColor,this.state.padding),i.drawPhase=ie.jx.MAP;for(const a of e)a.processRender(i);if(this.children.some(a=>a.hasHighlight)){i.drawPhase=ie.jx.HIGHLIGHT;for(const a of e)a.processRender(i)}if(this.children.some(a=>a.hasLabels)){i.drawPhase=ie.jx.LABEL;for(const a of e)a.processRender(i)}if((0,ce.Z)("esri-tiles-debug")){i.drawPhase=ie.jx.DEBUG;for(const a of e)a.processRender(i)}this.painter.afterRenderPhases(i),i.profiler.recordEnd("drawLayers"),s.logInfo()}doRender(e){const i=this.context,{state:s,pixelRatio:a}=e;this._canvas.resize(e),i.setViewport(0,0,a*s.size[0],a*s.size[1]),i.setDepthWriteEnabled(!0),i.setStencilWriteMask(255),this.renderChildren(e)}takeScreenshot(e,i,s,a){var l=this;return(0,Q.Z)(function*(){const o=Math.round(l.state.size[0]*e.resolutionScale),c=Math.round(l.state.size[1]*e.resolutionScale),u=e.resolutionScale,h=l.context,m=l._state.clone();if(null!=a){const H=m.viewpoint;m.viewpoint.rotation=a,m.viewpoint=H}const g={...l._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:m,pixelRatio:u,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1,backgroundColor:s},w=new oe.X(o,c);w.wrapMode=x.e8.CLAMP_TO_EDGE,w.internalFormat=x.lP.RGBA8,w.isImmutable=!0;const S=new be.X(h,w,new pt.Y(x.Tg.DEPTH_STENCIL,o,c)),C=h.getBoundFramebufferObject(),O=h.getViewport();h.bindFramebuffer(S),h.setViewport(0,0,o,c),l._renderChildren(i??l.children,g);const T=l._readbackScreenshot(S,{...e.cropArea,y:c-(e.cropArea.y+e.cropArea.height)});h.bindFramebuffer(C),h.setViewport(O.x,O.y,O.width,O.height),l.requestRender();const R=yield T;let I;return 1===e.outputScale?I=R:(I=new ImageData(Math.round(R.width*e.outputScale),Math.round(R.height*e.outputScale)),(0,ui.TT)(R,I,!0)),S.dispose(),I})()}_readbackScreenshot(e,i){return(0,Q.Z)(function*(){const s=(0,fi.r7)(i.width,i.height,document.createElement("canvas"));return yield e.readPixelsAsync(i.x,i.y,i.width,i.height,x.VI.RGBA,x.Br.UNSIGNED_BYTE,new Uint8Array(s.data.buffer)),s})()}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const i of e)i.processDetach()}}}var gi=y(47403),_i=y(37348),vi=y(50800),yi=y(46266),bi=y(37636),xi=y(50433),rt=y(77675),Mi=y(6785),wi=y(90110),Si=y(64456),Gt=y(6016),Ht=y(83068);function gt(){return(gt=(0,Q.Z)(function*(f){const e=y.e(7176).then(y.bind(y,27176)),i=y.e(2850).then(y.bind(y,42850)),s=(0,Ht.t)((yield e).default,{signal:f}),a=(0,Ht.t)((yield i).default,{signal:f}),l={mask:yield s,overlay:yield a};return(0,Se.k_)(f),l})).apply(this,arguments)}class Pi extends Si.s{constructor(){super(),this._handles=new xi.Z,this._resourcePixelRatio=1,this.updatingHandles=new wi.R,this.visible=!1}destroy(){this._handles=(0,W.SC)(this._handles),this._disposeRenderResources(),this._resourcesTask=(0,W.IM)(this._resourcesTask)}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){this._backgroundColor=e,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,rt.YP)(()=>e.version,()=>{this.visible=e.visible&&null!=e.position&&e.size>0,this.requestRender()},rt.nn),(0,rt.YP)(()=>[e.maskUrl,e.overlayUrl],()=>this._reloadResources()),(0,rt.YP)(()=>e.size,()=>{this._disposeRenderResources(),this.requestRender()})])}_createTransforms(){return{displayViewScreenMat3:(0,Me.Ue)()}}doRender(e){const i=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==ie.jx.MAP||!this._canRender())return;this._updateResources(e);const s=this._magnifier;if(null==s.position)return;const a=e.pixelRatio,l=s.size*a,c=Math.ceil(1/s.factor*l);this._readbackTexture.resize(c,c);const{size:u}=e.state,h=a*u[0],m=a*u[1],g=.5*c,w=.5*c,S=(0,ae.uZ)(a*s.position.x,g,h-g-1),C=(0,ae.uZ)(m-a*s.position.y,w,m-w-1);i.setBlendingEnabled(!0);const O=S-g,T=C-w,R=this._readbackTexture;i.bindTexture(R,0),i.gl.copyTexImage2D(R.descriptor.target,0,R.descriptor.pixelFormat,O,T,c,c,0);const I=this.backgroundColor,H=I?[I.a*I.r/255,I.a*I.g/255,I.a*I.b/255,I.a]:[1,1,1,1],G=(S+s.offset.x*a)/h*2-1,X=(C-s.offset.y*a)/m*2-1,V=l/h*2,se=l/m*2,ee=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.useProgram(ee),ee.setUniform4fv("u_background",H),ee.setUniform1i("u_readbackTexture",0),ee.setUniform1i("u_overlayTexture",6),ee.setUniform1i("u_maskTexture",7),ee.setUniform4f("u_drawPos",G,X,V,se),ee.setUniform1i("u_maskEnabled",s.maskEnabled?1:0),ee.setUniform1i("u_overlayEnabled",s.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(x.MX.TRIANGLE_STRIP,0,4),i.bindVAO()}_canRender(){return this._mask&&this._overlay&&null!=this._magnifier}_reloadResources(){var e=this;this._resourcesTask&&this._resourcesTask.abort();const i=null!=this._magnifier?this._magnifier.maskUrl:null,s=null!=this._magnifier?this._magnifier.overlayUrl:null;this._resourcesTask=(0,bi.vr)(function(){var a=(0,Q.Z)(function*(l){const o=null==i||null==s?function Oi(f){return gt.apply(this,arguments)}(l):null,c=null!=i?(0,We.Z)(i,{responseType:"image",signal:l}).then(g=>g.data):o.then(g=>g.mask),u=null!=s?(0,We.Z)(s,{responseType:"image",signal:l}).then(g=>g.data):o.then(g=>g.overlay),[h,m]=yield Promise.all([c,u]);e._mask=h,e._overlay=m,e._disposeRenderResources(),e.requestRender()});return function(l){return a.apply(this,arguments)}}()),this.updatingHandles.addPromise(this._resourcesTask.promise)}_disposeRenderResources(){this._readbackTexture=(0,W.M2)(this._readbackTexture),this._overlayTexture=(0,W.M2)(this._overlayTexture),this._maskTexture=(0,W.M2)(this._maskTexture),this._vertexArrayObject=(0,W.M2)(this._vertexArrayObject),this._program=(0,W.M2)(this._program)}_updateResources(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const i=e.context;this._resourcePixelRatio=e.pixelRatio;const s=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=(0,Gt.F)(i);const a=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new lt.U(i,Gt.c.attributes,xt.cD,{geometry:ot.f.createVertex(i,x.l1.STATIC_DRAW,a)}),this._overlay.width=s,this._overlay.height=s;const o=new oe.X;o.internalFormat=x.VI.RGBA,o.wrapMode=x.e8.CLAMP_TO_EDGE,o.samplingMode=x.cw.NEAREST,o.flipped=!0,o.preMultiplyAlpha=!(0,Mi.zd)(this._overlay.src)||!e.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new Ce.x(i,o,this._overlay),this._mask.width=s,this._mask.height=s,o.pixelFormat=o.internalFormat=x.VI.ALPHA,this._maskTexture=new Ce.x(i,o,this._mask);const c=1/this._magnifier.factor;o.pixelFormat=o.internalFormat=x.VI.RGBA,o.width=o.height=Math.ceil(c*s),o.samplingMode=x.cw.LINEAR,o.flipped=!1,this._readbackTexture=new Ce.x(i,o)}}}}]);