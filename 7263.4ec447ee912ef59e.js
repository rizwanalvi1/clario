"use strict";(self.webpackChunkclario_frontend=self.webpackChunkclario_frontend||[]).push([[7263],{37263:(Z,E,y)=>{y.r(E),y.d(E,{default:()=>U});var V=y(50484),F=y(66476),P=y(73514),D=y(4703),p=y(79412),C=y(77675),j=y(66679),x=y(80543),A=(y(14007),y(65311),y(10141)),v=y(80773),W=y(93414);class J extends W.q{constructor(i){super("Lyr3DWorker","process",{process:o=>o.inputs},i,{hasInitialize:!0})}destroyWasm(){return this.broadcast({},"destroyWasm")}}var g,h,t,I=y(51554),T=y(43688);(t=g||(g={}))[t.Lifetime=0]="Lifetime",t[t.Jobs=1]="Jobs",t[t.Renderables=2]="Renderables",function(t){t[t.Critical=0]="Critical",t[t.Error=1]="Error",t[t.Warning=2]="Warning",t[t.Info=3]="Info"}(h||(h={}));let M=class extends P.Z{constructor(t){super(t),this._lyr3DMainPromise=null,this._lyr3DMain=null,this._layers=new Map,this._debugFlags=new Set,this._debugLevel=h.Critical,this._wasmNotLoaded="method requiring WASM was called when WASM isn't loaded",this._pulseTaskHandle=null,this._session=null,this._debugFlags.add(g.Lifetime),this._debugFlags.add(g.Jobs),this._debugFlags.add(g.Renderables)}_debugLog(t,i,o,l=!0){if(this._debugFlags.has(t)&&this._debugLevel>=i){const d=l?`[js] ${o}`:`${o}`;i===h.Critical||i===h.Error?D.Z.getLogger(this).error(d):i===h.Warning&&D.Z.getLogger(this).warn(d),D.Z.getLogger(this).info(d)}}initialize(){this._debugLevel>h.Warning&&(D.Z.getLogger(this).level="info"),this._debugLog(g.Lifetime,h.Info,"Lyr3DWasmPerSceneView.initialize()"),this.addHandles([(0,C.YP)(()=>this.view.state?.contentCamera,()=>this._updateWasmCamera())]),this._pulseTaskHandle=(0,j.A)({preRender:()=>this._pulseTask()})}destroy(){this._debugLog(g.Lifetime,h.Info,"Lyr3DWasmPerSceneView.destroy()"),this._lyr3DMain&&(this._layers.forEach(i=>{i.abortController.abort()}),this._lyr3DMain.uninitialize_lyr3d_wasm(),this._lyr3DMain=null);const t=this._worker;t&&t.destroyWasm().then(()=>{this._worker?.destroy(),this._worker=null}),this._pulseTaskHandle?.remove(),this._pulseTaskHandle=null}add3DTilesLayerView(t){return this._lyr3DMain?this._add3DTilesLayerView(t):(this._debugLog(g.Lifetime,h.Error,"Lyr3DWasmPerSceneView.add3DTilesLayerView() called when WASM wasn't initialized"),v.Em)}remove3DTilesLayerView(t){if(!this._lyr3DMain)return this._debugLog(g.Lifetime,h.Error,this._wasmNotLoaded),0;this._doRemoveLayerView(t);const i=this._layers.size;return 0===i&&(this._debugLog(g.Lifetime,h.Info,"Lyr3DWasmPerSceneView.remove3DTilesLayerView() no Lyr3D layers left after removing a layer, destroying"),this.destroy()),i}setEnabled(t,i){if(!this._lyr3DMain)return void this._debugLog(g.Lifetime,h.Error,this._wasmNotLoaded);const o=this._layers.get(t.wasmLayerId);o&&(this._lyr3DMain.set_enabled(t.wasmLayerId,i),o.needMemoryUsageUpdate=!0,o.needFrame=!0,o.layerView.updatingFlagChanged())}setLayerOffset(t,i){this._lyr3DMain?this._layers.get(t.wasmLayerId)&&this._lyr3DMain.set_carto_offset_z(t.wasmLayerId,i):this._debugLog(g.Lifetime,h.Error,this._wasmNotLoaded)}getAttributionText(){return this._lyr3DMain?this._lyr3DMain.get_current_attribution_text().split("|"):(this._debugLog(g.Lifetime,h.Error,this._wasmNotLoaded),[])}onRenderableEvicted(t,i,o){this._lyr3DMain?this._layers.get(t.wasmLayerId)&&this._lyr3DMain.on_renderable_evicted(t.wasmLayerId,i,o):this._debugLog(g.Lifetime,h.Error,this._wasmNotLoaded)}isUpdating(t){if(!this._lyr3DMain&&this._lyr3DMainPromise)return!0;const i=this._layers.get(t);return!!i&&(i.outstandingJobCount>0||i.outstandingRenderableCount>0||i.needFrame)}initializeWasm(){return this._lyr3DMain?Promise.resolve():(this._debugLog(g.Lifetime,h.Info,"Lyr3DWasmPerSceneView.initializeWasm()"),this._lyr3DMainPromise||(this._lyr3DMainPromise=(0,I.O)().then(t=>{this._lyr3DMain=t,this._lyr3DMainPromise=null;const i=this._lyr3DMain.addFunction(this._onNewJob.bind(this),"v"),o=this._lyr3DMain.addFunction(this._onNewRenderable.bind(this),"v"),l=this._lyr3DMain.addFunction(this._freeRenderables.bind(this),"viii"),d=this._lyr3DMain.addFunction(this._setRenderableVisibility.bind(this),"viiii"),f=this._lyr3DMain.addFunction(this._onWasmError.bind(this),"viiii"),_="global"===this.view.viewingMode,u=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1,r=this.view.heightModelInfo?.heightModel;return this._lyr3DMain.initialize_lyr3d_wasm(f,i,o,l,d,_,!r||"gravity-related-height"===r,u,this._debugLevel)?(this._worker=new J(function N(t){return i=>{if(t.immediate)return t.immediate.schedule(i);const o="No immediate scheduler";throw console.error(o),new Error(o)}}(this.view.resourceController)),this._worker.promise?this._worker.promise:void 0):(this._lyr3DMain=null,void this._debugLog(g.Lifetime,h.Critical,"Lyr3d Main WASM failed to initialize",!1))}).catch(t=>{this._debugLog(g.Lifetime,h.Critical,`Lyr3d WASM failed to download error = ${t}`,!1)})),this._lyr3DMainPromise)}_pulseTask(){if(this._lyr3DMain){let t=0,i=0;this._layers.forEach(d=>{t+=d.layerView.usedMemory,i+=d.layerView.unloadedMemory}),t/=1048576,i/=1048576;const o=this.view.resourceController.memoryController;this._lyr3DMain.frame_pulse(o.memoryFactor,t,i,o.usedMemory*o.maxMemory-t,o.maxMemory),this._layers.forEach(d=>{!0===d.needFrame&&(d.needFrame=!1,d.layerView.updatingFlagChanged())})}}_incrementJobCount(t){t.outstandingJobCount+=1,1===t.outstandingJobCount&&t.outstandingRenderableCount<1&&t.layerView.updatingFlagChanged()}_decrementJobCount(t){t.outstandingJobCount-=1,0===t.outstandingJobCount&&t.outstandingRenderableCount<1&&t.layerView.updatingFlagChanged()}_incrementRenderableCount(t){t.outstandingRenderableCount+=1,t.outstandingJobCount<1&&1===t.outstandingRenderableCount&&t.layerView.updatingFlagChanged()}_decrementRenderableCount(t){t.outstandingRenderableCount-=1,t.outstandingJobCount<1&&0===t.outstandingRenderableCount&&t.layerView.updatingFlagChanged()}_onJobFailed(t,i,o){i.error.length&&this._debugLog(g.Jobs,h.Error,i.error,!1),this._lyr3DMain&&this._lyr3DMain.on_job_failed(o.jobId,o.desc),this._decrementJobCount(t)}_onJobSucceeded(t,i,o){if(this._lyr3DMain){const l=i.data.byteLength,d=this._lyr3DMain._malloc(l);new Uint8Array(this._lyr3DMain.HEAPU8.buffer,d,l).set(i.data),this._lyr3DMain.on_job_completed(o.jobId,i.jobDescJson,d,l),this._lyr3DMain._free(d)}this._decrementJobCount(t)}_getRequestPromises(t,i,o){const l=[];for(const d of t){const f=new URL(d),_=f.searchParams.get("session");_?this._session=_:!this._session||f.origin===o.origin&&f.pathname===o.pathname||f.searchParams.append("session",this._session),l.push((0,F.Z)(f.toString(),i).then(u=>u.data))}return l}_onNewJob(){const t=this._lyr3DMain.get_next_job(),i=this._layers.get(t.layerId);if(!i)return;this._incrementJobCount(i);const o=i.abortController.signal,l={responseType:"array-buffer",signal:o,query:{...i.customParameters,token:i.apiKey}},d={inputs:[],jobDescJson:t.desc,isMissingResourceCase:!1},f=new URL(i.layerView.layer.url),_=this._getRequestPromises(t.urls,l,f);Promise.all(_).then(u=>(d.inputs=u,this._worker.invoke(d,o))).then(u=>u).catch(u=>((0,p.D_)(u)?this._debugLog(g.Jobs,h.Warning,`job ${t.jobId} was cancelled.`):this._debugLog(g.Jobs,h.Error,`job ${t.jobId} failed with error ${u}.`),{status:v.Nl.Failed,error:"",jobDescJson:"",data:new Uint8Array(0),missingInputUrls:[],inputs:[]})).then(u=>{if(u.status===v.Nl.Failed)this._onJobFailed(i,u,t);else if(u.status===v.Nl.Succeeded)this._onJobSucceeded(i,u,t);else if(u.status===v.Nl.MissingInputs){const r=this._getRequestPromises(u.missingInputUrls,l,f);Promise.all(r).then(s=>{d.jobDescJson=u.jobDescJson,d.inputs=u.originalInputs?u.originalInputs:[],d.isMissingResourceCase=!0;for(const a of s)d.inputs.push(a);return this._worker.invoke(d,o)}).then(s=>{s.status===v.Nl.Failed?this._onJobFailed(i,s,t):s.status===v.Nl.Succeeded&&this._onJobSucceeded(i,s,t)}).catch(s=>{this._decrementJobCount(i),(0,p.D_)(s)?this._debugLog(g.Jobs,h.Warning,`job ${t.jobId} was cancelled.`):this._debugLog(g.Jobs,h.Error,`job ${t.jobId} failed with error2 ${s}.`),this._lyr3DMain&&this._lyr3DMain.on_job_failed(t.jobId,t.desc)})}})}_onNewRenderable(){const t=this._lyr3DMain.get_next_renderable(),i=t.meshData;if(i.data&&i.data.byteLength>0){const l=i.data.slice();i.data=l}const o=this._layers.get(t.layerId);o&&(this._incrementRenderableCount(o),o.layerView.createRenderable(t).then(l=>{this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!0,t.layerId,t.handle,l.memUsageBytes),this._decrementRenderableCount(o)}).catch(l=>{(0,p.D_)(l)||this._debugLog(g.Renderables,h.Error,`createRenderable failed with error ${l}.`),this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!1,t.layerId,t.handle,0),this._decrementRenderableCount(o)}))}_freeRenderables(t,i,o){if(o<1)return;const l=this._layers.get(t);if(!l)return;const d=l.layerView,f=[],_=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,i,o);for(let u=0;u<o;++u)f.push(_[u]);for(let u=0;u<o;++u)d.freeRenderable(f[u])}_setRenderableVisibility(t,i,o,l){if(l<1)return;const d=this._layers.get(t);if(!d)return;const f=d.layerView,_=[],u=[],r=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,i,l),s=new Uint8Array(this._lyr3DMain.HEAPU8.buffer,o,l);for(let a=0;a<l;++a)_.push(r[a]),u.push(1===s[a]);f.setRenderableVisibility(_,u,l)}_onWasmError(t,i,o,l){this._lyr3DMain&&this._debugLog(o,l,this._lyr3DMain.UTF8ToString(t,i),!1)}_doRemoveLayerView(t){const i=this._layers.get(t.wasmLayerId);return!!i&&(i.abortController.abort(),this._lyr3DMain.remove_layer(t.wasmLayerId),this._layers.delete(t.wasmLayerId),!0)}_add3DTilesLayerView(t){const i=t.layer;if(!i.url)return v.Q3;const o=this._lyr3DMain.get_next_layer_id(),l=new AbortController;this._layers.set(o,{layerView:t,abortController:l,needMemoryUsageUpdate:!1,outstandingJobCount:0,outstandingRenderableCount:0,customParameters:i.customParameters,apiKey:i.apiKey,needFrame:!1});const d=(0,T.fm)(i.elevationInfo);return this._lyr3DMain.add_layer(i.url,o,d)?(this._updateWasmCamera(),o):(this._layers.delete(o),v.Q3)}_updateWasmCamera(){const t=this.view.state?.contentCamera;if(!t||!this._lyr3DMain)return;const{eye:i,center:o,up:l,near:d,far:f,fovY:_}=t;this._lyr3DMain.set_camera_parameters({eye:i,center:o,up:l,near:d,far:f,fov:_,aspectRatio:t.width/t.height,viewport:[t.viewport[2],t.viewport[3]]})}};(0,V._)([(0,x.Cb)({constructOnly:!0})],M.prototype,"view",void 0),M=(0,V._)([(0,A.j)("esri.layers.Lyr3DWasmPerSceneView")],M);const U=M},43688:(Z,E,y)=>{y.d(E,{LR:()=>d,Uy:()=>i,VW:()=>C,Wb:()=>o,fm:()=>f,kf:()=>l}),y(49602);var F=y(1678);function C(r,s){return function D(r,s){return s?.mode?s.mode:function P(r){return r?_:u}(r).mode}(null!=r&&r.hasZ,s)}function i(r,s,a){return a&&a.mode!==s?`${r} only support ${s} elevation mode`:null}function o(r,s,a){return a?.mode===s?`${r} do not support ${s} elevation mode`:null}function l(r,s){return null!=s?.featureExpressionInfo&&"0"!==s.featureExpressionInfo.expression?`${r} do not support featureExpressionInfo`:null}function d(r,s){s&&r.warn(".elevationInfo=",s)}function f(r){return(r?.offset??0)*(0,F.Z7)(r?.unit)}const _={mode:"absolute-height",offset:0},u={mode:"on-the-ground",offset:null}}}]);