"use strict";(self.webpackChunkclario_frontend=self.webpackChunkclario_frontend||[]).push([[1799,318],{91799:(H,L,t)=>{t.r(L),t.d(L,{default:()=>Z});var h=t(15861),_=t(50484),D=t(83944),C=t(57964),U=t(4703),v=t(8611),T=t(3233),I=t(79412),m=t(6785),E=t(19986),u=t(80543),w=(t(14007),t(65311),t(62185)),x=t(10141),c=t(7547),p=t(60301),y=t(95060),M=t(10579),g=t(2295),S=t(3660),K=t(4257),W=t(19855),b=t(27426),$=t(80099),P=t(70509),l=t(25836),o=t(29717),a=t(56956),n=t(56380),O=t(19677);let d=class extends((0,W.h7)((0,o.M)((0,l.Q)((0,K.Y)((0,$.q)((0,P.I)((0,T.R)((0,b.N)(y.Z))))))))){constructor(e){super(e),this._graphTypeLookup=new Map,this._namedTypesModified=!1,this.dataManager=null,this.definitionSetMap=null,this.knowledgeGraph=null,this.layers=new(D.Z.ofType(g.Z)),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="KnowledgeGraphLayer",this.sublayerIdsCache=new Map,this.tables=new(D.Z.ofType(g.Z)),this.type="knowledge-graph",this.url=null}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}_doLoad(e){var s=this;return(0,h.Z)(function*(){try{yield s.loadFromPortal({supportedTypes:["Knowledge Graph Layer"]},e)}catch(i){(0,I.r9)(i)}yield s._fetchMetadata(),yield s._initializeLayerProperties(),s.loadLayerAssumingLocalCache()})()}_fetchMetadata(){var e=this;return(0,h.Z)(function*(){if(!e.url)throw new C.Z("knowledge-graph:missing-url","KnowledgeGraphLayer must be created with a url");const s=yield(0,n.fetchKnowledgeGraph)(e.url);e.knowledgeGraph=s,e._forEachGraphType(i=>{i.name&&e._graphTypeLookup.set(i.name,i)})})()}_initializeLayerProperties(){var e=this;return(0,h.Z)(function*(){e.originIdOf("inclusionModeDefinition")===p.s3.USER?e._validateInclusionModeDefinition():yield e._initializeInclusionModeDefinition(),e._setMemberTypes(),e.dataManager=new M.Qc({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition})})()}_initializeInclusionModeDefinition(){var e=this;return(0,h.Z)(function*(){const s=e.definitionSetMap?yield(0,S.Ag)(e.definitionSetMap,!0):{generateAllSublayers:!0,namedTypeDefinitions:new Map};[...e.layers.toArray(),...e.tables.toArray()].forEach(i=>{const r=e._graphTypeLookup.get(i.graphTypeName);r&&!s.namedTypeDefinitions.has(r.name)&&s.namedTypeDefinitions.set(r.name,{useAllData:!0})}),e.setAtOrigin("inclusionModeDefinition",s,(0,p.x3)(e.originIdOf("definitionSetMap")))})()}_validateInclusionModeDefinition(){const{inclusionModeDefinition:e}=this;if(!e)return;const{namedTypeDefinitions:s}=e;if(s?.size>0)s.forEach((i,r)=>{const f=this._graphTypeLookup.get(r);if(!f)return U.Z.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void s.delete(r);"relationship"!==f.type&&"entity"!==f.type&&(U.Z.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't properly modeled and will be removed`),s.delete(r))});else if(!e.generateAllSublayers)throw new C.Z("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined")}_setMemberTypes(){let e=[],s=[];const{inclusionModeDefinition:i}=this,r=i?.namedTypeDefinitions;!i||i.generateAllSublayers?(e=this.knowledgeGraph.dataModel?.entityTypes??[],s=this.knowledgeGraph.dataModel?.relationshipTypes??[]):r&&r.size>0&&r.forEach((f,B)=>{const R=this._graphTypeLookup.get(B);switch(R?.type){case"relationship":s.push(R);break;case"entity":e.push(R)}}),this.memberEntityTypes=e,this.memberRelationshipTypes=s}_forEachGraphType(e){[...this.knowledgeGraph.dataModel?.entityTypes??[],...this.knowledgeGraph.dataModel?.relationshipTypes??[]].forEach(s=>{e(s)})}_refreshNamedTypes(){this._namedTypesModified=!0;for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}_handleNewRecords(e){var s=this;return(0,h.Z)(function*(){const i=[];s.dataManager.addToLayer(e);for(const r of e)s.sublayerIdsCache.has(r.typeName)||(s.sublayerIdsCache.set(r.typeName,new Set),i.push(r.typeName)),s.sublayerIdsCache.get(r.typeName).add(r.id);for(const r of i){const f=s._graphTypeLookup.get(r);f&&(s._addSublayer(f).title=r,"entity"===f.type?s.dataManager.entityTypeNames.add(r):s.dataManager.relationshipTypeNames.add(r),s.dataManager.sublayerCaches.set(r,new Map))}s._refreshNamedTypes()})()}_createSublayers(e,s,i){e.forEach(r=>{const f=this._createSublayer(r);i(f)&&s.push(f),this._updateSublayerCaches(r)})}_addSublayer(e){const s=this._createSublayer(e);return s.geometryType?this.layers.push(s):this.tables.push(s),s}_createSublayer(e){return new g.Z({objectType:e,parentCompositeLayer:this,graphType:e.type,title:e.name})}_updateSublayers(e,s){s.forEach(i=>{i.parentCompositeLayer=this;const r=e.find(f=>f.type===i.graphType&&f.name===i.graphTypeName);r&&(i.objectType=r,i.read({title:r.name},{origin:"service"}),this._updateSublayerCaches(r))})}_updateSublayerCaches(e){const s=this.dataManager.sublayerCaches;s.has(e.name)||s.set(e.name,new Map)}_saveUrlAsNewResource(e,s,i,r){e[s]="<pending>",i.pendingOperations.push(function G(e){return A.apply(this,arguments)}(this.inclusionModeDefinition).then(f=>{const B=function F(e){const s=`definitionSetMap-${(0,E.DO)()}.dat`,i=(0,m.v_)("knowledgeGraphLayer",s);return e.resourceFromPath(i)}(r);e[s]=B.itemRelativeUrl,i.toAdd.push({resource:B,content:{type:"blob",blob:f},compress:!1,finish:R=>{this.definitionSetMap=R.url}})}))}_displaysAllRecords(e){for(const[,{useAllData:s}]of e.namedTypeDefinitions)if(!s)return!1;return!0}readDefinitionSetMap(e,s,i){return(0,O.f)(e,i)}writeDefinitionSetMap(e,s,i,r){const f=r?.portalItem,B=r?.resources,R=(0,p.M9)(r?.origin);if(!f||!B||null==R)return void(e&&(s[i]=(0,O.t)(e,r)));const{inclusionModeDefinition:Y}=this;if(!Y||this._displaysAllRecords(Y))return void(this.definitionSetMap=null);const z=this.originIdOf("inclusionModeDefinition");if(z===p.s3.USER||this._namedTypesModified||R<z)this._saveUrlAsNewResource(s,i,B,f);else if(R===z&&e){const J=(0,O.t)(e,r);(0,m.YP)(J)?this._saveUrlAsNewResource(s,i,B,f):s[i]=J}}set inclusionModeDefinition(e){"loaded"!==this.loadStatus&&"failed"!==this.loadStatus?this._set("inclusionModeDefinition",e):U.Z.getLogger(this).error("#inclusionModeDefinition","inclusionModeDefinition cannot be changed after the layer is loaded.")}loadLayerAssumingLocalCache(){const e=[...this.memberEntityTypes,...this.memberRelationshipTypes];this.originIdOf("layers")===p.s3.DEFAULTS?this._createSublayers(e,this.layers,s=>!!s.geometryType):this._updateSublayers(e,this.layers),this.originIdOf("tables")===p.s3.DEFAULTS?this._createSublayers(e,this.tables,s=>!s.geometryType):this._updateSublayers(e,this.tables),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((s,i)=>{const r=(0,v.s1)(this.sublayerIdsCache,i,()=>new Set);s.members?.forEach(f=>{r.add(f.id)})})}addRecords(e){var s=this;return(0,h.Z)(function*(){yield s._handleNewRecords(e)})()}removeRecords(e){var s=this;return(0,h.Z)(function*(){const i=[];for(const r of e)!1===s.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(r.typeName)?.useAllData&&s.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(r.typeName)?.members?.has(r.id)&&i.push(r);s.dataManager.removeFromLayer(i);for(const r of i)s.sublayerIdsCache.get(r.typeName)?.delete(r.id);return s._refreshNamedTypes(),i})()}};(0,_._)([(0,u.Cb)()],d.prototype,"dataManager",void 0),(0,_._)([(0,u.Cb)({json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],d.prototype,"definitionSetMap",void 0),(0,_._)([(0,w.r)("definitionSetMap")],d.prototype,"readDefinitionSetMap",null),(0,_._)([(0,c.c)("definitionSetMap")],d.prototype,"writeDefinitionSetMap",null),(0,_._)([(0,u.Cb)()],d.prototype,"inclusionModeDefinition",null),(0,_._)([(0,u.Cb)()],d.prototype,"knowledgeGraph",void 0),(0,_._)([(0,u.Cb)({type:D.Z.ofType(g.Z),json:{write:{ignoreOrigin:!0}}})],d.prototype,"layers",void 0),(0,_._)([(0,u.Cb)()],d.prototype,"memberEntityTypes",void 0),(0,_._)([(0,u.Cb)()],d.prototype,"memberRelationshipTypes",void 0),(0,_._)([(0,u.Cb)({type:["KnowledgeGraphLayer"]})],d.prototype,"operationalLayerType",void 0),(0,_._)([(0,u.Cb)()],d.prototype,"sublayerIdsCache",void 0),(0,_._)([(0,u.Cb)({type:D.Z.ofType(g.Z),json:{write:{ignoreOrigin:!0}}})],d.prototype,"tables",void 0),(0,_._)([(0,u.Cb)({json:{read:!1}})],d.prototype,"type",void 0),(0,_._)([(0,u.Cb)(a.HQ)],d.prototype,"url",void 0),d=(0,_._)([(0,x.j)("esri.layers.KnowledgeGraphLayer")],d);const Z=d;function A(){return(A=(0,h.Z)(function*(e){const s=yield(0,S.jR)(e);return new Blob([s],{type:"application/x-protobuf"})})).apply(this,arguments)}},4257:(H,L,t)=>{t.d(L,{Y:()=>I});var h=t(50484),_=t(4703),D=t(80543),v=(t(14007),t(65311),t(10141)),T=t(89713);const I=m=>{let E=class extends m{get title(){if(this._get("title")&&"defaults"!==this.originOf("title"))return this._get("title");if(this.url){const u=(0,T.Qc)(this.url);if(null!=u&&u.title)return u.title}return this._get("title")||""}set title(u){this._set("title",u)}set url(u){this._set("url",(0,T.Nm)(u,_.Z.getLogger(this)))}};return(0,h._)([(0,D.Cb)()],E.prototype,"title",null),(0,h._)([(0,D.Cb)({type:String})],E.prototype,"url",null),E=(0,h._)([(0,v.j)("esri.layers.mixins.ArcGISService")],E),E}},27426:(H,L,t)=>{t.d(L,{N:()=>T});var h=t(50484),_=t(80543),v=(t(14007),t(4703),t(65311),t(10141));const T=I=>{let m=class extends I{constructor(){super(...arguments),this.customParameters=null}};return(0,h._)([(0,_.Cb)({type:Object,json:{write:{overridePolicy:E=>({enabled:!!(E&&Object.keys(E).length>0)})}}})],m.prototype,"customParameters",void 0),m=(0,h._)([(0,v.j)("esri.layers.mixins.CustomParametersMixin")],m),m}},70509:(H,L,t)=>{t.d(L,{I:()=>W});var h=t(15861),_=t(50484),D=t(11931),C=t(26152),U=t(66476),v=t(37636),T=t(57964),I=t(4703),m=t(51172),E=t(79412),u=t(6785),j=t(80543),x=(t(14007),t(65311),t(62185)),c=t(10141),p=t(7547),y=t(85971),M=t(61018),g=t(27835),S=t(57437),K=t(50318);const W=$=>{let P=class extends ${constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1}destroy(){this.portalItem=(0,m.SC)(this.portalItem),this.resourceReferences.portalItem=null,this.resourceReferences.paths.length=0}set portalItem(l){l!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",l))}readPortalItem(l,o,a){if(o.itemId)return new g.default({id:o.itemId,portal:a?.portal})}writePortalItem(l,o){l?.id&&(o.itemId=l.id)}loadFromPortal(l,o){var a=this;return(0,h.Z)(function*(){if(a.portalItem?.id)try{const{load:n}=yield Promise.all([t.e(2772),t.e(8592),t.e(6964)]).then(t.bind(t,36964));return(0,E.k_)(o),yield n({instance:a,supportedTypes:l.supportedTypes,validateItem:l.validateItem,supportsData:l.supportsData,layerModuleTypeMap:l.layerModuleTypeMap},o)}catch(n){throw(0,E.D_)(n)||I.Z.getLogger(a).warn(`Failed to load layer (${a.title}, ${a.id}) portal item (${a.portalItem.id})\n  ${n}`),n}})()}finishLoadEditablePortalLayer(l){var o=this;return(0,h.Z)(function*(){o._set("userHasEditingPrivileges",yield o._fetchUserHasEditingPrivileges(l).catch(a=>((0,E.r9)(a),!0)))})()}setUserPrivileges(l,o){var a=this;return(0,h.Z)(function*(){if(!D.default.userPrivilegesApplied)return a.finishLoadEditablePortalLayer(o);if(a.url)try{const{features:{edit:n,fullEdit:O},content:{updateItem:d}}=yield a._fetchUserPrivileges(l,o);a._set("userHasEditingPrivileges",n),a._set("userHasFullEditingPrivileges",O),a._set("userHasUpdateItemPrivileges",d)}catch(n){(0,E.r9)(n)}})()}_fetchUserPrivileges(l,o){var a=this;return(0,h.Z)(function*(){let n=a.portalItem;if(!l||!n||!n.loaded||n.sourceUrl)return a._fetchFallbackUserPrivileges(o);const O=l===n.id;if(O&&n.portal.user)return(0,K.Ss)(n);let d,Z;if(O)d=n.portal.url;else try{d=yield(0,y.oP)(a.url,o)}catch(e){(0,E.r9)(e)}if(!d||!(0,u.Zo)(d,n.portal.url))return a._fetchFallbackUserPrivileges(o);try{const e=null!=o?o.signal:null;Z=yield C.id?.getCredential(`${d}/sharing`,{prompt:!1,signal:e})}catch(e){(0,E.r9)(e)}if(!Z)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};try{if(O?yield n.reload():(n=new g.default({id:l,portal:{url:d}}),yield n.load(o)),n.portal.user)return(0,K.Ss)(n)}catch(e){(0,E.r9)(e)}return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}}})()}_fetchFallbackUserPrivileges(l){var o=this;return(0,h.Z)(function*(){let a=!0;try{a=yield o._fetchUserHasEditingPrivileges(l)}catch(n){(0,E.r9)(n)}return{features:{edit:a,fullEdit:!1},content:{updateItem:!1}}})()}_fetchUserHasEditingPrivileges(l){var o=this;return(0,h.Z)(function*(){const a=o.url?C.id?.findCredential(o.url):null;if(!a)return!0;const n=b.credential===a?b.user:yield o._fetchEditingUser(l);return b.credential=a,b.user=n,null==n?.privileges||n.privileges.includes("features:user:edit")})()}_fetchEditingUser(l){var o=this;return(0,h.Z)(function*(){const a=o.portalItem?.portal?.user;if(a)return a;const n=C.id?.findServerInfo(o.url??"");if(!n?.owningSystemUrl)return null;const O=`${n.owningSystemUrl}/sharing/rest`,d=M.Z.getDefault();if(d&&d.loaded&&(0,u.Fv)(d.restUrl)===(0,u.Fv)(O))return d.user;const Z=`${O}/community/self`,G=null!=l?l.signal:null,A=yield(0,v.q6)((0,U.Z)(Z,{authMode:"no-prompt",query:{f:"json"},signal:G}));return A.ok?S.Z.fromJSON(A.value.data):null})()}read(l,o){o&&(o.layer=this),super.read(l,o)}write(l,o){const a=o?.portal,n=this.portalItem?.id&&(this.portalItem.portal||M.Z.getDefault());return a&&n&&!(0,u.tm)(n.restUrl,a.restUrl)?(o.messages&&o.messages.push(new T.Z("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):super.write(l,{...o,layer:this})}};return(0,_._)([(0,j.Cb)({type:g.default})],P.prototype,"portalItem",null),(0,_._)([(0,x.r)("web-document","portalItem",["itemId"])],P.prototype,"readPortalItem",null),(0,_._)([(0,p.c)("web-document","portalItem",{itemId:{type:String}})],P.prototype,"writePortalItem",null),(0,_._)([(0,j.Cb)({clonable:!1})],P.prototype,"resourceReferences",void 0),(0,_._)([(0,j.Cb)({type:Boolean,readOnly:!0})],P.prototype,"userHasEditingPrivileges",void 0),(0,_._)([(0,j.Cb)({type:Boolean,readOnly:!0})],P.prototype,"userHasFullEditingPrivileges",void 0),(0,_._)([(0,j.Cb)({type:Boolean,readOnly:!0})],P.prototype,"userHasUpdateItemPrivileges",void 0),P=(0,_._)([(0,c.j)("esri.layers.mixins.PortalLayer")],P),P},b={credential:null,user:null}},50318:(H,L,t)=>{t.d(L,{$o:()=>j,Fj:()=>m,IW:()=>u,Ss:()=>x,_$:()=>I,ck:()=>E,hz:()=>w,qj:()=>T});var h=t(15861),_=t(83821),D=t(43814),C=t(48230);function v(){return(v=(0,h.Z)(function*(c){const p=c.spatialReference;if(p.isWGS84)return c.clone();if(p.isWebMercator)return(0,C.Sx)(c);const y=D.Z.WGS84;return yield(0,_.initializeProjection)(p,y),(0,_.project)(c,y)})).apply(this,arguments)}function T(c,p){if(!I(c,p)){const y=c.typeKeywords;y?y.push(p):c.typeKeywords=[p]}}function I(c,p){return!!c.typeKeywords?.includes(p)}function m(c){return I(c,w.HOSTED_SERVICE)}function E(c,p){const y=c.typeKeywords;if(y){const M=y.indexOf(p);M>-1&&y.splice(M,1)}}function u(c,p,y){y?T(c,p):E(c,p)}function j(c){return N.apply(this,arguments)}function N(){return N=(0,h.Z)(function*(c){const p=c.clone().normalize();let y;if(p.length>1)for(const M of p)y?M.width>y.width&&(y=M):y=M;else y=p[0];return function U(c){return v.apply(this,arguments)}(y)}),N.apply(this,arguments)}const w={DEVELOPER_BASEMAP:"DeveloperBasemap",JSAPI:"ArcGIS API for JavaScript",METADATA:"Metadata",MULTI_LAYER:"Multilayer",SINGLE_LAYER:"Singlelayer",TABLE:"Table",HOSTED_SERVICE:"Hosted Service",LOCAL_SCENE:"ViewingMode-Local",TILED_IMAGERY:"Tiled Imagery",GROUP_LAYER_MAP:"Map"};function x(c){const{portal:p,isOrgItem:y,itemControl:M}=c,g=p.user?.privileges;let S=!g||g.includes("features:user:edit"),K=!!y&&!!g?.includes("features:user:fullEdit");const W="update"===M||"admin"===M;return W?K=S=!0:K&&(S=!0),{features:{edit:S,fullEdit:K},content:{updateItem:W}}}}}]);